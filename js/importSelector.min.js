/*! pedigree-editor-tool - v1.3.0 - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var ImportSelector=Class.create({initialize:function(){if(!editor.isReadOnlyMode()){var _this=this,mainDiv=new Element("div",{class:"import-selector"}),promptImport=new Element("div",{class:"import-section"}).update("Import data:");if(this.importValue=new Element("textarea",{id:"import",value:"",class:"import-textarea"}),mainDiv.insert(promptImport).insert(this.importValue),window.FileReader&&window.FileList){var uploadFileSelector=new Element("input",{type:"file",id:"pedigreeInputFile",style:"display:none"});uploadFileSelector.observe("change",function(event){_this.handleFileUpload(this.files);try{this.value=""}catch(err){}});var uploadButton=new Element("input",{type:"button",value:"Select a local file to be imported",class:"button"}).wrap("span",{class:"buttonwrapper"});uploadButton.observe("click",function(event){document.getElementById("pedigreeInputFile").click()}),mainDiv.insert(uploadFileSelector).insert(uploadButton)}var typeListElement=new Element("table");typeListElement.insert(function(checked,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:"select-type"});input.observe("click",_this.disableEnableOptions),checked&&(input.checked=!0);var label=new Element("label",{class:"import-type-label"}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper}(!0,"Simple JSON","simpleJSON"));var promptType=new Element("div",{class:"import-section"}).update("Data format:"),dataSection2=new Element("div",{class:"import-block"});dataSection2.insert(promptType).insert(typeListElement),mainDiv.insert(dataSection2);var _addConfigOption=function(checked,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:"select-options"});checked&&(input.checked=!0);var label=new Element("label",{class:"import-config-label"}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper},configListElement=new Element("table",{id:"import-type"});configListElement.insert(_addConfigOption(!0,"Treat non-standard phenotype values as new disorders","accept")),configListElement.insert(_addConfigOption(!1,'Treat non-standard phenotype values as "no information"',"dontaccept"));var markEvaluated=new Element("input",{type:"checkbox",value:"1",name:"mark-evaluated"}),markLabel1=new Element("label",{class:"import-mark-label1"}).insert(markEvaluated).insert("Mark all patients with known disorder status with 'documented evaluation' mark").wrap("td").wrap("tr");configListElement.insert(markLabel1);var markExternal=new Element("input",{type:"checkbox",value:"1",name:"mark-external"});markExternal.checked=!0;var markLabel2=new Element("label",{class:"import-mark-label2"}).insert(markExternal).insert("Save individual IDs as given in the input data as 'external ID'").wrap("td").wrap("tr");configListElement.insert(markLabel2);var dataSection3=new Element("div",{class:"import-block"});mainDiv.insert(dataSection3);var buttons=new Element("div",{class:"buttons import-block-bottom"});buttons.insert(new Element("input",{type:"button",name:"import",value:"Import",class:"button",id:"import_button"}).wrap("span",{class:"buttonwrapper"})),buttons.insert(new Element("input",{type:"button",name:"cancel",value:"Cancel",class:"button secondary"}).wrap("span",{class:"buttonwrapper"})),mainDiv.insert(buttons),buttons.down('input[name="cancel"]').observe("click",function(event){_this.hide()}),buttons.down('input[name="import"]').observe("click",function(event){_this._onImportStarted()});var closeShortcut=["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(mainDiv,{close:{method:this.hide.bind(this),keys:closeShortcut}},{extraClassName:"pedigree-import-chooser",title:"Pedigree import",displayCloseButton:!0})}},handleFileUpload:function(files){for(var i=0,numFiles=files.length;i<numFiles;i++){var nextFile=files[i];console.log("loading file: "+nextFile.name+", size: "+nextFile.size);var _this=this,fr=new FileReader;fr.onload=function(e){_this.importValue.value=e.target.result},fr.readAsText(nextFile)}},disableEnableOptions:function(){for(var importType=$$('input:checked[type=radio][name="select-type"]')[0].value,pedOnlyOptions=$$('input[type=radio][name="select-options"]'),i=0;i<pedOnlyOptions.length;i++)pedOnlyOptions[i].disabled="ped"!=importType;var pedAndGedcomOption=$$('input[type=checkbox][name="mark-evaluated"]')[0];pedAndGedcomOption.disabled="ped"!=importType&&"gedcom"!=importType;var saveExternalID=$$('input[type=checkbox][name="mark-external"]')[0];saveExternalID.disabled="simpleJSON"==importType},_onImportStarted:function(){var importValue=this.importValue.value;if(console.log("Importing:\n"+importValue),this.hide(),!importValue||""==importValue)return void alert("Nothing to import!");var importType=$$('input:checked[type=radio][name="select-type"]')[0].value;console.log("Import type: "+importType);var importOptions={markEvaluated:[],externalIdMark:[],acceptUnknownPhenotypes:[]};editor.getSaveLoadEngine().createGraphFromImportData(importValue,importType,importOptions,!1,!0)},show:function(){this.dialog.show()},hide:function(){this.importValue.value="",this.dialog.closeDialog()}});