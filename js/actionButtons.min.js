/*! pedigree-editor-tool - v1.3.1 - 2017-05-22
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var XWiki=function(d){function b(){return new c.EditActions,$("body").hasClassName("previewbody")||new c.AjaxSaveAndContinue,!0}function a(){if("undefined"!=typeof Wysiwyg){var h=Wysiwyg.getInstances();for(var f in h){var g=h[f],e=g.getPlainTextArea();e&&!e.disabled?$(f).value=e.value:g.getCommandManager().execute("submit")}}}var c=d.actionButtons=d.actionButtons||{};return c.EditActions=Class.create({initialize:function(){this.addListeners(),this.addShortcuts(),this.addValidators()},addListeners:function(){$$("input[name=action_cancel]").each(function(e){e.observe("click",this.onCancel.bindAsEventListener(this))}.bind(this)),$$("input[name=action_preview]").each(function(e){e.observe("click",this.onPreview.bindAsEventListener(this))}.bind(this)),$$("input[name=action_save]").each(function(e){e.observe("click",this.onSaveAndView.bindAsEventListener(this))}.bind(this)),$$("input[name=action_saveandcontinue]").each(function(e){e.observe("click",this.onSaveAndContinue.bindAsEventListener(this))}.bind(this))},addShortcuts:function(){var e={action_cancel:"$services.localization.render('core.shortcuts.edit.cancel')",action_preview:"$services.localization.render('core.shortcuts.edit.preview')",action_edit:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_inline:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_save:"$services.localization.render('core.shortcuts.edit.saveandview')",action_propupdate:"$services.localization.render('core.shortcuts.edit.saveandview')",action_saveandcontinue:"$services.localization.render('core.shortcuts.edit.saveandcontinue')"};for(var f in e){var g=$$("input[name="+f+"]");g.size()>0&&shortcut.add(e[f],function(){this.click()}.bind(g.first()),{propagate:!1})}},validators:new Array,addValidators:function(){for(var e=$("body").select("input.required"),h=0;h<e.length;h++){var f=e[h],g=new LiveValidation(f,{validMessage:""});g.add(Validate.Presence,{failureMessage:"$services.localization.render('core.validation.required.message')"}),g.validate(),this.validators.push(g)}},validateForm:function(g){for(var f=0;f<this.validators.length;f++)if(!this.validators[f].validate())return!1;var h=g.comment;if(h&&($xwiki.isEditCommentSuggested()||$xwiki.isEditCommentMandatory()))for(;""==h.value;){var e=prompt("$services.localization.render('core.comment.prompt')","");if(null===e)return!1;if(h.value=e,!$xwiki.isEditCommentMandatory())break}return!0},onCancel:function(g){g.stop(),this.notify(g,"cancel");var f=g.element().form.action;"string"!=typeof f&&(f=(f=g.element().form.attributes.getNamedItem("action"))?f.nodeValue:window.self.location.href);var i=f.split("#",2),k=2==i.length?i[1]:"";-1==(f=i[0]).indexOf("?")&&(f+="?");var h=g.element().form.elements.xredirect,e=h?"&xredirect="+escape(h.value):"";d.EditLock&&d.EditLock.setLocked(!1),window.location=f+"&action_cancel=true"+e+k},onPreview:function(e){this.validateForm(e.element().form)?this.notify(e,"preview"):e.stop()},onSaveAndView:function(e){this.validateForm(e.element().form)?this.notify(e,"save",{continue:!1}):e.stop()},onSaveAndContinue:function(e){this.validateForm(e.element().form)?this.notify(e,"save",{continue:!0}):e.stop()},notify:function(e,f,g){document.fire("xwiki:actions:"+f,Object.extend({originalEvent:e,form:e.element().form},g||{})),e.stopped&&e.stop()}}),c.AjaxSaveAndContinue=Class.create({initialize:function(){this.createMessages(),this.addListeners()},createMessages:function(){this.savingBox=new d.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.inprogress'))","inprogress",{inactive:!0}),this.savedBox=new d.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.done'))","done",{inactive:!0}),this.failedBox=new d.widgets.Notification('$escapetool.javascript($services.localization.render("core.editors.saveandcontinue.notification.error", ["<span id=""ajaxRequestFailureReason""/>"]))',"error",{inactive:!0})},addListeners:function(){document.observe("xwiki:actions:save",this.onSave.bindAsEventListener(this))},onSave:function(e){if(!e.stopped&&e.memo.continue){void 0!==e.memo.originalEvent&&e.memo.originalEvent.stop(),this.form=$(e.memo.form),this.savedBox.hide(),this.failedBox.hide(),this.savingBox.show();var f=new Hash(this.form.serialize({hash:!0,submit:"action_saveandcontinue"}));f.set("minorEdit","1"),Prototype.Browser.Opera||f.set("ajax","true"),new Ajax.Request(this.form.action,{method:"post",parameters:f.toQueryString(),onSuccess:this.onSuccess.bindAsEventListener(this),on1223:this.on1223.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bind(this)})}},on1223:function(e){e.request.options.onSuccess(e)},on0:function(e){e.request.options.onFailure(e)},onSuccess:function(e){this.form&&this.form.template&&(this.form.template.disabled=!0,this.form.template.value=""),this.savingBox.replace(this.savedBox),document.fire("xwiki:document:saved")},onFailure:function(e){this.savingBox.replace(this.failedBox),""==e.statusText||12031==e.status?$("ajaxRequestFailureReason").update("Server not responding"):e.getHeader("Content-Type").match(/^\s*text\/plain/)?$("ajaxRequestFailureReason").update(e.responseText):$("ajaxRequestFailureReason").update(e.statusText),document.fire("xwiki:document:saveFailed",{response:e})}}),d.domIsLoaded&&b()||document.observe("xwiki:dom:loaded",b),document.observe("xwiki:actions:save",a),document.observe("xwiki:actions:preview",a),d}(XWiki||{});