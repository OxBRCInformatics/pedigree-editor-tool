/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var ExportSelector=Class.create({initialize:function(){var _this=this,mainDiv=new Element("div",{class:"import-selector"}),typeListElement=new Element("table");typeListElement.insert(function(checked,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:"export-type"});input.observe("click",_this.disableEnableOptions),checked&&(input.checked=!0);var label=new Element("label",{class:"import-type-label"}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper}(!0,"Simple JSON","simpleJSON"));var fileDownload=new Element("a",{id:"downloadLink",style:"display:none"});mainDiv.insert(fileDownload);var promptType=new Element("div",{class:"import-section"}).update("Data format:"),dataSection2=new Element("div",{class:"import-block"});dataSection2.insert(promptType).insert(typeListElement),mainDiv.insert(dataSection2);var _addConfigOption=function(checked,name,cssClass,labelText,value){var optionWrapper=new Element("tr"),input=new Element("input",{type:"radio",value:value,name:name});checked&&(input.checked=!0);var label=new Element("label",{class:cssClass}).insert(input).insert(labelText);return optionWrapper.insert(label.wrap("td")),optionWrapper},configListElementJSON=new Element("table",{id:"jsonOptions",style:"display:none"});configListElementJSON.insert(_addConfigOption(!0,"export-options","import-config-label","All data","all")),configListElementJSON.insert(_addConfigOption(!1,"export-options","import-config-label","Remove personal information (name and age)","nopersonal")),configListElementJSON.insert(_addConfigOption(!1,"export-options","import-config-label","Remove personal information and free-form comments","minimal"));var configListElementPED=new Element("table",{id:"pedOptions"}),label=new Element("label",{class:"export-config-header"}).insert("How should person IDs be assigned in the generated file?");configListElementPED.insert(label.wrap("td").wrap("tr")),configListElementPED.insert(_addConfigOption(!0,"ped-options","export-subconfig-label","Using External IDs (when available)","external")),configListElementPED.insert(_addConfigOption(!1,"ped-options","export-subconfig-label","Generate new numeric IDs","newid")),configListElementPED.insert(_addConfigOption(!1,"ped-options","export-subconfig-label","Using Names (when available)","name"));var promptConfig=new Element("div",{class:"import-section"}).update("Options:"),dataSection3=new Element("div",{class:"import-block"});dataSection3.insert(promptConfig).insert(configListElementJSON).insert(configListElementPED),mainDiv.insert(dataSection3);var buttons=new Element("div",{class:"buttons import-block-bottom"});buttons.insert(new Element("input",{type:"button",name:"export",value:"Export",class:"button",id:"export_button"}).wrap("span",{class:"buttonwrapper"})),buttons.insert(new Element("input",{type:"button",name:"cancel",value:"Cancel",class:"button secondary"}).wrap("span",{class:"buttonwrapper"})),mainDiv.insert(buttons),buttons.down('input[name="cancel"]').observe("click",function(event){_this.hide()}),buttons.down('input[name="export"]').observe("click",function(event){_this._onExportStarted()});var closeShortcut=["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(mainDiv,{close:{method:this.hide.bind(this),keys:closeShortcut}},{extraClassName:"pedigree-import-chooser",title:"Pedigree export",displayCloseButton:!0})},disableEnableOptions:function(){var exportType=$$('input:checked[type=radio][name="export-type"]')[0].value,pedOptionsTable=$("pedOptions"),jsonOptionsTable=$("jsonOptions");if("ped"==exportType||"BOADICEA"==exportType){pedOptionsTable.show();var idgenerator=$$('input[type=radio][name="ped-options"]')[2];"BOADICEA"==exportType?(idgenerator.checked&&($$('input[type=radio][name="ped-options"]')[0].checked=!0),idgenerator.up().hide()):idgenerator.up().show(),jsonOptionsTable.hide()}else pedOptionsTable.hide(),jsonOptionsTable.show()},_onExportStarted:function(){this.hide();var patientDocument=(new WebService).getParticipantId();null!=patientDocument&&void 0!=patientDocument||(patientDocument="participant");var exportType=$$('input:checked[type=radio][name="export-type"]')[0].value;if("simpleJSON"==exportType)var privacySetting=$$('input:checked[type=radio][name="export-options"]')[0].value,exportString=PedigreeExport.exportAsSimpleJSON(editor.getGraph().DG,privacySetting),fileName=patientDocument+"_pedigree.json";else{var idGenerationSetting=$$('input:checked[type=radio][name="ped-options"]')[0].value;if("ped"==exportType)var exportString=PedigreeExport.exportAsPED(editor.getGraph().DG,idGenerationSetting),fileName=patientDocument+".ped";else if("BOADICEA"==exportType)var exportString=PedigreeExport.exportAsBOADICEA(editor.getGraph(),idGenerationSetting),fileName=patientDocument+".txt"}console.log("Export data: >>"+exportString+"<<"),""!=exportString&&FileSaver.saveTextAs(exportString,fileName)},show:function(){this.dialog.show()},hide:function(){this.dialog.closeDialog()}});