/*! pedigree-editor-tool - v1.3.1 - 2017-05-22
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var PersonHoverbox=Class.create(AbstractHoverbox,{initialize:function($super,personNode,centerX,centerY,nodeShapes){var radius=PedigreeEditorParameters.attributes.personHoverBoxRadius;$super(personNode,-radius,-radius,2*radius,2*radius,centerX,centerY,nodeShapes)},generateHandles:function($super){if(null===this._currentHandles){$super();var x=this.getNodeX(),y=this.getNodeY(),node=this.getNode(),nodeShapes=node.getGraphics().getGenderGraphics().flatten();if(editor.getPaper().setStart(),PedigreeEditorParameters.attributes.newHandles){var strokeWidth=editor.getWorkspace().getSizeNormalizedToDefaultZoom(PedigreeEditorParameters.attributes.handleStrokeWidth),partnerGender="U";"F"==node.getGender()&&(partnerGender="M"),"M"==node.getGender()&&(partnerGender="F");var splitLocationY=y-PedigreeEditorParameters.attributes.personHandleBreakY-4,path=[["M",x,y],["L",x,splitLocationY],["L",x+PedigreeEditorParameters.attributes.personSiblingHandleLengthX,splitLocationY]];if(editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).insertBefore(nodeShapes),this.generateHandle("sibling",x+PedigreeEditorParameters.attributes.personSiblingHandleLengthX-strokeWidth/3,splitLocationY,x+PedigreeEditorParameters.attributes.personSiblingHandleLengthX-strokeWidth/2,splitLocationY+PedigreeEditorParameters.attributes.personSiblingHandleLengthY,"Click to create a sibling or drag to an existing parentless person (valid choices will be highlighted in green)","U"),null===editor.getGraph().getParentRelationship(node.getID())){topHandleHint=void 0;if(PedigreeEditorParameters.attributes.enableHandleHintImages)var hintSize=PedigreeEditorParameters.attributes.radius/2,path=[["M",x-hintSize,y-PedigreeEditorParameters.attributes.personHandleLength],["L",x+hintSize,y-PedigreeEditorParameters.attributes.personHandleLength]],line1=editor.getPaper().path(path).attr({"stroke-width":strokeWidth/3,stroke:"#555555"}).toBack(),father=editor.getPaper().rect(x-hintSize-11,y-PedigreeEditorParameters.attributes.personHandleLength-5.5,11,11).attr({fill:"#CCCCCC"}).toBack(),mother=editor.getPaper().circle(x+hintSize+6,y-PedigreeEditorParameters.attributes.personHandleLength,6).attr({fill:"#CCCCCC"}).toBack(),topHandleHint=editor.getPaper().set().push(line1,father,mother);this.generateHandle("parent",x,splitLocationY,x,y-PedigreeEditorParameters.attributes.personHandleLength,"Click to create new nodes for the parents or drag to an existing person or partnership (valid choices will be highlighted in green). Dragging to a person will create a new relationship.","F",topHandleHint)}if(!node.isFetus()&&"adoptedOut"!=node.getAdopted()){if(null===node.getChildlessStatus()){path=[["M",x,y],["L",x,y+PedigreeEditorParameters.attributes.personHandleBreakX]];editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).insertBefore(nodeShapes),this.generateHandle("child",x,y+PedigreeEditorParameters.attributes.personHandleBreakX-2,x,y+PedigreeEditorParameters.attributes.personHandleLength,"Click to create a new child node or drag to an existing parentless person (valid choices will be highlighted in green)","U")}var vertPosForPartnerHandles=y,path=[["M",x,vertPosForPartnerHandles],["L",x-PedigreeEditorParameters.attributes.personHandleBreakX,vertPosForPartnerHandles]];editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).insertBefore(nodeShapes),this.generateHandle("partnerR",x-PedigreeEditorParameters.attributes.personHandleBreakX+2,vertPosForPartnerHandles,x-PedigreeEditorParameters.attributes.personHandleLength,vertPosForPartnerHandles,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)",partnerGender)}}else null===editor.getGraph().getParentRelationship(node.getID())&&this.generateHandle("parent",x,y,x,y-PedigreeEditorParameters.attributes.personHandleLength,"Click to create new nodes for the parents or drag to an existing person or partnership (valid choices will be highlighted in green)"),node.isFetus()||"adoptedOut"==node.getAdopted()||(null===node.getChildlessStatus()&&this.generateHandle("child",x,y,x,y+PedigreeEditorParameters.attributes.personHandleLength,"Click to create a new child node or drag to an existing parentless node (valid choices will be highlighted in green)"),this.generateHandle("partnerR",x,y,x+PedigreeEditorParameters.attributes.personHandleLength,y,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)"),this.generateHandle("partnerL",x,y,x-PedigreeEditorParameters.attributes.personHandleLength,y,"Click to create a new partner node or drag to an existing node (valid choices will be highlighted in green)"));this._currentHandles.push(editor.getPaper().setFinish())}},generateButtons:function($super){null===this._currentButtons&&($super(),this.generateMenuBtn(),this.getNode().isProband()||this.generateDeleteBtn())},generateMenuBtn:function(){var me=this,action=function(){me.toggleMenu(!me.isMenuToggled())},genderShapedButton=this.getNode().getGraphics().getGenderShape().clone();genderShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOff),genderShapedButton.click(action),genderShapedButton.hover(function(){genderShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOn)},function(){genderShapedButton.attr(PedigreeEditorParameters.attributes.nodeShapeMenuOff)}),genderShapedButton.attr("cursor","pointer"),this._currentButtons.push(genderShapedButton),this.disable(),this.getFrontElements().push(genderShapedButton),this.enable()},isMenuToggled:function(){return this._isMenuToggled},toggleMenu:function(isMenuToggled){if(!this._justClosedMenu&&(this._isMenuToggled=isMenuToggled,isMenuToggled)){this.getNode().getGraphics().unmark();var optBBox=this.getBoxOnHover().getBBox(),x=optBBox.x2,y=optBBox.y,position=editor.getWorkspace().canvasToDiv(x+5,y);editor.getNodeMenu().show(this.getNode(),position.x,position.y)}},animateHideHoverZone:function($super){if(this._hidden=!0,!this.isMenuToggled()){var parentPartnershipNode=editor.getGraph().getParentRelationship(this.getNode().getID());parentPartnershipNode&&editor.getNode(parentPartnershipNode)&&editor.getNode(parentPartnershipNode).getGraphics().unmarkPregnancy(),$super()}},animateDrawHoverZone:function($super){if(this._hidden=!1,!this.isMenuToggled()){var parentPartnershipNode=editor.getGraph().getParentRelationship(this.getNode().getID());parentPartnershipNode&&editor.getNode(parentPartnershipNode)&&editor.getNode(parentPartnershipNode).getGraphics().markPregnancy(),$super()}},handleAction:function(handleType,isDrag,curHoveredId){if(console.log("handleType: "+handleType+", isDrag: "+isDrag+", curHovered: "+curHoveredId),isDrag&&null!==curHoveredId){if("parent"==handleType){this.removeHandles(),this.removeButtons();event={personID:this.getNode().getID(),parentID:curHoveredId};document.fire("pedigree:person:drag:newparent",event)}else if("partnerR"==handleType||"partnerL"==handleType){this.removeHandles();event={personID:this.getNode().getID(),partnerID:curHoveredId};document.fire("pedigree:person:drag:newpartner",event)}else if("child"==handleType){event={personID:curHoveredId,parentID:this.getNode().getID()};document.fire("pedigree:person:drag:newparent",event)}else if("sibling"==handleType){event={sibling2ID:curHoveredId,sibling1ID:this.getNode().getID()};document.fire("pedigree:person:drag:newsibling",event)}}else if(!isDrag)if("partnerR"==handleType||"partnerL"==handleType){this.removeHandles();var preferLeft="F"==this.getNode().getGender()||"partnerL"==handleType,event={personID:this.getNode().getID(),preferLeft:preferLeft};document.fire("pedigree:person:newpartnerandchild",event)}else if("child"==handleType){position=editor.getWorkspace().canvasToDiv(this.getNodeX(),this.getNodeY()+PedigreeEditorParameters.attributes.personHandleLength+15);editor.getNodetypeSelectionBubble().show(this.getNode(),position.x,position.y)}else if("sibling"==handleType){var position=editor.getWorkspace().canvasToDiv(this.getNodeX()+PedigreeEditorParameters.attributes.personSiblingHandleLengthX-4,this.getNodeY()-PedigreeEditorParameters.attributes.personHandleBreakY+PedigreeEditorParameters.attributes.personSiblingHandleLengthY+15);editor.getSiblingSelectionBubble().show(this.getNode(),position.x,position.y)}else if("parent"==handleType){this.removeHandles(),this.removeButtons();event={personID:this.getNode().getID()};document.fire("pedigree:person:newparent",event)}this.animateHideHoverZone()}});