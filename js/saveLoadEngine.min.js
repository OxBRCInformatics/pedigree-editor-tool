/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var SaveLoadEngine=Class.create({initialize:function(){this._saveInProgress=!1},serialize:function(){var jsonObject=editor.getGraph().toJSONObject();return jsonObject.settings=editor.getView().getSettings(),JSON.stringify(jsonObject)},createGraphFromSerializedData:function(JSONString,noUndo,centerAround0){console.log("---- load: parsing data ----"),document.fire("pedigree:load:start");try{var jsonObject=JSON.parse(JSONString),changeSet=editor.getGraph().fromJSONObject(jsonObject);editor._unRenderedLegend.removeAllNodes();var unRenderedNodes=changeSet.unRendered;editor._unRenderedLegend.addAllNodes(unRenderedNodes),editor.getWorkspace().clearMenuText(),jsonObject.hasOwnProperty("settings")&&editor.getView().loadSettings(jsonObject.settings)}catch(err){return console.log("ERROR loading the graph: "+err),alert("Error loading the graph"),document.fire("pedigree:graph:clear"),void document.fire("pedigree:load:finish")}if(!noUndo){var probandJSONObject=editor.getProbandDataFromPhenotips();editor.getGraph().setProbandData(probandJSONObject)||alert("Proband gender defined in Phenotips is incompatible with this pedigree. Setting proband gender to 'Unknown'"),JSONString=this.serialize()}editor.getView().applyChanges(changeSet,!1)&&editor.getWorkspace().adjustSizeToScreen(),centerAround0&&editor.getWorkspace().centerAroundNode(0),noUndo||editor.isReadOnlyMode()||editor.getUndoRedoManager().addState(null,null,JSONString),document.fire("pedigree:load:finish")},createGraphFromImportData:function(importString,importType,importOptions,noUndo,centerAround0){console.log("---- import: parsing data ----"),document.fire("pedigree:load:start");try{var changeSet=editor.getGraph().fromImport(importString,importType,importOptions);editor._unRenderedLegend.removeAllNodes();var unRenderedNodes=changeSet.unRendered;if(editor._unRenderedLegend.addAllNodes(unRenderedNodes),editor.getWorkspace().clearMenuText(),null==changeSet)throw"Unable to create a pedigree from imported data"}catch(err){return alert("Error importing pedigree: "+err),void document.fire("pedigree:load:finish")}if(!noUndo){var probandJSONObject=editor.getProbandDataFromPhenotips();editor.getGraph().setProbandData(probandJSONObject)||alert("Proband gender defined in Phenotips is incompatible with the imported pedigree. Setting proband gender to 'Unknown'"),JSONString=this.serialize()}editor.getView().applyChanges(changeSet,!1)&&editor.getWorkspace().adjustSizeToScreen(),centerAround0&&editor.getWorkspace().centerAroundNode(0),noUndo||editor.isReadOnlyMode()||editor.getUndoRedoManager().addState(null,null,JSONString),document.fire("pedigree:load:finish")},save:function(callback){if(!this._saveInProgress){editor.getView().unmarkAll();var exportString=PedigreeExport.exportAsSimpleJSON(editor.getGraph().DG,"all"),_this=this,jsonData=this.serialize();console.log("[SAVE] data: "+Helpers.stringifyObject(jsonData));var svgText=editor.getWorkspace().getSVGCopy(!1).getSVGText(),savingNotification=new XWiki.widgets.Notification("Saving","inprogress"),href=(new WebService).saveDiagramEndpointPath();new Ajax.Request(href,{method:"POST",requestHeaders:{Accept:"application/json text/json"},contentType:"application/json",postBody:'{"jsonDiagram":'+exportString+',"svgDiagram":'+JSON.stringify(svgText)+"}",onCreate:function(){_this._saveInProgress=!0;var closeButton=$("action-close"),saveButton=$("action-save"),saveAndExitButton=$("action-saveAndExit");Element.addClassName(saveButton,"disabled-menu-item"),Element.removeClassName(saveButton,"menu-item"),Element.addClassName(saveButton,"no-mouse-interaction"),Element.addClassName(closeButton,"disabled-menu-item"),Element.removeClassName(closeButton,"menu-item"),Element.addClassName(closeButton,"no-mouse-interaction"),Element.addClassName(saveAndExitButton,"disabled-menu-item"),Element.removeClassName(saveAndExitButton,"menu-item"),Element.addClassName(saveAndExitButton,"no-mouse-interaction"),null!=closeButton&&void 0!=closeButton&&Helpers.disableMouseclicks(closeButton),null!=saveButton&&void 0!=saveButton&&Helpers.disableMouseclicks(saveButton),null!=saveAndExitButton&&void 0!=saveAndExitButton&&Helpers.disableMouseclicks(saveAndExitButton)},onComplete:function(response){_this._saveInProgress=!1;var actionAfterSave=editor.getAfterSaveAction();actionAfterSave&&actionAfterSave();var closeButton=$("action-close"),saveButton=$("action-save"),saveAndExitButton=$("action-saveAndExit");Element.addClassName(saveButton,"menu-item"),Element.removeClassName(saveButton,"disabled-menu-item"),Element.removeClassName(saveButton,"no-mouse-interaction"),Element.addClassName(closeButton,"menu-item"),Element.removeClassName(closeButton,"disabled-menu-item"),Element.removeClassName(closeButton,"no-mouse-interaction"),Element.addClassName(saveAndExitButton,"menu-item"),Element.removeClassName(saveAndExitButton,"disabled-menu-item"),Element.removeClassName(saveAndExitButton,"no-mouse-interaction"),null!=closeButton&&void 0!=closeButton&&Helpers.enableMouseclicks(closeButton),null!=saveButton&&void 0!=saveButton&&Helpers.enableMouseclicks(saveButton),null!=saveAndExitButton&&void 0!=saveAndExitButton&&Helpers.enableMouseclicks(saveAndExitButton)},on401:function(response){_this.handleSaveFail(_this,savingNotification);var message=_this.constructErrorMessage(response.responseJSON,response.statusText);_this.showUnauthorisedSaveError(message)},on0:function(response){_this.handleSaveFail(_this,savingNotification);var message="-- Connection Error --";message+="<br><br><pre>"+response.request.url.replace(/\?.+/,""),message+="</pre><br>Please report this to the ",message+=_this.constructHelpdeskDetails()+"<br>--------<br>",_this.showSaveError(message)},onFailure:function(response){_this.handleSaveFail(_this,savingNotification);var message=_this.constructErrorMessage(response.responseJSON,response.statusText);_this.showSaveError(message)},onSuccess:function(response){if(_this._saveInProgress=!1,editor.getUndoRedoManager().addSaveEvent(),savingNotification.replace(new XWiki.widgets.Notification("Successfully saved")),"openclinica"===(new Settings).getSetting("diagramEndpoint").service){var isAdminEdit=(new WebService).getUrlParameter("adminEdit",!0);if(isAdminEdit&&void 0!=isAdminEdit&&"true"==isAdminEdit){var closeFunction=function(){this.dialog.show(),callback&&callback()};editor.getOkCancelDialogue().showCustomized("Your data will be saved for later but not resubmitted to Genomics England. <br>When you are ready, please resubmit the Pedigree CRF.","Genomics England","Close",closeFunction,null,null,null,null,!0)}else callback&&callback()}else callback&&callback()}})}},load:function(probandDataObj){console.log("initiating load process");var path=(new WebService).getDiagramEndpointPath(),_this=this;new Ajax.Request(path,{method:"GET",requestHeaders:{Accept:"application/json text/json"},contentType:"application/x-www-form-urlencoded",onCreate:function(response){document.fire("pedigree:load:start");var t=response.transport;t.setRequestHeader=t.setRequestHeader.wrap(function(original,k,v){return/^(accept|accept-language|content-language)$/i.test(k)?original(k,v):/^content-type$/i.test(k)&&/^(application\/x-www-form-urlencoded|multipart\/form-data|text\/plain)(;.+)?$/i.test(v)?original(k,v):void 0})},on401:function(response){var message=_this.constructErrorMessage(response.responseJSON,response.statusText);_this.showUnauthorisedLoadError(message)},on0:function(response){var message="-- Connection Error --";message+="<br><br><pre>"+response.request.url.replace(/\?.+/,""),message+="</pre><br>Please report this to the ",message+=_this.constructHelpdeskDetails()+"<br>--------<br>",_this.showLoadError(message)},onFailure:function(response){var message=_this.constructErrorMessage(response.responseJSON,response.statusText);_this.showLoadError(message)},onSuccess:function(response){probandDataObj.probandData={};var pedigreeJSON=response.responseJSON;"openclinica"==(new Settings).getSetting("diagramEndpoint").service&&(pedigreeJSON=response.responseJSON.pedigreeJSON);var jsonContentString=JSON.stringify(pedigreeJSON),importOptions={acceptUnknownPhenotypes:!0,externalIdMark:!0,markEvaluated:!1};this.createGraphFromImportData(jsonContentString,"simpleJSON",importOptions,!1,!0)}.bind(this)})},handleSaveFail:function(_this,savingNotification){_this._saveInProgress=!1,editor.getUndoRedoManager().addSaveEvent(),savingNotification.replace(new XWiki.widgets.Notification("Save unsuccessful"))},showLoadError:function(reason){this.showLoadErrorWithReason("!! Failed to load pedigree model !!",reason)},showUnauthorisedLoadError:function(reason){this.showLoadErrorWithReason("!! User is not allowed to load pedigree model !!",reason)},showLoadErrorWithReason:function(message,reason){var fullMessage=message+"<br><br>"+reason+"<br>Please choose a base template.";editor.getOkCancelDialogue().showCustomized(fullMessage,"Error Loading Model","Choose Template",function(){new TemplateSelector(!0)},null,null,null,null,!0)},showSaveError:function(reason){this.showSaveErrorWithReason("!! Failed to save pedigree model !!",reason)},showUnauthorisedSaveError:function(reason){this.showSaveErrorWithReason("!! User is not allowed to save pedigree model !!",reason)},showSaveErrorWithReason:function(message,reason){var fullMessage=message+"<br><br>"+reason;editor.getOkCancelDialogue().showCustomized(fullMessage,"Error Saving Model","Close",function(){},null,null,null,null,!0)},constructErrorMessage:function(json,status){var message="-- "+status;return json?json.errorCode||json.type?message=this.constructMercuryErrorMessage(json,message):json.message&&(message+=" :: "+json.message+" --"):message+=" :: Unknown cause --",message+"<br>--------<br>"},constructMercuryErrorMessage:function(json,message){return json.message?(message+=" --<br><br>:: ",json.errorCode&&!json.message.startsWith(json.errorCode)&&(message+=json.errorCode+" - "),message+=json.message+" ::<br>",json.exception?message+=this.constructExceptionSection(json.exception):json.type&&(message+=this.constructExceptionSection(json)),json.validationErrors&&(message+=this.constructJsonRenderSection(json.validationErrors,"Please find the validation errors below"))):json.type?(message+=" :: "+json.type,message+=this.constructExceptionSection(json)):message+=" :: Unknown Reason --",message},constructExceptionSection:function(exception){return renderJson={exception:{type:exception.type,message:exception.message}},exception.stacktrace&&(renderJson.exception.stacktrace=exception.stacktrace),this.constructJsonRenderSection(renderJson,"Please copy the below and provide to the "+this.constructHelpdeskDetails())},constructJsonRenderSection:function(renderJson,title){var message="<br>--------<br>"+title+"<br><br>";return message+='<pre style="text-align: left;">',message+=JSON.stringify(renderJson,null,2),message+="</pre>"},constructHelpdeskDetails:function(){var contact="Help Desk",config=(new Settings).getSetting("helpdesk");return config&&(contact=config.name,contact+="<br>",contact+=config.contact.phone+" :: "+config.contact.email),contact}});