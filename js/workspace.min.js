/*! pedigree-editor-tool - v1.3.0 - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var Workspace=Class.create({initialize:function(){var me=this;this._settings=new Settings,this.canvas=new Element("div",{id:"canvas"}),this.workArea=new Element("div",{id:"work-area"}).update(this.canvas),$("body").update(this.workArea);var screenDimensions=document.viewport.getDimensions();this.topMenu=this.generateTopMenu(),this.width=screenDimensions.width,this.height=screenDimensions.height-this.canvas.cumulativeOffset().top-4,this._paper=Raphael("canvas",this.width,this.height),this.viewBoxX=0,this.viewBoxY=0,this.zoomCoefficient=1,this.disablePan=!1,this.background=this.getPaper().rect(0,0,this.width,this.height).attr({fill:"blue",stroke:"none",opacity:0}).toBack(),this.background.node.setAttribute("class","panning-background"),this.adjustSizeToScreen=this.adjustSizeToScreen.bind(this),Event.observe(window,"resize",me.adjustSizeToScreen),this.generateViewControls();var start=function(){if(me.background.ox=me.background.attr("x"),me.background.oy=me.background.attr("y"),editor.isAnyMenuVisible())return void(me.disablePan=!0);me.background.attr({cursor:"move"})},move=function(dx,dy){if(editor.isAnyMenuVisible()||me.disablePan)return void(me.disablePan=!0);var deltax=me.viewBoxX-dx/me.zoomCoefficient,deltay=me.viewBoxY-dy/me.zoomCoefficient;me.getPaper().setViewBox(deltax,deltay,me.width/me.zoomCoefficient,me.height/me.zoomCoefficient),me.background.ox=deltax,me.background.oy=deltay,me.background.attr({x:deltax,y:deltay})},end=function(){me.viewBoxX=me.background.ox,me.viewBoxY=me.background.oy,me.background.attr({cursor:"default"}),me.disablePan=!1};me.background.drag(move,start,end),document.addEventListener&&(me.handleMouseWheel=function(evt){if(evt.preventDefault?evt.preventDefault():evt.returnValue=!1,!editor.isAnyMenuVisible()){if((evt.wheelDelta?-evt.wheelDelta:evt.detail)>0){$$(".zoom-out")[0];$$(".zoom-out")[0].click()}else $$(".zoom-in")[0].click()}},navigator.userAgent.toLowerCase().indexOf("webkit")>=0?this.canvas.addEventListener("mousewheel",me.handleMouseWheel,!1):this.canvas.addEventListener("DOMMouseScroll",me.handleMouseWheel,!1))},getSVGCopy:function(anonimize){editor.getView().unmarkAll();var image=$("canvas"),background=image.getElementsByClassName("panning-background")[0];background.style.display="none",anonimize&&editor.getView().setAnonimizeStatus(!0);var _bbox=image.down().getBBox(),bbox={};bbox.x=Math.floor(_bbox.x)-2,bbox.y=Math.floor(_bbox.y)-2,bbox.width=Math.ceil(_bbox.width)+4,bbox.height=Math.ceil(_bbox.height)+4;var svgText=image.innerHTML.replace(/xmlns(:xlink)?=".*?"/g,"").replace(/width=".*?"/,"").replace(/height=".*?"/,"").replace(/viewBox=".*?"/,'viewBox="'+bbox.x+" "+bbox.y+" "+bbox.width+" "+bbox.height+'" width="'+bbox.width+'" height="'+bbox.height+'" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg"');return anonimize&&editor.getView().setAnonimizeStatus(!1),svgText=svgText.replace(/(<svg[^<>]+style=")/g,"$1display:block; "),svgText=svgText.replace(/<[^<>]+display: ?none;[^<>]+([^/]><\/\w+|\/)>/g,""),svgText=svgText.replace(/<[^<>]+[" ]opacity: ?0;[^<>]+([^/]><\/\w+|\/)>/g,""),svgText=svgText.replace(/<circle [^<>]+pedigree-partnership-circle[^<>]+([^/]><\/\w+|\/)>/g,""),svgText=svgText.replace(/<a [^<>]*xlink:title=[^<>]+([^/]><\/\w+|\/)>/g,""),svgText=svgText.replace(/<[^<>]+pedigree-hoverbox[^<>]+([^/]><\/\w+|\/)>/g,""),svgText=svgText.replace(/<[^<>]+pedigree-node-shadow[^<>]+([^/]><\/\w+|\/)>/g,""),svgText=svgText.replace(/<linearGradient.*<\/linearGradient>/g,""),svgText=svgText.replace(/<radialGradient.*?<\/radialGradient>/g,""),svgText=svgText.replace(/<desc>[^<>]+<\/desc>/g,""),background.style.display="",new SVGWrapper(svgText,bbox,1)},getPaper:function(){return this._paper},getWorkArea:function(){return this.workArea},getWidth:function(){return this.width},getHeight:function(){return this.height},generateTopMenu:function(){var menu=new Element("div",{class:"editor-menu"});this.getWorkArea().insert({before:menu});var secondaryMenu=new Element("div",{class:"editor-menu editor-menu-secondary"});this.getWorkArea().insert({before:secondaryMenu}),secondaryMenu.hide();var hideShowSubmenu=function(button,icon){"none"==secondaryMenu.style.display?(secondaryMenu.show(),Element.removeClassName(icon,"fa-caret-down"),Element.addClassName(icon,"fa-caret-up")):(secondaryMenu.hide(),Element.removeClassName(icon,"fa-caret-up"),Element.addClassName(icon,"fa-caret-down"))},menuItems=[];menuItems=editor.isUnsupportedBrowser()?[{name:"input",items:[{key:"readonlymessage",label:"Unsuported browser mode",icon:"exclamation-triangle"}]},{name:"output",items:[{key:"export",label:"Export",icon:"download"},{key:"close",label:"Close",icon:"sign-out"}]}]:[{name:"input",items:[{key:"templates",label:"Templates",icon:"copy"},{key:"import",label:"Import",icon:"upload"}]},{name:"edit",items:[{key:"undo",label:"Undo",icon:"undo"},{key:"redo",label:"Redo",icon:"repeat"},{key:"layout",label:"Automatic layout",icon:"sitemap"},{key:"more",label:"More...",icon:"caret-down",callback:hideShowSubmenu}]},{name:"print",items:[{key:"print",label:"Print",icon:"print"}]},{name:"output",items:[{key:"save",label:"Save",icon:"check"},{key:"saveAndExit",label:"Save & Exit",icon:"check"},{key:"export",label:"Export",icon:"download"},{key:"close",label:"Close",icon:"sign-out"}]},{name:"details",items:[{key:"familyId",label:"",isTextOnly:!0}]},{name:"version",items:[{key:"version",label:"Editor Version: "+this._settings.getSetting("version"),isTextOnly:!0}]}];var secondaryMenuItems=[];editor.isUnsupportedBrowser()||(secondaryMenuItems=[{name:"edit",items:[{key:"number",label:"Renumber",icon:"sort-numeric-asc"}]},{name:"other",items:[{key:"clear",label:"Clear",icon:"times-circle"}]}]);var _createSubmenu=function(data){var submenu=new Element("div",{class:data.name+"-actions action-group"});this.insert(submenu),data.items.each(function(item){submenu.insert(_createMenuItem(item))})},_createMenuItem=function(data){var settings=new Settings;if(data.isTextOnly)return mi=new Element("span",{id:"text-"+data.key,class:"menu-item-text-only"}).insert(data.label);if(!0===settings.getSetting("saveAndExit")){if("save"==data.key||"close"==data.key)return}else if("saveAndExit"==data.key)return;var buttonIcon=new Element("span",{class:"fa fa-"+data.icon}),mi=new Element("span",{id:"action-"+data.key,class:"field-no-user-select menu-item "+data.key}).insert(buttonIcon).insert(" ").insert(data.label);return data.callback&&"function"==typeof data.callback&&mi.observe("click",function(){data.callback(mi,buttonIcon)}),mi};return menuItems.each(_createSubmenu.bind(menu)),secondaryMenuItems.each(_createSubmenu.bind(secondaryMenu)),menu},setMenuText:function(participantId,familyId){if(this.topMenu){var span=this.topMenu.select("span#text-familyId");if(span&&span.length>0){var label="";participantId&&participantId.length>0&&(label="Proband Id: "+participantId),familyId&&familyId.length>0&&(label=label+" Family Id:"+familyId),span[0].update(label)}}},clearMenuText:function(){if(this.topMenu){var span=this.topMenu.select("span#text-familyId");span&&span.length>0&&span[0].update("")}},zoom:function(zoomCoefficient){zoomCoefficient<.15&&(zoomCoefficient=.15),zoomCoefficient>.15&&zoomCoefficient<.25&&(zoomCoefficient=.25),zoomCoefficient=Math.round(zoomCoefficient/.05)/20;var newWidth=this.width/zoomCoefficient,newHeight=this.height/zoomCoefficient;this.viewBoxX=this.viewBoxX+(this.width/this.zoomCoefficient-newWidth)/2,this.viewBoxY=this.viewBoxY+(this.height/this.zoomCoefficient-newHeight)/2,this.getPaper().setViewBox(this.viewBoxX,this.viewBoxY,newWidth,newHeight),this.zoomCoefficient=zoomCoefficient,this.background.attr({x:this.viewBoxX,y:this.viewBoxY,width:newWidth,height:newHeight})},generateViewControls:function(){var _this=this;this.__controls=new Element("div",{class:"view-controls"}),this.__pan=new Element("div",{class:"view-controls-pan",title:"Pan"}),this.__controls.insert(this.__pan),["up","right","down","left","home"].each(function(direction){var faIconClass="home"==direction?"fa-user":"fa-arrow-"+direction;_this.__pan[direction]=new Element("span",{class:"view-control-pan pan-"+direction+" fa fa-fw "+faIconClass,title:"Pan "+direction}),_this.__pan.insert(_this.__pan[direction]),_this.__pan[direction].observe("click",function(event){"home"==direction?_this.centerAroundNode(0):"up"==direction?_this.panTo(_this.viewBoxX,_this.viewBoxY-150):"down"==direction?_this.panTo(_this.viewBoxX,_this.viewBoxY+150):"left"==direction?_this.panTo(_this.viewBoxX-150,_this.viewBoxY):_this.panTo(_this.viewBoxX+150,_this.viewBoxY)})});this.__zoom=new Element("div",{class:"view-controls-zoom",title:"Zoom"}),this.__controls.insert(this.__zoom),this.__zoom.track=new Element("div",{class:"zoom-track"}),this.__zoom.handle=new Element("div",{class:"zoom-handle",title:"Drag to zoom"}),this.__zoom.in=new Element("div",{class:"zoom-button zoom-in fa fa-fw fa-search-plus",title:"Zoom in"}),this.__zoom.out=new Element("div",{class:"zoom-button zoom-out fa fa-fw fa-search-minus",title:"Zoom out"}),this.__zoom.label=new Element("div",{class:"zoom-crt-value"}),this.__zoom.insert(this.__zoom.in),this.__zoom.insert(this.__zoom.track),this.__zoom.track.insert(this.__zoom.handle),this.__zoom.track.style.height="200px",this.__zoom.insert(this.__zoom.out),this.__zoom.insert(this.__zoom.label),this.zoomSlider=new Control.Slider(this.__zoom.handle,this.__zoom.track,{axis:"vertical",minimum:0,maximum:200,increment:1,alignY:6,onSlide:function(value){value<=.9?_this.zoom(-value/.9+1.25):_this.zoom(.15)},onChange:function(value){value<=.9?_this.zoom(-value/.9+1.25):_this.zoom(.15)}}),editor.isUnsupportedBrowser()?this.zoomSlider.setValue(.225):this.zoomSlider.setValue(.45),this.__zoom.in.observe("click",function(event){_this.zoomCoefficient<.25?_this.zoomSlider.setValue(.9):_this.zoomSlider.setValue(.9*-(_this.zoomCoefficient-1))}),this.__zoom.out.observe("click",function(event){_this.zoomCoefficient<=.25?_this.zoomSlider.setValue(1):_this.zoomSlider.setValue(.9*-(_this.zoomCoefficient-1.5))}),this.getWorkArea().insert(this.__controls)},getSizeNormalizedToDefaultZoom:function(pixelSizeAtDefaultZoom){return pixelSizeAtDefaultZoom},getCurrentZoomLevel:function(pixelSizeAtDefaultZoom){return this.zoomCoefficient},canvasToDiv:function(canvasX,canvasY){return{x:this.zoomCoefficient*(canvasX-this.viewBoxX),y:this.zoomCoefficient*(canvasY-this.viewBoxY)}},divToCanvas:function(divX,divY){return{x:divX/this.zoomCoefficient+this.viewBoxX,y:divY/this.zoomCoefficient+this.viewBoxY}},viewportToDiv:function(absX,absY){return{x:+absX-this.canvas.cumulativeOffset().left,y:absY-this.canvas.cumulativeOffset().top}},panTo:function(x,y,instant){var me=this,xDisplacement=x-this.viewBoxX,yDisplacement=y-this.viewBoxY;editor.isUnsupportedBrowser()&&(instant=!0);var numSeconds=instant?0:.4,frames=instant?1:11,xStep=xDisplacement/frames,yStep=yDisplacement/frames;if(0!=xStep||0!=yStep){var progress=0;!function draw(){setTimeout(function(){progress++<frames&&(me.viewBoxX+=xStep,me.viewBoxY+=yStep,me.getPaper().setViewBox(me.viewBoxX,me.viewBoxY,me.width/me.zoomCoefficient,me.height/me.zoomCoefficient),me.background.attr({x:me.viewBoxX,y:me.viewBoxY}),draw())},1e3*numSeconds/frames)}()}},panByX:function(deltaX,instant){this.panTo(this.viewBoxX+Math.floor(deltaX/this.zoomCoefficient),this.viewBoxY,instant)},adjustSizeToScreen:function(){var screenDimensions=document.viewport.getDimensions();this.width=screenDimensions.width,this.height=screenDimensions.height-this.canvas.cumulativeOffset().top-4,this.getPaper().setSize(this.width,this.height),this.getPaper().setViewBox(this.viewBoxX,this.viewBoxY,this.width/this.zoomCoefficient,this.height/this.zoomCoefficient),this.background&&this.background.attr({width:this.width,height:this.height}),editor.getNodeMenu()&&editor.getNodeMenu().reposition()},centerAroundNode:function(nodeID,instant,xCenterShift,yCenterShift){var node=editor.getNode(nodeID);if(node){var x=node.getX(),y=node.getY();xCenterShift||(xCenterShift=0),yCenterShift||(yCenterShift=0);var xOffset=this.getWidth()/this.zoomCoefficient,yOffset=this.getHeight()/this.zoomCoefficient;this.panTo(x-xOffset/2-xCenterShift,y-yOffset/2-yCenterShift,instant)}}});