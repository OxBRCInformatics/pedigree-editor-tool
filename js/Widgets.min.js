/*! pedigree-editor-tool - v1.3.0 - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).SolrQueryProcessor=Class.create({initialize:function(queryFields,restriction){this.queryFields=queryFields,this.restriction=restriction},processQuery:function(query){return this.inflateQuery(query)},generateParameters:function(query){var parameters={defType:"edismax","spellcheck.collate":!0,spellcheck:!0,lowercaseOperators:!1};return this.setupMandatoryQuery(query,parameters)?parameters:(this.restrictQuery(query,parameters),this.setupQueryFields(query,parameters),parameters)},setupMandatoryQuery:function(query,parameters){var txt=query.strip(),mandatoryQuery="",hasMandatoryFields=!1;for(var field in this.queryFields){var fieldOptions=this.queryFields[field],activationRegex=fieldOptions.activationRegex;fieldOptions.mandatory&&activationRegex&&txt.match(activationRegex)&&(mandatoryQuery+=field+":"+(fieldOptions.transform?fieldOptions.transform(query):query)+" ",hasMandatoryFields=!0)}return mandatoryQuery&&(parameters.fq=mandatoryQuery.strip()),hasMandatoryFields},restrictQuery:function(query,parameters){if(this.restriction){var result="";for(var rField in this.restriction){for(var restrictionString=("-"==rField.substring(0,1)?"-":"+")+"(",i=0;i<this.restriction[rField].length;++i)restrictionString+=rField.replace(/^-/,"")+":"+this.restriction[rField][i].replace(/:/g,"\\:")+" ";result+=restrictionString=restrictionString.strip()+") "}result&&(parameters.fq=result.strip())}},setupQueryFields:function(query,parameters){var txt=query.strip(),wordFields="",phraseFields="",boostQuery="",lastWord=query.replace(/.*\W/g,"");for(var field in this.queryFields){var fieldOptions=this.queryFields[field],activationRegex=fieldOptions.activationRegex;activationRegex&&!txt.match(activationRegex)||(fieldOptions.wordBoost&&(wordFields+=field+"^"+fieldOptions.wordBoost+" "),fieldOptions.phraseBoost&&(phraseFields+=field+"^"+fieldOptions.phraseBoost+(fieldOptions.phraseSlop?"~"+fieldOptions.phraseSlop:"")+" "),lastWord&&fieldOptions.stubBoost&&(boostQuery+=field+":"+lastWord.replace(/:/g,"\\:")+"*^"+fieldOptions.stubBoost+" "))}wordFields&&(parameters.qf=wordFields.strip()),phraseFields&&(parameters.pf=phraseFields.strip()),boostQuery&&(parameters.bq=boostQuery.strip())},inflateQuery:function(query){var lastWord=query.replace(/.*\W/g,"");if(!lastWord)return query;var result=query;for(var field in this.queryFields)this.queryFields[field].stubTrigger&&(result+=" "+field+":"+lastWord.replace(/:/g,"\\:")+"*");return result.strip()}}),PhenoTips}(PhenoTips||{}),PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).DropDown=Class.create({options:{},initialize:function(element){this.element=element,this.hasForceOpen=!1;var existingDropdown=element.next(".dropdown");existingDropdown?(this.contentContainer=null,this.dropdown=existingDropdown,this.hasForceOpen=!0):(this.dropdown=new Element("div",{class:"dropdown"}),this.contentContainer=new Element("div"),this.dropdown.update(this.contentContainer))},setContent:function(content){null!=this.contentContainer&&this.contentContainer.update(content)},show:function(force){return!(force&&!this.hasForceOpen)&&(this.dropdown.hasClassName("invisible")?this.dropdown.removeClassName("invisible"):this.element.insert({after:this.dropdown}),!0)},close:function(force){return!(force&&!this.hasForceOpen)&&(this.dropdown.addClassName("invisible"),!0)}}),PhenoTips}((PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).OntologyBrowser=Class.create({options:{script:"${xwiki.getURL('PhenoTips.SolrService', 'get', 'sort=nameSort asc&start=0&rows=10000')}&",varname:"q",method:"post",json:!0,responseFormat:"application/json",resultsParameter:function(){return"rows"},resultId:function(){return"id"},resultValue:function(){return"name"},resultCategory:"term_category",resultParent:{selector:"is_a",processingFunction:function(text){var data={};return data.id=text.replace(/\s+/gm," ").replace(/(HP:[0-9]+)\s*!\s*(.*)/m,"$1"),data.value=text.replace(/\s+/gm," ").replace(/(HP:[0-9]+)\s*!\s*(.*)/m,"$2"),data}},noresults:"No sub-terms",targetQueryProcessor:void 0===PhenoTips.widgets.SolrQueryProcessor?null:new PhenoTips.widgets.SolrQueryProcessor({id:{activationRegex:/^HP:[0-9]+$/i,mandatory:!0,transform:function(query){return query.toUpperCase().replace(/:/g,"\\:")}}}),expandQueryProcessor:void 0===PhenoTips.widgets.SolrQueryProcessor?null:new PhenoTips.widgets.SolrQueryProcessor({is_a:{activationRegex:/^HP:[0-9]+$/i,mandatory:!0,transform:function(query){return query.toUpperCase().replace(/:/g,"\\:")}}}),showParents:!0,showRoot:!0,enableSelection:!0,enableBrowse:!0,isTermSelected:function(id){return!1},unselectTerm:function(id){},defaultEntryAction:"browse"},initialize:function(suggest,container,options){this.options=Object.extend(Object.clone(this.options),options||{}),this.suggest=suggest,this.loadingMessage=new Element("div",{class:"plainmessage loading"}).update("Loading..."),container?this.container=container:(this.container=new PhenoTips.widgets.ModalPopup(this.loadingMessage,{},{idPrefix:"ontology-browser-window-",title:"Related terms",backgroundColor:"#ffffff",verticalPosition:"top",extraDialogClassName:"dialog-ontology-browser",removeOnClose:!0}),this.options.modal=!0),this._obrowserExpandEventHandler=this._obrowserExpandEventHandler.bindAsEventListener(this)},load:function(id){this.setContent(this.loadingMessage);var query=id,parameters={};null!=this.options.targetQueryProcessor&&"function"==typeof this.options.targetQueryProcessor.generateParameters&&(parameters=this.options.targetQueryProcessor.generateParameters(query)),null!=this.options.targetQueryProcessor&&"function"==typeof this.options.targetQueryProcessor.processQuery&&(query=this.options.targetQueryProcessor.processQuery(query));var url=this.options.script+this.options.varname+"="+encodeURIComponent(query),headers={};headers.Accept=this.options.responseFormat;new Ajax.Request(url,{method:this.options.method,parameters:parameters,requestHeaders:headers,onSuccess:function(response){this.setContent(this.buildTree(this._getDataFromResponse(response))),this.__crtRoot=id,this.container.content&&Event.fire(document,"xwiki:dom:updated",{elements:[this.container.contentContainer||this.container.content]})}.bind(this),onFailure:function(response){this.setContent("Failed to retrieve data : "+response.statusText),this.__crtRoot=""}.bind(this)})},expandTo:function(termId,categories){-1!=categories.indexOf(this.__crtRoot)&&this._expandToStep(termId,categories.without(this.__crtRoot,termId))},_expandToStep:function(termId,categories){var _this=this;if(!this.container.contentContainer.down('li.entry input.select-tool[value="'+termId.replace(/"/g,'\\"')+'"]')){var finishedStep=!1;categories.each(function(category){if(!finishedStep){var categoryInput=_this.container.contentContainer.down('li.entry input.select-tool[value="'+category.replace(/"/g,'\\"')+'"]');if(categoryInput){var categoryEntry=categoryInput.up("li");!categoryEntry.hasClassName("collapsed")&&categoryEntry.down(".descendents")||(Event.observe(categoryEntry,"obrowser:expand:finished",function(event){Event.stopObserving(categoryEntry,"obrowser:expand:finished"),_this._expandToStep(termId,categories.without(category))}),_this._toggleExpandState(categoryEntry),finishedStep=!0)}}})}},expand:function(element,doPopulate){var query=element.__termId,parameters={};null!=this.options.expandQueryProcessor&&"function"==typeof this.options.expandQueryProcessor.generateParameters&&(parameters=this.options.expandQueryProcessor.generateParameters(query)),null!=this.options.expandQueryProcessor&&"function"==typeof this.options.expandQueryProcessor.processQuery&&(query=this.options.expandQueryProcessor.processQuery(query));var url=this.options.script+this.options.varname+"="+encodeURIComponent(query),headers={};headers.Accept=this.options.responseFormat;new Ajax.Request(url,{method:this.options.method,requestHeaders:headers,parameters:parameters,onCreate:function(){this._lockExpandTool(element)}.bind(this),onSuccess:function(response){var memo={};if(doPopulate){var newAdditions=this.buildDescendentsList(this._getDataFromResponse(response));element.insert({bottom:newAdditions}),Event.fire(document,"obrowser:content:added",{added:newAdditions,obrowser:this}),Event.fire(element,"obrowser:expand:finished"),Event.fire(this.container.contentContainer||document,"obrowser:expand:finished"),Event.fire(document,"xwiki:dom:updated",{elements:[newAdditions]})}else memo.count=this.countDescendents(this._getDataFromResponse(response));if(0===memo.count||doPopulate&&!element.down(".descendents .entry, .error")){element.addClassName("collapsed");var expandTool=element.down(".expand-tool");expandTool&&(expandTool.update(this._getExpandCollapseSymbol(!0)).addClassName("disabled"),expandTool.stopObserving("click"))}Event.fire(document,"ms:popup:content-updated",{popup:this.container})}.bind(this),onFailure:function(response){Event.fire(element,"obrowser:expand:failed",{data:new Element("div",{class:"error"}).update("Failed to retrieve data : "+response.statusText),count:-1})},onComplete:function(){this._unlockExpandTool(element)}.bind(this)})},_getDataFromResponse:function(response){return this.options.json?response.responseJSON:response.responseXML},_getResultset_json:function(data,fieldName){return data&&data[fieldName]||[]},_getResultFieldValue_json:function(data,fieldName){return data&&data[fieldName]||""},_getResultFieldValueAsArray_json:function(data,fieldName){return new Array(data&&data[fieldName]||"").flatten()},_getResultset_xml:function(data,selector){return data&&data.getElementsByTagName(selector)},_getResultFieldValue_xml:function(data,selector){var element=data&&Element.down(data,selector);return element&&element.firstChild&&element.firstChild.nodeValue||""},_getResultFieldValueAsArray_xml:function(data,selector){var result=new Array;return data&&Element.select(data,selector).each(function(item){var value=item.firstChild&&item.firstChild.nodeValue;value&&result.push(value)}),result},_getResultset:function(data,fieldName){return this.options.json?this._getResultset_json(data,fieldName):this._getResultset_xml(data,fieldName)},_getResultFieldValue:function(data,fieldName){return this.options.json?this._getResultFieldValue_json(data,fieldName):this._getResultFieldValue_xml(data,fieldName)},_getResultFieldValueAsArray:function(data,fieldName){return this.options.json?this._getResultFieldValueAsArray_json(data,fieldName):this._getResultFieldValueAsArray_xml(data,fieldName)},buildTree:function(data){var results=this._getResultset(data,this.options.resultsParameter());if(0==results.length)return new Element("div",{class:"error"}).update(this.options.noresults);var targetResult=results[0],newContent=new Element("div");if(this.options.showParents){var parents=new Element("ul",{class:"parents"});this._getResultFieldValueAsArray(targetResult,this.options.resultParent.selector).each(function(item){var text=item,data={};"function"==typeof this.options.resultParent.processingFunction&&(data=this.options.resultParent.processingFunction(text)),parents.insert({bottom:this._createParentBranch(data)})}.bind(this)),parents.hasChildNodes()&&newContent.insert({top:parents}),Event.fire(document,"obrowser:content:added",{added:parents,obrowser:this})}var data={id:this._getResultFieldValue(targetResult,this.options.resultId()),value:this._getResultFieldValue(targetResult,this.options.resultValue()),category:this._generateEntryCategory(targetResult)},root=this._createRoot(data);return newContent.insert({bottom:root}),Event.fire(document,"obrowser:content:added",{added:root,obrowser:this}),newContent},countDescendents:function(xml){return this._getResultset(xml,this.options.resultsParameter()).length},buildDescendentsList:function(xml){for(var results=this._getResultset(xml,this.options.resultsParameter()),list=new Element("ul",{class:"descendents"}),i=0;i<results.length;i++){var data={id:this._getResultFieldValue(results[i],this.options.resultId()),value:this._getResultFieldValue(results[i],this.options.resultValue()),category:this._generateEntryCategory(results[i])};list.insert({bottom:this._createDescendentBranch(data)})}return list.hasChildNodes()?list:new Element("div",{class:"descendents hint empty"}).update(this.options.noresults)},_createBranch:function(eltName,className,data,expandable){var element=new Element(eltName,{class:"entry "+className});element.__termId=data.id,element.__termCategory=data.category;var wrapper=new Element("div",{class:"entry-data"});wrapper.insert({bottom:this._generateEntryTitle(data.id,data.value)});var entryTools=new Element("span",{class:"entry-tools"});if(entryTools.observe("click",function(event){event.stop()}),wrapper.insert({bottom:entryTools}),element.update(wrapper),this._isRootEntry(element)||"browse"==this.options.defaultEntryAction&&wrapper.down(".info").observe("click",this._browseEntry.bindAsEventListener(this)),entryTools.insert(new Element("span",{class:"fa fa-info-circle phenotype-info xHelpButton",title:data.id})),this.options.enableSelection&&(element.__selectTool=new Element("input",{type:"checkbox",name:"term_selector",value:data.id,class:"select-tool"}),wrapper.insert({top:element.__selectTool}),this.options.isTermSelected(element.__termId)&&(element.addClassName("accepted"),element.__selectTool.checked="checked"),element.__selectTool.observe("click",this._toggleEntrySelection.bindAsEventListener(this)),"select"==this.options.defaultEntryAction&&wrapper.down(".info").observe("click",this._toggleEntrySelection.bindAsEventListener(this))),expandable){var expandTool=new Element("span",{class:"expand-tool"}).update(this._getExpandCollapseSymbol(!element.hasClassName("root")));expandTool.observe("click",function(event){var entry=event.element().up(".entry");this._isExpandToolLocked(entry)||this._toggleExpandState(entry)}.bindAsEventListener(this));var expandOnSelect=function(e){this._isExpandToolLocked(element)||"yes"!=e.memo.selected||this._expandEntry(element)};element.observe("obrowser:entry:selected",expandOnSelect.bindAsEventListener(this)),element.observe("ynpicker:selectionChanged",expandOnSelect.bindAsEventListener(this)),wrapper.insert({top:expandTool}),this.expand(element,element.hasClassName("root"))}return element},_generateEntryTitle:function(id,value){return new Element("span",{class:"info"}).insert({bottom:new Element("span",{class:"key"}).update("["+id+"]")}).insert({bottom:" "}).insert({bottom:new Element("span",{class:"value"}).update(value)})},_generateEntryCategory:function(xmlFragment){var category=new Element("span",{class:"hidden term-category"});return this.options.resultCategory&&this._getResultFieldValueAsArray(xmlFragment,this.options.resultCategory).each(function(c){category.insert(new Element("input",{type:"hidden",value:c}))}),category.hasChildNodes()?category:null},_expandEntry:function(target){target&&(target.down(".descendents")?Event.fire(target,"obrowser:expand:finished"):(target.down(".error")&&target.down(".error").remove(),this.expand(target,!0)),target.removeClassName("collapsed"),target.down(".expand-tool").update(this._getExpandCollapseSymbol(!1)))},_collapseEntry:function(target){target&&(target.addClassName("collapsed"),Event.fire(target,"obrowser:expand:finished"),target.down(".expand-tool").update(this._getExpandCollapseSymbol(!0)))},_toggleExpandState:function(target){target&&(!target.down(".descendents")||target.hasClassName("collapsed")?this._expandEntry(target):this._collapseEntry(target))},_obrowserExpandEventHandler:function(event){var element=event.element();if(event.memo){if(event.memo.data?(element.insert({bottom:event.memo.data}),element.stopObserving("obrowser:expand:done",this._obrowserExpandEventHandler)):void 0!==event.memo.count&&element.stopObserving("obrowser:count:done",this._obrowserExpandEventHandler),element.stopObserving("obrowser:expand:failed",this._obrowserExpandEventHandler),"0"==event.memo.count||!element.hasClassName("root")&&event.memo.data&&!element.down(".descendents .entry, .error")){element.addClassName("collapsed");var expandTool=element.down(".expand-tool");expandTool&&(expandTool.update(this._getExpandCollapseSymbol(!0)).addClassName("disabled"),expandTool.stopObserving("click"))}this._unlockExpandTool(element),Event.fire(document,"ms:popup:content-updated",{popup:this.container}),event.memo.data&&Event.fire(element,"obrowser:expand:finished")}},_lockExpandTool:function(element){var expandTool=element.down(".expand-tool");expandTool&&expandTool.addClassName("locked")},_unlockExpandTool:function(element){var expandTool=element.down(".expand-tool");expandTool&&expandTool.removeClassName("locked")},_isExpandToolLocked:function(element){return!!element.down(".expand-tool.locked")},_getExpandCollapseSymbol:function(isCollapsed){return isCollapsed?"&#x25ba;":"&#x25bc;"},_toggleEntrySelection:function(event){var trigger=event.element();if(!trigger.hasClassName("select-tool"))return void trigger.up(".entry").down("input").click();var elt=trigger.up(".entry");trigger.checked?this._selectEntry(elt):this._unselectEntry(elt)},_selectEntry:function(entry){if(this.suggest){if(this.options.modal&&"function"==typeof this.container.getPositionInViewport)var prevPosition=this.container.getPositionInViewport();var value=entry.down(".value").firstChild.nodeValue;this.suggest.acceptEntry({id:entry.__termId,value:value,category:entry.__termCategory,negative:entry.down(".selected.no")},value,"",!0),entry.addClassName("accepted"),prevPosition&&"function"==typeof this.container.positionDialogInViewport&&this.container.positionDialogInViewport(prevPosition.left,prevPosition.top),entry.fire("obrowser:entry:selected",{selected:entry.down(".selected.no")?"no":"yes"})}},_unselectEntry:function(entry){this.options.unselectTerm(entry.__termId),this.options.unselectTerm(entry.__termId,!0),entry.removeClassName("accepted")},_browseEntry:function(event){event.stop();var elt=event.element().up(".entry");this.load(elt.__termId)},_createParentBranch:function(parent){return parent=this._createBranch("li","parent",parent,!1)},_createRoot:function(data){var root=this._createBranch("div","root",data,!0);return this.options.showRoot||(root.addClassName("no-root"),root.down(".entry-data").addClassName("invisible")),root},_createDescendentBranch:function(data){return this._createBranch("li","descendent",data,!0)},_isRootEntry:function(element){return element.hasClassName("entry")&&element.hasClassName("root")},setContent:function(content){this.container.setContent(new Element("div",{class:"ontology-tree"}).update(content))},show:function(id){id&&(this.container.show(),this.__crtRoot!=id?this.load(id):Event.fire(this.container.contentContainer||document,"obrowser:expand:finished"))},hide:function(){this.container.close()}}),PhenoTips}(PhenoTips||{}))||{});StickyBox=Class.create({options:{offsetTop:6,offsetBottom:0,resize:!1,isSticky:function(element){return!0}},initialize:function(stickyElement,stickyAreaElement,options){this.stickyElement=stickyElement,this.stickyAreaElement=stickyAreaElement,this.stickyElement&&this.stickyAreaElement&&(this.options=Object.extend(Object.clone(this.options),options||{}),this.options.shadowSize&&void 0===options.offsetTop&&(this.options.offsetTop=this.options.shadowSize),this.resetPosition=this.resetPosition.bindAsEventListener(this),Event.observe(window,"scroll",this.resetPosition),Event.observe(window,"resize",this.resetPosition),"function"==typeof this.options.makeDefault&&(thid.makeDefault=this.options.makeDefault.bind(this)),this.resetPosition())},resetPosition:function(){if(this.options.isSticky(this.stickyElement)&&!(this.stickyElement.getHeight()>=this.stickyAreaElement.getHeight())){this.stickyElement.style.height="",this.stickyElement.style.overflow="",this.stickyElement.fire("size:changed"),this.boxHeight=this.stickyElement.getHeight();var maxBoxHeight=document.viewport.getHeight()-this.options.offsetTop-this.options.offsetBottom;if(this.options.resize){var memo={diff:maxBoxHeight-this.boxHeight,original:this.boxHeight};this.boxHeight=maxBoxHeight,this.stickyElement.style.height=this.boxHeight+"px",this.stickyElement.style.overflow="auto",this.stickyElement.fire("size:changed",memo)}this.boxWidth=this.stickyElement.getWidth(),this.boxMinTop=this.stickyAreaElement.cumulativeOffset().top+this.options.offsetTop,this.boxMaxTop=this.stickyAreaElement.cumulativeOffset().top+this.stickyAreaElement.getHeight()-this.boxHeight,this.boxLeft=this.stickyElement.cumulativeOffset().left,this.boxRelativeLeft=this.boxLeft-this.stickyElement.getOffsetParent().viewportOffset().left;var relativeContentPosition=this.stickyAreaElement.viewportOffset().top;this.direction=0,this.stickyAreaElement._prevPosition&&(this.stickyAreaElement._prevPosition>relativeContentPosition?this.direction=1:this.stickyAreaElement._prevPosition<relativeContentPosition&&(this.direction=-1)),(this.options.isSticky(this.stickyElement)||1==this.direction)&&document.viewport.getScrollOffsets().top>=this.boxMinTop&&document.viewport.getScrollOffsets().top<this.boxMaxTop?this.makeFixed():(this.options.isSticky(this.stickyElement)||-1==this.direction)&&document.viewport.getScrollOffsets().top>=this.boxMaxTop?this.makeAbsolute():this.makeDefault(),this.stickyAreaElement._prevPosition=relativeContentPosition}},makeFixed:function(){"fixed"!=this.stickyElement.style.position&&(this.stickyElement.addClassName("sticky"),this.stickyElement.style.left=this.boxLeft+"px",this.stickyElement.style.width=this.boxWidth+"px",this.stickyElement.style.top=this.options.offsetTop+"px",this.stickyElement.style.right="",this.stickyElement.style.position="fixed")},makeAbsolute:function(top){if("absolute"!=this.stickyElement.style.position){this.stickyElement.addClassName("sticky"),top=top||this.stickyAreaElement.getHeight()-this.stickyElement.getHeight(),this.stickyElement.style.top=top+"px",this.stickyElement.style.right="";var originalPosition=this.stickyElement.getStyle("position");this.stickyElement.style.position="absolute","fixed"!=originalPosition||Prototype.Browser.WebKit?this.stickyElement.style.left=this.boxRelativeLeft+"px":this.stickyElement.style.left=this.boxRelativeLeft-this.stickyElement.getOffsetParent().viewportOffset().left+2+"px"}},makeDefault:function(){""!=this.stickyElement.style.position&&(this.stickyElement.removeClassName("sticky"),this.stickyElement.style.position="",this.stickyElement.style.top="",this.stickyElement.style.left="",this.stickyElement.style.right="",this.stickyElement.style.width="")},isFixed:function(){return"fixed"==this.stickyElement.style.position},isAbsolute:function(){return"absolute"==this.stickyElement.style.position},isDefault:function(){return""==this.stickyElement.style.position}});var PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).FreeMultiselect=Class.create({counter:1,options:{returnKeyNavigation:!1},initialize:function(element,options){this.options=Object.extend(Object.clone(this.options),options||{});var _this=this,suggestInfoSource=element.previous('input[name="xwiki-free-multiselect-suggest-script"][type="hidden"]');if(suggestInfoSource&&suggestInfoSource.value&&void 0!==XWiki.widgets.Suggest&&(this.suggestOptions={script:suggestInfoSource.value,shownoresults:!1,varname:"input",timeout:0}),this.enhanceLine=this.enhanceLine.bind(this),element.select("li input.xwiki-free-multiselect-value").each(this.enhanceLine),element.down("input.xwiki-free-multiselect-value")){var addTool=new Element("a",{title:"add",href:"#"+element.id}).update("+...");element.insert(addTool.wrap("li")),addTool.observe("click",function(event){event.stop();var prevLine=addTool.up("li").previous(),template=prevLine&&prevLine.down("input.xwiki-free-multiselect-value");template&&_this.generateInput(template)}.bindAsEventListener(this))}},enhanceLine:function(element){element.id=this.generateId(element),element.up("li").addClassName("xwiki-free-multiselect-line"),this.attachDeleteTool(element),this.suggestOptions&&new XWiki.widgets.Suggest(element,this.suggestOptions),this.enableAddInput(element)},attachDeleteTool:function(element){var wrapper=element.up(".xwiki-free-multiselect-line"),deleteTool=new Element("a",{title:"delete",href:"#"+element.id}).update("✖");wrapper.insert(" ").insert(deleteTool),deleteTool.observe("click",function(event){event.stop();var wrapper=event.findElement(".xwiki-free-multiselect-line");if(wrapper.previous(".xwiki-free-multiselect-line")||wrapper.next(".xwiki-free-multiselect-line"))wrapper.remove();else{var target=wrapper.down("input");target.value="",target.focus()}})},enableAddInput:function(element){var wrapper=element.up(".xwiki-free-multiselect-line"),_this=this;wrapper&&element.observe("keypress",function(event){if(event.keyCode==Event.KEY_RETURN){event.stop();var next=wrapper.next(".xwiki-free-multiselect-line");_this.options.returnKeyNavigation&&next&&next.down("input")?next.down("input").focus():(element.next().removeClassName("inactive"),_this.generateInput(element))}else if(event.keyCode==Event.KEY_BACKSPACE&&""==element.value){event.stop();var previous=wrapper.previous(".xwiki-free-multiselect-line");previous&&previous.down("input")&&(previous.down("input").focus(),element.up(".xwiki-free-multiselect-line").remove())}})},generateInput:function(template){var newInput=new Element("input",{name:template.name,id:this.generateId(template),type:template.type,size:template.size,class:"xwiki-free-multiselect-value"}),newWrapper=new Element("li");newWrapper.insert(newInput),template.up(".xwiki-free-multiselect-line").insert({after:newWrapper}),this.enhanceLine(newInput),newInput.focus()},generateId:function(element){return element.name+"_"+this.nextIndex()},nextIndex:function(){return++this.counter},lastIndex:function(){return this.counter}}),PhenoTips}(PhenoTips||{});document.observe("xwiki:dom:loaded",function(){$$(".xwiki-free-multiselect").each(function(element){new PhenoTips.widgets.FreeMultiselect(element)})});var XWiki=function(XWiki){(XWiki.widgets=XWiki.widgets||{}).VisibilityController=Class.create({initialize:function(element){this.element=element,this.reverse=this.element.hasClassName("exclude"),this.controller=this.element.select(".controller input[type=checkbox]");var eventName="change";0!=this.controller.length&&(1==this.controller.length?this.controller=this.controller[0]:(this.controller=this.element.down(".controller .yes input[type=checkbox]"),eventName="picker:change"),this.controller&&(this.controlled=this.element.select(".controlled"),this.element.hasClassName("complete-hide")?(this.hiddenStyle={display:"none"},this.visibleStyle={display:""}):(this.hiddenStyle={visibility:"hidden"},this.visibleStyle={visibility:"visible"}),this.controlVisibility(),this.controller.observe(eventName,this.controlVisibility.bindAsEventListener(this))))},controlVisibility:function(){this.controller.checked^this.reverse?(this.controlled.invoke("setStyle",this.hiddenStyle),this.element.select(".controlled input").invoke("disable")):(this.controlled.invoke("setStyle",this.visibleStyle),this.element.select(".controlled input").invoke("enable"))}});var init=function(event){return(event&&event.memo.elements||[$("body")]).each(function(element){element.select(".controlled-group").each(function(group){group.__visibilityController||(group.__visibilityController=new XWiki.widgets.VisibilityController(group))})}),!0};return XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init),XWiki}(XWiki||{}),PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).UnitConverter=Class.create({CONVERSION_META:{weight:{imperial_units:["lb","oz"],metric_unit:"kg",inter_unit_scale:16,inter_system_scale:.0283495},length:{imperial_units:["ft","in"],metric_unit:"cm",inter_unit_scale:12,inter_system_scale:2.54}},DEFAULT_UNIT_SYSTEM:"metric",initialize:function(container,selector,triggerInsertionElt,triggerInsertionPosition,system){if(this._selector=selector,this._container=container||document.documentElement,this._selector&&triggerInsertionElt){this.crtUnitSystem=system||this.DEFAULT_UNIT_SYSTEM,this.initializeElements=this.initializeElements.bind(this),this.attachConverter=this.attachConverter.bind(this),this.generateTrigger(triggerInsertionElt,triggerInsertionPosition||"bottom"),this.initializeElements();var _this=this;document.observe("xwiki:dom:updated",function(event){event.memo&&event.memo.elements&&event.memo.elements.each(_this.initializeElements.bind(_this))})}},generateTrigger:function(atElement,position){this._trigger=new Element("select",{class:"unit-system-selector"});var optionMetric=new Element("option",{value:"metric"}).update("Metric units ("+this.CONVERSION_META.weight.metric_unit+", "+this.CONVERSION_META.length.metric_unit+")");"metric"==this.crtUnitSystem&&(optionMetric.selected="selected");var optionImperial=new Element("option",{value:"imperial"}).update("Imperial units ("+this.CONVERSION_META.weight.imperial_units.join(" / ")+", "+this.CONVERSION_META.length.imperial_units.join(" / ")+")");"imperial"==this.crtUnitSystem&&(optionImperial.selected="selected"),this._trigger.insert(optionMetric).insert(optionImperial),insertionInfo={},insertionInfo[position]=this._trigger,atElement.insert(insertionInfo);var _this=this;this._trigger.observe("change",function(event){_this.crtUnitSystem=_this._trigger.options[_this._trigger.selectedIndex].value,_this.switchUnits(_this.crtUnitSystem)})},initializeElements:function(element){container=element||this._container,container.__unitSwitcher||!container.up(".measurements")&&!container.hasClassName("measurements")||(container.__unitSwitcher=this,container.select(this._selector).each(this.attachConverter),this.switchUnits(this.crtUnitSystem,container))},switchUnits:function(type,element){container=element||this._container,container.select(".unit-conversion-values .unit-type").each(function(item){item.hasClassName(type)?item.show():item.hide()})},attachConverter:function(element){if("input"==element.tagName.toLowerCase()&&"text"==element.type){var unitElt=element.next(".unit"),converterElement=new Element("div",{class:"unit-conversion-values"}),type=element.up(".weight")?"weight":"length";converterElement.addClassName(type),converterElement._meta=this.CONVERSION_META[type];var values=this.metricToImperial(converterElement._meta,parseFloat(element.value)||0),metricZone=element.up(".metric");metricZone?(metricZone.addClassName("unit-type"),metricZone.insert({after:converterElement})):((metricZone=new Element("div",{class:"unit-type metric"})).insert(element).insert(unitElt||converterElement._meta.metric_unit),element.insert({after:converterElement}));var imperialZone=new Element("div",{class:"unit-type imperial"});converterElement.insert(metricZone).insert(imperialZone),converterElement._meta.imperial_units.each(function(unit){imperialZone.insert(new Element("label").insert(new Element("input",{style:"width: auto",name:unit,type:"text",size:3,value:values[unit]||""})).insert(unit))}),this.enableSyncValues(converterElement)}},enableSyncValues:function(element){var _this=this;element.select(".imperial input").invoke("observe","change",function(event){_this.syncMetricWithImperial(element)}),element.select(".metric input").invoke("observe","change",function(event){_this.syncImperialWithMetric(element)})},syncMetricWithImperial:function(element){var metricInput=element.down(".metric input");metricInput.value=this.imperialToMetric(element._meta,parseFloat(element.down('.imperial input[name="'+element._meta.imperial_units[0]+'"]').value)||0,parseFloat(element.down('.imperial input[name="'+element._meta.imperial_units[1]+'"]').value)||0)||"",Event.fire(metricInput,"phenotips:measurement-updated")},syncImperialWithMetric:function(element){var imperialValues=this.metricToImperial(element._meta,parseFloat(element.down(".metric input").value)||0);element._meta.imperial_units.each(function(unit){element.down('.imperial input[name="'+unit+'"]').value=imperialValues[unit]||""})},metricToImperial:function(conversionMeta,value){var result={},lowerUnitValue=value/conversionMeta.inter_system_scale,higherUnitValue=Math.floor(lowerUnitValue/conversionMeta.inter_unit_scale);return(lowerUnitValue-=higherUnitValue*conversionMeta.inter_unit_scale)&&(lowerUnitValue=lowerUnitValue.toFixed(2)),result[conversionMeta.imperial_units[0]]=higherUnitValue,result[conversionMeta.imperial_units[1]]=lowerUnitValue,result},imperialToMetric:function(conversionMeta,higherUnitValue,lowerUnitValue){return((conversionMeta.inter_unit_scale*higherUnitValue+lowerUnitValue)*conversionMeta.inter_system_scale).toFixed(2)}}),PhenoTips}(PhenoTips||{}),PhenoTips=function(PhenoTips){var widgets=PhenoTips.widgets=PhenoTips.widgets||{};widgets.FuzzyDatePickerDropdown=Class.create({initialize:function(options){this.span=new Element("span"),this.options=options,this.callback=null},populate:function(values){var selectedIndex=this.dropdown?this.dropdown.selectedIndex||this._tmpSelectedIndex:0,optionsHTML='<select name="'+this.options.name+'" class="'+(this.options.cssClass||this.options.name||"")+'" placeholder="'+(this.options.hint||this.options.name||"")+'" title="'+(this.options.hint||this.options.name||"")+'">';optionsHTML+='<option value="" class="empty"> </option>',values.each(function(item){optionsHTML+='<option value="'+item.value+'"',item.cssClass&&(optionsHTML+=' class="'+item.cssClass+'"'),item.selected&&(optionsHTML+=' selected="selected"'),optionsHTML+=">"+(item.text||item.value||"")+"</option>"}),optionsHTML+="</select>",this.span.innerHTML=optionsHTML,this.dropdown=this.span.firstChild,this.callback&&this.onSelect(this.callback),this.dropdown.selectedIndex<=0&&selectedIndex>=0&&selectedIndex<this.dropdown.options.length&&(this.dropdown.selectedIndex=selectedIndex)},enable:function(){return this.dropdown.enable(),this.dropdown.selectedIndex<=0&&this._tmpSelectedIndex<this.dropdown.options.length&&(this.dropdown.selectedIndex=this._tmpSelectedIndex,this._tmpSelectedIndex>0)},disable:function(){this.dropdown.disable(),this._tmpSelectedIndex=this.dropdown.selectedIndex,this.dropdown.selectedIndex=0},getElement:function(){return this.span},onSelect:function(callback){var _this=this;this.callback=callback;var events=["change"];browser.isGecko&&events.push("keyup"),events.each(function(eventName){_this.dropdown.observe(eventName,function(){callback(),_this._tmpSelectedIndex=_this.dropdown.selectedIndex})})},onFocus:function(callback){var _this=this;this.dropdown.observe("focus",function(){callback(),-1==_this.dropdown.selectedIndex&&_this._tmpSelectedIndex<_this.dropdown.options.size()&&(_this.dropdown.selectedIndex=_this._tmpSelectedIndex)})},onBlur:function(callback){this.dropdown.observe("blur",callback)},getSelectedValue:function(){return this.dropdown.selectedIndex>=0?this.dropdown.options[this.dropdown.selectedIndex].value:""},getSelectedOption:function(){return this.dropdown.selectedIndex>=0?this.dropdown.options[this.dropdown.selectedIndex].innerHTML:""}}),widgets.FuzzyDatePicker=Class.create({initialize:function(input){if(input){if(this.__input=input,this.__input.hide(),this.__fuzzyInput=$(this.__input.name+"_entered"),this.__fuzzyInput&&(this.__recordBoth=!0),this.__fuzzyInput&&this.__fuzzyInput.value)this.__date=JSON.parse(this.__fuzzyInput.value||"{}");else if(this.__input.alt){var parsedDate=new Date(this.__input.alt);this.__date={year:parsedDate.getUTCFullYear(),month:parsedDate.getUTCMonth()+1,day:parsedDate.getUTCDate()}}else this.__date={};this.container=new Element("div",{class:"fuzzy-date-picker"}),this.__input.insert({before:this.container});for(var format=(this.__input.title||"yyyy-MM-dd").split(/\W+/),i=0;i<format.length;++i)switch(format[i][0]){case"y":this.container.insert(this.createYearDropdown());break;case"M":this.container.insert(this.createMonthDropdown());break;case"d":this.container.insert(this.createDayDropdown())}this.container.observe("datepicker:date:changed",this.onProgrammaticUpdate.bind(this)),this.onProgrammaticUpdate()}},onProgrammaticUpdate:function(){this.yearSelected(),this.monthSelected(),this.updateDate()},createYearDropdown:function(){this.yearSelector=new widgets.FuzzyDatePickerDropdown({name:"year"});for(var values=[],y=(new Date).getYear()+1900;y>=1900;--y)values.push({value:y,selected:this.__date.year==y}),y%10==0&&values.push({value:y+"s",cssClass:"decade",text:y+"s",selected:this.__date.decade==y+"s"});return values.push({value:"1800s",cssClass:"decade",selected:"1800s"==this.__date.decade}),values.push({value:"1700s",cssClass:"decade",selected:"1700s"==this.__date.decade}),values.push({value:"1600s",cssClass:"decade",selected:"1600s"==this.__date.decade}),this.yearSelector.populate(values),this.yearSelector.onSelect(this.yearSelected.bind(this)),this.yearSelector.getElement()},yearSelected:function(){this.yearSelector&&(this.yearSelector.getSelectedValue()>0&&this.monthSelector&&this.monthSelected(),this.updateDate())},createMonthDropdown:function(){return this.monthSelector=new widgets.FuzzyDatePickerDropdown({name:"month"}),this.monthSelector.populate(this.getZeroPaddedValueRange(1,12,this.__date.month)),this.monthSelector.onSelect(this.monthSelected.bind(this)),this.monthSelector.getElement()},monthSelected:function(){this.monthSelector&&(this.monthSelector.getSelectedValue()>0&&this.daySelector&&this.daySelector.populate(this.getAvailableDays()),this.updateDate())},createDayDropdown:function(){return this.daySelector=new widgets.FuzzyDatePickerDropdown({name:"day"}),this.daySelector.populate(this.getZeroPaddedValueRange(1,31,this.__date.day)),this.daySelector.onSelect(this.updateDate.bind(this)),this.daySelector.getElement()},getAvailableDays:function(){var year=1*this.yearSelector.getSelectedValue(),month=1*this.monthSelector.getSelectedValue(),lastDayOfMonth=0;return[1,3,5,7,8,10,12].indexOf(month)>=0?lastDayOfMonth=31:[4,6,9,11].indexOf(month)>=0?lastDayOfMonth=30:2==month&&(lastDayOfMonth=year%4!=0||year%100==0&&year%400!=0?28:29),this.getZeroPaddedValueRange(1,lastDayOfMonth)},getZeroPaddedValue:function(value){return value?("0"+value).slice(-2):"01"},getZeroPaddedValueRange:function(start,end,selected){var values=[];if(start<=end)for(v=start;v<=end;++v)values.push({value:v,text:("0"+v).slice(-2),selected:selected==v});else for(var v=end;v<=start;--v)values.push({value:v,text:("0"+v).slice(-2),selected:selected==v});return values},updateDate:function(){var dateObject={},y=this.yearSelector.getSelectedValue();if(y.match(/\d\d\d\ds$/)?dateObject.decade=y:""!=y&&(dateObject.year=y),y>0){var m=this.monthSelector&&this.monthSelector.getSelectedValue();if(m>0){dateObject.month=this.monthSelector.getSelectedOption();var d=this.daySelector&&this.daySelector.getSelectedValue();d>0&&(dateObject.day=this.daySelector.getSelectedOption())}}var newValue=JSON.stringify(dateObject);if(this.__recordBoth)newValue!=(oldValue=this.__fuzzyInput.value)&&(this.__fuzzyInput.value=JSON.stringify(dateObject),this.__input.value=y&&!y.match(/\d\d\d\ds$/)?y+"-"+this.getZeroPaddedValue(m)+"-"+this.getZeroPaddedValue(d):"",this.__input.alt=y&&!y.match(/\d\d\d\ds$/)?y+"-"+this.getZeroPaddedValue(m)+"-"+this.getZeroPaddedValue(d)+"T00:00:00Z":"",this.__input.fire("xwiki:date:changed"));else{var oldValue=this.__input.value;newValue!=oldValue&&(this.__input.value=JSON.stringify(dateObject),this.__input.alt=y&&!y.match(/\d\d\d\ds$/)?y+"-"+this.getZeroPaddedValue(m)+"-"+this.getZeroPaddedValue(d)+"T00:00:00Z":"",this.__input.fire("xwiki:date:changed"))}}});var init=function(event){return(event&&event.memo.elements||[$("body")]).each(function(element){(element.hasClassName("fuzzy-date")?[element]:element.select(".fuzzy-date")).each(function(dateInput){dateInput.__datePicker||(dateInput.__datePicker=new PhenoTips.widgets.FuzzyDatePicker(dateInput))})}),!0};return XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init),PhenoTips}((PhenoTips=function(PhenoTips){(PhenoTips.widgets=PhenoTips.widgets||{}).HelpButton=Class.create({infoServices:{xHelpButton:{hint:$services.localization.render("phenotips.widgets.helpButtons.xHelpButton.hint"),callback:function(helpButton){helpButton.helpBox.content.update(helpButton._information||"")}},"phenotype-info":{hint:$services.localization.render("phenotips.widgets.helpButtons.phenotype.hint"),service:"$xwiki.getURL('PhenoTips.PhenotypeInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.id)).insert(" ").insert(elt("span","value").update(json.label))),json.def&&c.insert(elt("p").update(json.def.replace(/\s*\n\s*/," ").replace(/`([^`]+)`\s+\(([A-Z]+:[0-9]+)`?\)/g,'<em title="$2">$1</em>')));var labels={synonym:$services.localization.render("phenotips.widgets.helpButtons.phenotype.synonym"),is_a:$services.localization.render("phenotips.widgets.helpButtons.phenotype.typeOf")},advancedInfo=elt("dl");for(var l in labels)json[l]&&(advancedInfo.insert(elt("dt","",labels[l])),json[l].each(function(item){advancedInfo.insert(elt("dd","",item.label||item))}));if(advancedInfo.firstDescendant()&&c.insert(advancedInfo),PhenoTips.widgets.OntologyBrowser){var browseButton=new Element("a",{class:"button",href:"#"}).update($services.localization.render("phenotips.widgets.helpButtons.phenotype.browseRelated"));browseButton._id=json.id,browseButton.observe("click",function(event){event.stop();var suggest=($("quick-phenotype-search")||$$("input.suggestHpo")[0])._suggest,params={};"undefined"!=typeof isPhenotypeSelected&&(params={isTermSelected:isPhenotypeSelected,unselectTerm:unselectPhenotype}),browseButton._obrowser=new PhenoTips.widgets.OntologyBrowser(suggest,null,params),browseButton._obrowser.show(browseButton._id)}),c.insert(elt("div","term-tools").insert(browseButton.wrap("span",{class:"buttonwrapper"})))}}},"phenotype-qualifier-info":{hint:$services.localization.render("phenotips.widgets.helpButtons.phenotypeQualifier.hint"),service:"$xwiki.getURL('PhenoTips.PhenotypeInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.id)).insert(" ").insert(elt("span","value").update(json.label))),json.def&&c.insert(elt("p").update(json.def.replace(/\s*\n\s*/," ").replace(/`([^`]+)`\s+\(([A-Z]+:[0-9]+)`?\)/g,'<em title="$2">$1</em>')))}},"omim-disease-info":{hint:"About this disease",service:"$xwiki.getURL('PhenoTips.OmimInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.id)).insert(" ").insert(elt("span","value").update(json.label.splice(0,1)[0])));var labels={label:"",symptoms:$services.localization.render("phenotips.widgets.helpButtons.omimDisease.symptoms"),not_symptoms:$services.localization.render("phenotips.widgets.helpButtons.omimDisease.notSymptoms")},advancedInfo=elt("dl");for(var l in labels)json[l]&&json[l].length>0&&(advancedInfo.insert(elt("dt","",labels[l])),json[l].each(function(item){advancedInfo.insert(elt("dd","",item.label||item))}));advancedInfo.firstDescendant()&&c.insert(advancedInfo);var viewButton=new Element("a",{class:"button",href:"http://www.omim.org/entry/"+json.id,target:"_blank"}).update($services.localization.render("phenotips.widgets.helpButtons.omimDisease.linkToOmim"));if(c.insert(elt("div","term-tools").insert(viewButton.wrap("span",{class:"buttonwrapper"}))),viewButton.observe("click",function(event){event.stop(),window.open(viewButton.href)}),json.gene_reviews_link){var geneReviewsButton=new Element("a",{class:"button",href:json.gene_reviews_link,target:"_blank"}).update("Read about it on Gene Reviews...");c.insert(elt("div","term-tools").insert(geneReviewsButton.wrap("span",{class:"buttonwrapper"}))),geneReviewsButton.observe("click",function(event){event.stop(),window.open(geneReviewsButton.href)})}}},"gene-info":{hint:$services.localization.render("phenotips.widgets.helpButtons.gene.hint"),service:"$xwiki.getURL('PhenoTips.GeneInfoService', 'get')",callback:function(helpButton,json){var c=helpButton.helpBox.content,elt=function(type,cssClass,content){return new Element(type,cssClass&&{class:cssClass}||{}).update(content||"")};c.update(elt("span","info").insert(elt("span","key").update(json.symbol)).insert(" ").insert(elt("span","value").update(json.name)));var labels={alias_symbol:$services.localization.render("phenotips.widgets.helpButtons.gene.alias"),prev_symbol:$services.localization.render("phenotips.widgets.helpButtons.gene.previousSymbols"),gene_family:$services.localization.render("phenotips.widgets.helpButtons.gene.family")},advancedInfo=elt("dl");for(var l in labels)json[l]&&json[l].length>0&&(advancedInfo.insert(elt("dt","",labels[l])),"[object Array]"===Object.prototype.toString.call(json[l])?json[l].each(function(item){advancedInfo.insert(elt("dd","",item.label||item))}):advancedInfo.insert(elt("dd","",json[l])));if(advancedInfo.firstDescendant()&&c.insert(advancedInfo),json.external_ids){var tools=elt("div","term-tools");[{name:"GENECARDS",url:"http://www.genecards.org/cgi-bin/carddisp.pl?gene=",field:"genecards_id"},{name:"OMIM",url:"http://www.omim.org/entry/",field:"omim_id"},{name:"Entrez",url:"http://www.ncbi.nlm.nih.gov/gene/?term=",field:"entrez_id"},{name:"RefSeq",url:"http://www.ncbi.nlm.nih.gov/nuccore/",field:"refseq_accession"},{name:"Ensembl",url:"http://useast.ensembl.org/Homo_sapiens/Gene/Compara_Tree?g=",field:"ensembl_gene_id"}].each(function(item){var value=json.external_ids[item.field];value&&(value.each||(value=[value]),value.each(function(id){tools.insert(new Element("a",{href:item.url+id,class:"button"}).update(item.name+": "+id).wrap("span",{class:"buttonwrapper"}))}))}),tools.select("a").each(function(item){item.observe("click",function(event){event.stop(),window.open(item.href)})}),c.insert(tools)}}}},initialize:function(icon){this.icon=icon,this._information=this.icon._information||this.icon.title;for(var label in this.infoServices)this.icon.hasClassName(label)&&(this._builder=this.infoServices[label],this.icon.title=this.infoServices[label].hint||"");this._builder&&(this.icon.observe("click",this.toggleHelp.bindAsEventListener(this)),this.hideAllHelpOnOutsideClick=this.hideAllHelpOnOutsideClick.bindAsEventListener(this))},toggleHelp:function(){!this.helpBox||this.helpBox.hasClassName("hidden")?(this.showHelp(),document.observe("click",this.hideAllHelpOnOutsideClick)):this.hideHelp()},hideAllHelpOnOutsideClick:function(event){event.findElement(".xTooltip")||event.findElement(".xHelpButton")||(this.hideHelp(),document.stopObserving("click",this.hideAllHelpOnOutsideClick))},hideHelp:function(event){event&&event.stop(),this.helpBox&&(this.helpBox.hasClassName("error")?(this.helpBox.remove(),delete this.helpBox):this.helpBox.addClassName("hidden"))},showHelp:function(){this.helpBox||this.createHelpBox(),$$("div.xTooltip:not(.hidden)").invoke("_hideHelp"),this.helpBox.removeClassName("hidden")},createHelpBox:function(){this.helpBox=new Element("div",{class:"hidden xTooltip"}),this.helpBox._behavior=this,this.helpBox._hideHelp=function(){this._behavior.hideHelp()}.bind(this.helpBox),this.helpBox.content=new Element("div"),this.helpBox.insert(this.helpBox.content),this._builder.service?this.createHelpContentFromService():this._builder.callback&&this._builder.callback(this);var closeButton=new Element("span",{class:"hide-tool",title:"Hide"});closeButton.update("×"),closeButton.observe("click",this.hideHelp.bindAsEventListener(this)),this.helpBox.insert({top:closeButton}),this.icon.insert({after:this.helpBox})},createHelpContentFromService:function(){var _this=this;new Ajax.Request(_this._builder.service,{parameters:{id:_this._information},onCreate:function(){_this.helpBox.content.update(new Element("span",{class:"hint temporary"}).update($services.localization.render("phenotips.widgets.helpButtons.loading")))},onSuccess:function(response){_this._builder.callback(_this,response.responseJSON)},onFailure:function(response){_this.helpBox.addClassName("error"),_this.helpBox.down(".temporary").remove(),_this.helpBox.insert($services.localization.render("phenotips.widgets.helpButtons.failedToLoad").replace("__subject__",_this._information)+" : "+response.statusText)}})}});var init=function(event){return(event&&event.memo.elements||[$("body")]).each(function(element){(element.hasClassName("xHelpButton")?[element]:element.select(".xHelpButton")).each(function(icon){icon.__helpController||(icon.__helpController=new PhenoTips.widgets.HelpButton(icon))})}),!0};return XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init),PhenoTips}(PhenoTips||{}))||{});!function(){var init=function(event){(event&&event.memo.elements||[$("body")]).each(function(container){container.select("input.suggestWorkgroups").each(function(input){if(!input.hasClassName("initialized")){var options={script:new XWiki.Document("SuggestWorkgroupsService","PhenoTips").getURL("get","outputSyntax=plain&"),noresults:$services.localization.render("phenotips.widgets.workgroupPicker.noResults")};input.hasClassName("global")&&(options.script=options.script+"wiki=global&"),new XWiki.widgets.UserPicker(input,options),input.addClassName("initialized")}})})};XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),document.observe("xwiki:dom:updated",init)}();var PhenoTips=function(PhenoTips){var widgets=PhenoTips.widgets=PhenoTips.widgets||{};return void 0===XWiki.widgets.XList?"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("[Suggest widget] Required class missing: XWiki.widgets.XList"):(widgets.XList=XWiki.widgets.XList,widgets.XListItem=XWiki.widgets.XListItem,widgets.Suggest=Class.create({options:{minchars:1,method:"get",varname:"input",className:"ajaxsuggest",timeout:2500,delay:500,offsety:0,shownoresults:!0,noresults:"No results!",maxheight:250,cache:!1,seps:"",icon:null,resultsParameter:function(){return"results"},resultId:function(){return"id"},resultValue:function(){return"value"},resultInfo:"info",resultCategory:"category",resultAltName:"",resultIcon:"icon",resultHint:"hint",tooltip:!1,highlight:!0,fadeOnClear:!0,enableHideButton:!0,insertBeforeSuggestions:null,displayId:!1,displayValue:!1,displayValueText:"Value :",align:"left",unifiedLoader:!1,loaderNode:null,filterFunc:null},sInput:"",nInputChars:0,aSuggestions:[],iHighlighted:null,isActive:!1,resultTotal:0,resultPage:-1,resultLimit:10,resultHasMore:!1,initialize:function(fld,param){if(!fld)return!1;this.setInputField(fld),this.options=Object.extend(Object.clone(this.options),param||{}),"object"==typeof this.options.sources&&this.options.sources.length>1?this.sources=this.options.sources:this.sources=this.options,this.sources=[this.sources].flatten().compact(),$(this.options.parentContainer)||(this.options.parentContainer=$(document.body)),this.options.seps?this.seps=this.options.seps:this.seps="",this.latestRequest=0},setInputField:function(input){this.fld&&this.fld.stopObserving(),this.fld=$(input),this.fld._suggestWidget=this,this.fld.observe("keyup",this.onKeyUp.bindAsEventListener(this)),Prototype.Browser.IE||Prototype.Browser.WebKit?this.fld.observe("keydown",this.onKeyPress.bindAsEventListener(this)):this.fld.observe("keypress",this.onKeyPress.bindAsEventListener(this)),this.fld.observe("paste",this.onPaste.bindAsEventListener(this)),this.fld.setAttribute("autocomplete","off"),this.fld.observe("blur",function(event){this.latestRequest++}.bind(this))},onKeyUp:function(event){switch(event.keyCode){case Event.KEY_RETURN:case Event.KEY_ESC:case Event.KEY_UP:case Event.KEY_DOWN:break;default:if(this.seps){for(var lastIndx=-1,i=0;i<this.seps.length;i++)this.fld.value.lastIndexOf(this.seps.charAt(i))>lastIndx&&(lastIndx=this.fld.value.lastIndexOf(this.seps.charAt(i)));-1==lastIndx?this.getSuggestions(this.fld.value):this.getSuggestions(this.fld.value.substring(lastIndx+1))}else this.getSuggestions(this.fld.value)}},onPaste:function(event){setTimeout(function(){this.onKeyUp({keyCode:null})}.bind(this),0)},onKeyPress:function(event){if(!$(this.isActive))return void(event.keyCode==Event.KEY_RETURN&&Event.stop(event));var key=event.keyCode;switch(key){case Event.KEY_RETURN:this.setHighlightedValue(),Event.stop(event);break;case Event.KEY_ESC:this.clearSuggestions(),Event.stop(event);break;case Event.KEY_UP:case Event.KEY_DOWN:this.changeHighlight(key),Event.stop(event)}},getSuggestions:function(val){if((val=val.strip().toLowerCase())==this.sInput&&val.length>1)return!1;if(0==val.length)return this.sInput="",this.clearSuggestions(),!1;if(val.length<this.options.minchars)return this.sInput="",!1;if(val.length>this.nInputChars&&this.aSuggestions.length&&this.options.cache){for(var arr=[],i=0;i<this.aSuggestions.length;i++)this.aSuggestions[i].value.substr(0,val.length).toLowerCase()==val&&arr.push(this.aSuggestions[i]);return this.sInput=val,this.nInputChars=val.length,this.aSuggestions=arr,this.createList(this.aSuggestions),!1}this.resultPage=-1,this.sInput=val,this.nInputChars=val.length,this.container=this.prepareContainer();var pointer=this,requestId=++this.latestRequest;return clearTimeout(this.ajID),this.ajID=setTimeout(function(){pointer.doAjaxRequests(requestId)},this.options.delay),!1},doAjaxRequests:function(requestId){if(!(this.fld.value.length<this.options.minchars))for(var i=0;i<this.sources.length;i++){var source=this.sources[i],query=this.fld.value.strip(),parameters={};null!=this.options.queryProcessor&&"function"==typeof this.options.queryProcessor.generateParameters&&(parameters=this.options.queryProcessor.generateParameters(query)),null!=this.options.queryProcessor&&"function"==typeof this.options.queryProcessor.processQuery&&(query=this.options.queryProcessor.processQuery(query));var url="";url=void 0!=source.scriptFunction&&"function"==typeof source.scriptFunction?source.scriptFunction()+source.varname+"="+encodeURIComponent(query):source.script+source.varname+"="+encodeURIComponent(query);var method=source.method||"get",headers={};source.json?headers.Accept="application/json":headers.Accept="application/xml";var _GELThisAjaxCall=this;_GELThisAjaxCall.options.resultUsePagination&&_GELThisAjaxCall.options.resultUsePagination()&&(this.resultPage=this.resultPage+1,url=url+"&page="+this.resultPage+"&limit="+this.resultLimit);new Ajax.Request(url,{method:method,parameters:parameters,requestHeaders:headers,onCreate:function(){this.fld.addClassName("loading")}.bind(this),onSuccess:function(_GELResult){if(_GELThisAjaxCall.options.resultUsePagination&&_GELThisAjaxCall.options.resultUsePagination()){var result=_GELResult.responseJSON;_GELThisAjaxCall.resultHasMore=result.more,_GELThisAjaxCall.resultTotal=result.total,result.more?_GELThisAjaxCall.updateLoadMore(_GELThisAjaxCall.resultPage,_GELThisAjaxCall.resultLimit,_GELThisAjaxCall.resultTotal):_GELThisAjaxCall.hideLoadMore()}_GELThisAjaxCall.setSuggestions(_GELResult,source,requestId)},onFailure:function(response){alert("Failed to retrieve suggestions : "+response.statusText)},onComplete:function(){requestId<this.latestRequest||this.fld.removeClassName("loading")}.bind(this)})}},setSuggestions:function(req,source,requestId){requestId<this.latestRequest||(this.aSuggestions=this.getSuggestionList(req,source),this.createList(this.aSuggestions,source))},getSuggestionList:function(req,source){var aSuggestions=[];if(source&&source.json){var jsondata=req.responseJSON;if(!jsondata)return!1;var results=jsondata[source.resultsParameter()||this.options.resultsParameter()],_getResultFieldValue=function(data,fieldName){return data&&data[fieldName]||""},_getResultFieldValueAsArray=function(data,fieldName){return new Array(data&&data[fieldName]||"").flatten()}}else{var xmldata=req.responseXML;if(!xmldata)return!1;var results=xmldata.getElementsByTagName(source&&source.resultsParameter()||this.options.resultsParameter()),_getResultFieldValue=function(data,selector){var element=data&&Element.down(data,selector);return element&&element.firstChild&&element.firstChild.nodeValue||""},_getResultFieldValueAsArray=function(data,selector){var result=new Array;return data&&Element.select(data,selector).each(function(item){var value=item.firstChild&&item.firstChild.nodeValue;value&&result.push(value)}),result}}for(var _getExpandCollapseTriggerSymbol=function(isCollapsed){return isCollapsed?"&#x25B8;":"&#x25BE;"},i=0;i<results.length;i++){var info=new Element("dl");for(var section in this.options.resultInfo){var sOptions=this.options.resultInfo[section];sectionClass=section.strip().toLowerCase().replace(/[^a-z0-9 ]/gi,"").replace(/\s+/gi,"-");var sectionState="";sOptions.collapsed&&(sectionState="collapsed");var processingFunction=sOptions.processor;if(sOptions.extern){var trigger=new Element("a").update(section);trigger._processingFunction=processingFunction,info.insert({bottom:new Element("dt",{class:sectionState+" "+sectionClass}).insert({bottom:trigger})}),trigger._processingFunction.call(this,trigger)}else{var selector=sOptions.selector;if(selector){var sectionContents=null;_getResultFieldValueAsArray(results[i],selector).each(function(item){var text=item||"";if("function"==typeof processingFunction&&(text=processingFunction(text)),""!=text){if(!sectionContents){var trigger=new Element("a",{class:"expand-tool"}).update(_getExpandCollapseTriggerSymbol(sOptions.collapsed));info.insert({bottom:new Element("dt",{class:sectionState}).insert({top:trigger}).insert({bottom:section})}),sectionContents=new Element("dd",{class:"expandable"}),info.insert({bottom:sectionContents}),trigger.observe("click",function(event){event.stop(),trigger.up().toggleClassName("collapsed"),trigger.update(_getExpandCollapseTriggerSymbol(trigger.up().hasClassName("collapsed")))}.bindAsEventListener(this))}sectionContents.insert({bottom:new Element("div").update(text)})}})}}}if(info.hasChildNodes()||(info=""),this.options.resultCategory){var category=new Element("span",{class:"hidden term-category"});_getResultFieldValueAsArray(results[i],this.options.resultCategory).each(function(c){category.insert(new Element("input",{type:"hidden",value:c}))})}if(this.options.resultCategory&&category.hasChildNodes()||(category=""),this.options.resultAltName)for(var bestNameMatch="",name=_getResultFieldValue(results[i],source.resultValue()||this.options.resultValue()),altNames=_getResultFieldValueAsArray(results[i],source.resultAltName||this.options.resultAltName),nameMatchScore=this.computeSimilarity(name,this.sInput),k=0;k<altNames.length;++k){var altNameMatchScore=this.computeSimilarity(altNames[k],this.sInput);altNameMatchScore>nameMatchScore&&(bestNameMatch=altNames[k],nameMatchScore=altNameMatchScore)}aSuggestions.push({id:_getResultFieldValue(results[i],source.resultId()||this.options.resultId()),value:_getResultFieldValue(results[i],source.resultValue()||this.options.resultValue()),valueAll:results[i],altName:bestNameMatch,info:info,category:category})}return aSuggestions},computeSimilarity:function(str1,str2){var score,maxSoFar=0,a=str1,m=a.length,b=str2,n=b.length,d=new Array;for(i=0;i<n;i++)d[i]=new Array,score=a.charAt(i)==b.charAt(0)?1:-1,0==i?d[0][0]=Math.max(0,-2,score):d[i][0]=Math.max(0,d[i-1][0]-2,score),d[i][0]>maxSoFar&&(maxSoFar=d[i][0]);for(j=0;j<m;j++)score=a.charAt(0)==b.charAt(j)?1:-1,0==j?d[0][0]=Math.max(0,-2,score):d[0][j]=Math.max(0,d[0][j-1]-2,score),d[0][j]>maxSoFar&&(maxSoFar=d[0][j]);for(i=1;i<n;i++)for(j=1;j<m;j++)score=a.charAt(i)==b.charAt(j)?1:-1,d[i][j]=Math.max(0,d[i-1][j]-2,d[i][j-1]-2,d[i-1][j-1]+score),d[i][j]>maxSoFar&&(maxSoFar=d[i][j]);return maxSoFar},prepareContainer:function(){var crtContainer=$(this.options.parentContainer).down(".suggestItems");if(crtContainer&&crtContainer.__targetField!=this.fld&&(crtContainer.__targetField?crtContainer.__targetField._suggest.clearSuggestions():crtContainer.remove(),crtContainer=!1),!crtContainer){var div=new Element("div",{class:"suggestItems "+this.options.className}),pos="body"==$(this.options.parentContainer).tagName.toLowerCase()?this.fld.cumulativeOffset():this.fld.positionedOffset(),containerWidth=this.options.width?this.options.width:this.fld.offsetWidth-2;"left"==this.options.align?div.style.left=pos.left+"px":"center"==this.options.align?div.style.left=pos.left+(this.fld.getWidth()-containerWidth-2)/2+"px":div.style.left=pos.left-containerWidth+this.fld.offsetWidth-2+"px",div.style.top=pos.top+this.fld.offsetHeight+this.options.offsety+"px",div.style.width=containerWidth+"px";var pointer=this;div.onmouseover=function(){pointer.killTimeout()},div.onmouseout=function(){pointer.resetTimeout()},this.resultContainer=new Element("div",{class:"resultContainer"}),div.appendChild(this.resultContainer),$(this.options.parentContainer).insert(div),this.container=div,this.options.insertBeforeSuggestions&&this.resultContainer.insert(this.options.insertBeforeSuggestions),document.fire("ms:suggest:containerCreated",{container:this.container,suggest:this})}if(this.sources.length>1)for(var i=0;i<this.sources.length;i++){var source=this.sources[i];if(source.id=i,this.resultContainer.down(".results"+source.id))this.resultContainer.down(".results"+source.id).down("ul")&&this.resultContainer.down(".results"+source.id).down("ul").remove(),this.options.unifiedLoader?((this.options.loaderNode||this.fld).addClassName("loading"),this.resultContainer.down(".results"+source.id).addClassName("hidden loading")):this.resultContainer.down(".results"+source.id).down(".sourceContent").addClassName("loading");else{var sourceContainer=new Element("div",{class:"results results"+source.id}),sourceHeader=new Element("div",{class:"sourceName"});if(this.options.unifiedLoader&&sourceContainer.addClassName("hidden loading"),void 0!==source.icon){var iconImage=new Image;iconImage.onload=function(){this.sourceHeader.setStyle({backgroundImage:"url("+this.iconImage.src+")"}),this.sourceHeader.setStyle({textIndent:this.iconImage.width+6+"px"})}.bind({sourceHeader:sourceHeader,iconImage:iconImage}),iconImage.src=source.icon}sourceHeader.insert(source.name),sourceContainer.insert(sourceHeader);var classes="sourceContent "+(this.options.unifiedLoader?"":"loading");sourceContainer.insert(new Element("div",{class:classes})),void 0!==source.before&&this.resultContainer.insert(source.before),this.resultContainer.insert(sourceContainer),void 0!==source.after&&this.resultContainer.insert(source.after)}}else this.resultContainer.down("ul")&&this.resultContainer.down("ul").remove();this.container.fire("ms:suggest:containerPrepared",{container:this.container,suggest:this});return this.container.__targetField=this.fld,this.options.enableHideButton&&!this.container.down(".hide-button")&&!!this.options.resultUsePagination&&this.options.resultUsePagination()&&(hideButton=new Element("span",{class:"hide-button loadMore",style:"float:left;"}).update("Load more"),hideButton.observe("click",this.loadMode.bindAsEventListener(this)),this.container.insert({bottom:new Element("div",{class:"hide-button-wrapper"}).update(hideButton)})),this.container},hideLoadMore:function(){var container=this.container;container&&container.select("span.loadMore").length>0&&container.select("span.loadMore")[0].hide()},updateLoadMore:function(page,limit,total){var container=this.container,loadMoreSpan=container.select("span.loadMore");container&&loadMoreSpan.length>0&&loadMoreSpan[0].update("("+10*(page+1)+"/"+total+") Load more")},loadMode:function(){var val=this.fld.value;this.sInput=val,this.nInputChars=val.length;var pointer=this,requestId=++this.latestRequest;return clearTimeout(this.ajID),this.ajID=setTimeout(function(){pointer.doAjaxRequests(requestId)},this.options.delay),!1},createList:function(arr,source){this.isActive=!0;pointer=this;if(this.killTimeout(),this.clearHighlight(),this.sources.length>1){div=this.resultContainer.down(".results"+source.id);(arr.length>0||this.options.shownoresults)&&(div.down(".sourceContent").removeClassName("loading"),this.resultContainer.down(".results"+source.id).removeClassName("hidden loading")),this.options.unifiedLoader&&!this.resultContainer.down("loading")&&(this.options.loaderNode||this.fld).removeClassName("loading")}else var div=this.resultContainer;if(0==arr.length&&!this.options.shownoresults)return!1;var list=void 0;if(div.down("ul")){for(var oldUL=div.down("ul"),newUL=this.createListElement(arr,pointer),i=0;i<newUL.select("li").length;i++)oldUL.appendChild(newUL.select("li")[i]);list=oldUL}else list=this.createListElement(arr,pointer),div.appendChild(list);Event.fire(document,"xwiki:dom:updated",{elements:[list]}),this.suggest=div;var pointer=this;this.options.timeout>0&&(this.toID=setTimeout(function(){pointer.clearSuggestions()},this.options.timeout)),this.highlightFirst()},createListElement:function(arr,pointer){var list=new PhenoTips.widgets.XList([],{icon:this.options.icon,classes:"suggestList",eventListeners:{click:function(){return pointer.setHighlightedValue(),!1},mouseover:function(){pointer.setHighlight(this.getElement())}}});if(this.fld.hasClassName("accept-value")){var customItemId=this.fld.value.replace(/[^a-z0-9_]+/gi,"_"),customItemCategoryInfo=this.fld.next('input[name="_category"]'),customItemCategories=customItemCategoryInfo&&customItemCategoryInfo.value.split(",")||[],customItemCategoriesElt=new Element("div",{class:"hidden term-category"}),categoryFieldName=this.fld.name+"__"+customItemId+"__category";customItemCategories.each(function(c){c&&customItemCategoriesElt.insert(new Element("input",{type:"hidden",name:categoryFieldName,value:c}))});var pagination=!!this.options.resultUsePagination&&this.options.resultUsePagination(),canSelectInputTerm=!this.options.canSelectInputTerm||this.options.canSelectInputTerm();(!pagination&&canSelectInputTerm||pagination&&0==this.resultPage&&canSelectInputTerm)&&list.addItem(this.generateListItem({id:this.fld.value,value:this.fld.value,category:customItemCategoriesElt,info:new Element("div",{class:"hint"}).update("(your text, not a standard term)")},"custom-value",!0))}for(var i=0,len=arr.length;i<len;i++)this.options.filterFunc&&!this.options.filterFunc(arr[i])||list.addItem(this.generateListItem(arr[i]));return 0==arr.length&&list.addItem(new PhenoTips.widgets.XListItem(this.options.noresults,{classes:"noSuggestion",noHighlight:!0})),list.getElement()},highLightSearchResult:function(text,queryTerm){return text.replace(new RegExp(queryTerm,"ig"),"<strong>$&</strong>")},generateListItem:function(data,cssClass,disableTooltip){var displayNode=new Element("div",{class:"tooltip-"+this.options.tooltip});if(data.icon&&displayNode.insert(new Element("img",{src:data.icon,class:"icon"})),this.options.displayId&&displayNode.insert(new Element("span",{class:"suggestId"}).update(data.id.escapeHTML())),this.options.displaySuggestItemFunction){var displaySuggestItem=this.options.displaySuggestItemFunction(this.sInput,data,this);if(displaySuggestItem)displayNode.insert(displaySuggestItem);else{newDataValue=this.highLightSearchResult(data.value.escapeHTML(),this.sInput);displayNode.insert(new Element("span",{class:"suggestValue"}).update(newDataValue))}}else{var newDataValue=this.highLightSearchResult(data.value.escapeHTML(),this.sInput);displayNode.insert(new Element("span",{class:"suggestValue"}).update(newDataValue))}if(this.options.tooltip&&!disableTooltip){var infoTool=new Element("span",{class:"fa fa-info-circle xHelpButton "+this.options.tooltip,title:data.id});infoTool.observe("click",function(event){event.stop()}),displayNode.insert(" ").insert(infoTool)}var displayInfo=new Element("div",{class:"suggestInfo"}).update(data.info);displayNode.insert(displayInfo),data.altName&&displayInfo.insert({top:new Element("span",{class:"matching-alternative-name"}).update(data.altName.escapeHTML())});var valueNode=new Element("div").insert(new Element("span",{class:"suggestId"}).update(data.id.escapeHTML())).insert(new Element("span",{class:"suggestValue"}).update(data.value.escapeHTML())).insert(new Element("div",{class:"suggestCategory"}).update(data.category));valueNode.store("itemData",data);var item=new PhenoTips.widgets.XListItem(displayNode,{containerClasses:"suggestItem "+(cssClass||""),value:valueNode,noHighlight:!0});return Event.fire(this.fld,"ms:suggest:suggestionCreated",{element:item.getElement(),suggest:this}),item},emphasizeMatches:function(input,value){for(var output=value,fragments=input.split(" ").uniq().compact(),offset=0,matches={},j=0,flen=fragments.length;j<flen;j++)for(var index=output.toLowerCase().indexOf(fragments[j].toLowerCase());index>=0;){var match=output.substring(index,index+fragments[j].length),placeholder="";fragments[j].length.times(function(){placeholder+=" "}),matches[index]=match,index=(output=output.substring(0,index)+placeholder+output.substring(index+fragments[j].length)).toLowerCase().indexOf(fragments[j].toLowerCase())}return Object.keys(matches).sortBy(function(s){return parseInt(s)}).each(function(key){var before=output.substring(0,parseInt(key)+offset),after=output.substring(parseInt(key)+matches[key].length+offset);output=before+"<em>"+matches[key]+"</em>"+after,offset+=9}),output},changeHighlight:function(key){var list=this.resultContainer;if(!list)return!1;var elem;if(this.iHighlighted){if(key==Event.KEY_DOWN){if(!(elem=this.iHighlighted.next())&&this.iHighlighted.up("div.results"))for(source=this.iHighlighted.up("div.results").next();source&&!elem;)elem=source.down("li"),source=source.next();elem||(elem=list.down("li"))}else if(key==Event.KEY_UP){if(!(elem=this.iHighlighted.previous())&&this.iHighlighted.up("div.results"))for(var source=this.iHighlighted.up("div.results").previous();source&&!elem;)elem=source.down("li:last-child"),source=source.previous();elem||(elem=list.select("ul")[list.select("ul").length-1].down("li:last-child"))}}else key==Event.KEY_DOWN?elem=list.down("div.results")?list.down("div.results").down("li"):list.down("li"):key==Event.KEY_UP&&list.select("li")>0&&(elem=list.select("li")[list.select("li").length-1]);elem&&this.setHighlight(elem)},setHighlight:function(highlightedItem){this.iHighlighted&&this.clearHighlight(),highlightedItem.addClassName("xhighlight"),this.iHighlighted=highlightedItem,this.killTimeout()},clearHighlight:function(){this.iHighlighted&&(this.iHighlighted.removeClassName("xhighlight"),delete this.iHighlighted)},highlightFirst:function(){if(this.suggest&&this.suggest.down("ul")){var first=this.suggest.down("ul").down("li");first&&this.setHighlight(first)}},hasActiveSelection:function(){return this.iHighlighted},setHighlightedValue:function(){if(this.iHighlighted&&!this.iHighlighted.hasClassName("noSuggestion")){var selection,newFieldValue;if(""==this.sInput&&""==this.fld.value)selection=newFieldValue=this.iHighlighted.down(".suggestValue").innerHTML;else if(this.seps){for(var lastIndx=-1,i=0;i<this.seps.length;i++)this.fld.value.lastIndexOf(this.seps.charAt(i))>lastIndx&&(lastIndx=this.fld.value.lastIndexOf(this.seps.charAt(i)));selection=-1==lastIndx?newFieldValue=this.iHighlighted.down(".suggestValue").innerHTML:(newFieldValue=this.fld.value.substring(0,lastIndx+1)+this.iHighlighted.down(".suggestValue").innerHTML).substring(lastIndx+1)}else selection=newFieldValue=this.iHighlighted.down(".suggestValue").innerHTML;var inputData=this.iHighlighted.down(".value div").retrieve("itemData"),data={suggest:this,id:inputData.id||this.iHighlighted.down(".suggestId").innerHTML,value:inputData.value||this.iHighlighted.down(".suggestValue").innerHTML,valueAll:inputData.valueAll,info:inputData.info||this.iHighlighted.down(".suggestInfo").innerHTML,icon:inputData.icon||(this.iHighlighted.down("img.icon")?this.iHighlighted.down("img.icon").src:""),category:this.iHighlighted.down(".suggestCategory").innerHTML};this.acceptEntry(data,selection,newFieldValue)}},acceptEntry:function(data,selection,newFieldValue,silent){if(!Event.fire(this.fld,"ms:suggest:selected",data).stopped&&(silent||(this.sInput=selection,this.fld.value=newFieldValue||this.fld.defaultValue||"",this.fld.focus(),this.clearSuggestions()),"function"==typeof this.options.callback&&this.options.callback(data),this.fld.id.indexOf("_suggest")>0)){var hidden_id=this.fld.id.substring(0,this.fld.id.indexOf("_suggest")),hidden_inp=$(hidden_id);hidden_inp&&(hidden_inp.value=info)}},killTimeout:function(){clearTimeout(this.toID)},resetTimeout:function(){clearTimeout(this.toID);var pointer=this;this.toID=setTimeout(function(){pointer.clearSuggestions()},1e6)},clearSuggestions:function(){this.killTimeout(),this.isActive=!1;var ele=$(this.container),pointer=this;if(ele&&ele.parentNode){if(this.options.fadeOnClear)new Effect.Fade(ele,{duration:"0.25",afterFinish:function(){$(pointer.container)&&$(pointer.container).remove()}});else $(this.container).remove();document.fire("ms:suggest:clearSuggestions",{suggest:this})}}})),PhenoTips}((PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).SegmentedBar=Class.create({options:{segments:5,displayValue:!0},initialize:function(value,options){this.value=value,this.options=Object.extend(Object.clone(this.options),options||{})},generateSegmentedBar:function(){if(this.value>1||this.value<0)return void console.log("Invalid segmented bar value");for(var bar=new Element("div",{class:"segmented-bar",title:Math.round(100*this.value)+"%"||""}),valueUnit=1/this.options.segments,i=0;i<this.options.segments;++i){var segmentFill=100*Math.min(Math.max((this.value-i*valueUnit)/valueUnit,0),1),segment=new Element("span",{class:"segmented-unit"}),segmentFillElement=new Element("span",{class:"segmented-unit-fill"});segmentFillElement.setStyle({width:segmentFill+"%"}),segment.insert(segmentFillElement),bar.insert(segment)}return this.options.displayValue&&bar.insert(" "+Math.round(100*this.value)+"%"),bar}}),PhenoTips}(PhenoTips||{}))||{}),PhenoTips=function(PhenoTips){return(PhenoTips.widgets=PhenoTips.widgets||{}).SuggestPicker=Class.create({options:{showKey:!0,showTooltip:!1,showDeleteTool:!0,enableSort:!0,showClearTool:!0,inputType:"hidden",listInsertionElt:null,listInsertionPosition:"after",predefinedEntries:null,acceptFreeText:!1},initialize:function(element,suggest,options,serializedDataInput){this.options=Object.extend(Object.clone(this.options),options||{}),this.serializedDataInput=serializedDataInput,this.input=element,this.suggest=suggest,this.inputName=this.input.name,this.options.acceptFreeText?this.input.addClassName("accept-value"):this.input.name=this.input.name+"__suggested",this.suggest.options.callback=this.acceptSuggestion.bind(this);var extraClass="";this.options.name&&(extraClass=this.options.name+"_suggestions"),this.list=new Element("ul",{class:"accepted-suggestions gel-accepted-suggestions "+extraClass});var listInsertionElement;this.options.listInsertionElt&&(listInsertionElement="string"==typeof this.options.listInsertionElt?this.input.up().down(this.options.listInsertionElt):this.options.listInsertionElt),listInsertionElement||(listInsertionElement=this.input);var insertion={};insertion[this.options.listInsertionPosition]=this.list,listInsertionElement.insert(insertion),this.predefinedEntries=this.options.predefinedEntries?$(this.options.predefinedEntries):null,this.options.showClearTool&&(this.clearTool=new Element("span",{class:"clear-tool delete-tool invisible",title:$services.localization.render("phenotips.widgets.multiSuggest.clear.title")}).update("Delete all &#x2716;"),this.clearTool.observe("click",this.clearAcceptedList.bindAsEventListener(this)),this.list.insert({after:this.clearTool})),"function"==typeof this.options.onItemAdded&&(this.onItemAdded=this.options.onItemAdded)},acceptAddItem:function(key,negative){var searchFor='input[id="'+this.getInputId(key,negative).replace(/[^a-zA-Z0-9_-]/g,"\\$&")+'"]',input=this.predefinedEntries?this.predefinedEntries.down(searchFor):this.list?this.list.down(searchFor):$(this.getInputId(key,negative));return void 0!=this.options.acceptsDuplicate&&"function"==typeof this.options.acceptsDuplicate&&this.options.acceptsDuplicate()&&(input=void 0),!input||(input.checked=!0,Event.fire(input,"suggest:change"),this.synchronizeSelection(input),!1)},ensureVisible:function(element,force){if(!(this.silent||!force&&this.options.silent||element.up(".hidden"))){for(var section=element.up(".collapsed:not(.force-collapse)");section;)section.removeClassName("collapsed"),section.down(".expand-tool")&&section.down(".expand-tool").update("▼"),section=section.up(".collapsed:not(.force-collapse)");element.viewportOffset().top>this.input.viewportOffset().top?element.viewportOffset().top>document.viewport.getHeight()&&(element.viewportOffset().top-this.input.viewportOffset().top<document.viewport.getHeight()?this.input.scrollTo():element.scrollTo()):element.cumulativeOffset().top<document.viewport.getScrollOffsets().top&&element.scrollTo()}},acceptSuggestion:function(obj){return this.input.value=this.input.defaultValue||"",this.acceptAddItem(obj.id||obj.value,obj.negative)&&this.addItem(obj.id||obj.value,obj.value,obj.info,obj.category,obj.valueAll),!1},addItem:function(key,value,info,category,valueAll){if(key){var id=this.getInputId(key);void 0!=this.options.acceptsDuplicate&&"function"==typeof this.options.acceptsDuplicate&&this.options.acceptsDuplicate()&&(id=id+"_"+Helpers.createRandomID());var listItem=new Element("li");listItem.store("valueAll",valueAll);var displayedValue=new Element("label",{class:"accepted-suggestion",for:id}),inputOptions={type:this.options.inputType,name:this.inputName,id:id,value:key};if("checkbox"==this.options.inputType&&(inputOptions.checked=!0),displayedValue.insert({bottom:new Element("input",inputOptions)}),this.options.showKey&&(displayedValue.insert({bottom:new Element("span",{class:"key"}).update("["+key.escapeHTML()+"]")}),displayedValue.insert({bottom:new Element("span",{class:"sep"}).update(" ")})),displayedValue.insert({bottom:new Element("span",{class:"value"}).update(value.escapeHTML())}),void 0!=this.options.customizeItemDisplay&&"function"==typeof this.options.customizeItemDisplay&&this.options.customizeItemDisplay(key,value,valueAll,displayedValue,this.options),listItem.insert(displayedValue),category&&""!=category&&listItem.insert(category),this.options.showDeleteTool){var deleteTool=new Element("span",{class:"delete-tool",title:"Delete this term"}).update("&#x2716;");deleteTool.observe("click",this.removeItem.bindAsEventListener(this)),listItem.appendChild(deleteTool)}this.options.showTooltip&&info&&(listItem.appendChild(new Element("div",{class:"tooltip"}).update(info)),listItem.select(".expand-tool").invoke("observe","click",function(event){event.stop()})),this.list.insert(listItem);var newItem=this.list?this.list.down('input[id="'+id.replace(/[^a-zA-Z0-9_-]/g,"\\$&")+'"]'):$(id);return this.synchronizeSelection(newItem),newItem.observe("change",this.synchronizeSelection.bind(this,newItem)),this.updateListTools(),this.onItemAdded(newItem),newItem}},onItemAdded:function(element){},removeItem:function(event){var item=event.findElement("li");this.synchronizeSelection({value:(item.down("input[type=checkbox]")||item.down("input")).value,checked:!1}),item.remove(),this.notifySelectionChange(item),this.input.value=this.input.defaultValue||"",this.updateListTools()},clearAcceptedList:function(){for(var item=this.list.down("li .delete-tool");item;)item.click(),item=this.list.down("li .delete-tool")},updateListTools:function(){if(this.clearTool&&(this.list.select("li .accepted-suggestion").length>0?this.clearTool.removeClassName("invisible"):this.clearTool.addClassName("invisible")),this.options.enableSort&&this.list.select("li .accepted-suggestion").length>0&&"undefined"!=typeof Sortable&&Sortable.create(this.list),this.serializedDataInput){var value="";this.list.select("li .accepted-suggestion input[type=checkbox]").each(function(entry){value+=entry.value+"|"}),this.serializedDataInput.value=value}},getInputId:function(key,negative){return(negative?this.inputName.replace(/(_\d+)_/,"$1_negative_"):this.inputName)+"_"+key},synchronizeSelection:function(input){var element="function"==typeof input.up&&input.up("li");if(element&&this.input.hasClassName("generateYesNo")&&!input.up(".yes-no-picker")){Element.select(element,'input[name="fieldName"][type="hidden"]').each(function(n){var target=n.up("li").down('input[type="checkbox"]'),originalName=target.name;target.id=target.id.replace(target.name,n.value),target.name=n.value,target.up("label").addClassName(n.className),target.up("label").htmlFor=target.id,n.value=originalName,n.up(".term-category")&&n.up(".term-category").insert({before:n})});var positiveName=this.input.name.replace(/__suggested$/,""),negativeName=this.input.name.replace(/(_\d+)_/,"$1_negative_").replace(/__suggested$/,""),value=input.value,text=element.down(".value").firstChild.nodeValue,ynpickerElt=YesNoPicker.generatePickerElement([{type:"na",selected:!isValueSelected(positiveName,value)&&!isValueSelected(negativeName,value)},{type:"yes",name:positiveName,selected:isValueSelected(positiveName,value)},{type:"no",name:negativeName,selected:isValueSelected(negativeName,value)}],value,text,!0,input.next());input.insert({before:ynpickerElt}),input.hide(),input.name="",input.id="",input.value="",enableHighlightChecked(ynpickerElt.down(".yes input")),enableHighlightChecked(ynpickerElt.down(".no input"))}element&&this.notifySelectionChange(element)},notifySelectionChange:function(elt){elt.__categoryArray||(elt.__categoryArray=[],Element.select(elt,".term-category input[type=hidden]").each(function(c){elt.__categoryArray.push(c.value)})),Event.fire(this.input,"xwiki:form:field-value-changed"),Event.fire(document,"custom:selection:changed",{categories:elt.__categoryArray,trigger:this.input,fieldName:this.inputName,customElement:elt})}}),PhenoTips}((PhenoTips=function(PhenoTips){var widgets=PhenoTips.widgets=PhenoTips.widgets||{};return widgets.ModalPopup=Class.create({options:{idPrefix:"modal-popup-",title:"",displayCloseButton:!0,screenColor:"",borderColor:"",titleColor:"",backgroundColor:"",screenOpacity:"0.5",verticalPosition:"center",horizontalPosition:"center",resetPositionOnShow:!0,removeOnClose:!1,onClose:Prototype.emptyFunction},initialize:function(content,shortcuts,options){this.shortcuts={show:{method:this.showDialog,keys:[]},close:{method:this.closeDialog,keys:["Esc"]}},this.content=content||"Hello world!",this.shortcuts=Object.extend(Object.clone(this.shortcuts),shortcuts||{}),this.options=Object.extend(Object.clone(this.options),options||{}),this.registerShortcuts("show"),void 0===widgets.ModalPopup.instanceCounter&&(widgets.ModalPopup.instanceCounter=0),this.id=++widgets.ModalPopup.instanceCounter},getBoxId:function(){return this.options.idPrefix+this.id},createDialog:function(event){if(this.dialog=new Element("div",{class:"msdialog-modal-container"}),this.options.extraDialogClassName&&this.dialog.addClassName(this.options.extraDialogClassName),this.screen=new Element("div",{class:"msdialog-screen"}).setStyle({opacity:this.options.screenOpacity,backgroundColor:this.options.screenColor}),this.dialog.update(this.screen),this.dialogBox=new Element("div",{class:"msdialog-box",id:this.getBoxId()}),this.options.extraClassName&&this.dialogBox.addClassName(this.options.extraClassName),this.dialogBox._x_contentPlug=new Element("div",{class:"content"}),this.dialogBox.update(this.dialogBox._x_contentPlug),this.dialogBox._x_contentPlug.update(this.content),this.options.title){var title=new Element("div",{class:"msdialog-title"}).update(this.options.title);title.setStyle({color:this.options.titleColor,backgroundColor:this.options.borderColor}),this.dialogBox.insertBefore(title,this.dialogBox.firstChild)}if(this.options.displayCloseButton){var closeButton=new Element("div",{class:"msdialog-close",title:"Close"}).update("&#215;");closeButton.setStyle({color:this.options.titleColor}),closeButton.observe("click",this.closeDialog.bindAsEventListener(this)),this.dialogBox.insertBefore(closeButton,this.dialogBox.firstChild)}this.dialog.appendChild(this.dialogBox),this.dialogBox.setStyle({textAlign:"left",borderColor:this.options.borderColor,backgroundColor:this.options.backgroundColor}),this.positionDialog(),document.body.appendChild(this.dialog),"undefined"!=typeof Draggable&&new Draggable(this.getBoxId(),{handle:$(this.getBoxId()).down(".msdialog-title"),scroll:window,change:this.updateScreenSize.bind(this)}),this.dialog.hide();var __enableUpdateScreenSize=function(event){this.dialog.visible()&&this.updateScreenSize()}.bindAsEventListener(this);["resize","scroll"].each(function(eventName){Event.observe(window,eventName,__enableUpdateScreenSize)}.bind(this)),Event.observe(document,"ms:popup:content-updated",__enableUpdateScreenSize)},positionDialog:function(){switch(this.options.verticalPosition){case"top":this.dialogBox.setStyle({top:document.viewport.getScrollOffsets().top+6+"px"});break;case"bottom":this.dialogBox.setStyle({bottom:".5em"});break;default:this.dialogBox.setStyle({top:"20%"})}switch(this.dialogBox.setStyle({left:"",right:""}),this.options.horizontalPosition){case"left":this.dialog.setStyle({textAlign:"left"});break;case"right":this.dialog.setStyle({textAlign:"right"});break;default:this.dialog.setStyle({textAlign:"center"}),this.dialogBox.setStyle({margin:"auto"})}},positionDialogInViewport:function(left,top){this.dialogBox.setStyle({left:document.viewport.getScrollOffsets().left+left+"px",top:document.viewport.getScrollOffsets().top+top+"px",margin:"0"})},getPositionInViewport:function(){return this.dialogBox.viewportOffset()},updateScreenSize:function(){var __getNewDimension=function(eltToFit,dimensionAccessFunction,position){var crtDimension=$(document.documentElement)[dimensionAccessFunction](),viewportDimension=document.viewport.getScrollOffsets()[position]+document.viewport[dimensionAccessFunction]();if(eltToFit)eltToFit.cumulativeOffset()[position],eltToFit[dimensionAccessFunction]();var result="";return crtDimension<viewportDimension&&(result=viewportDimension+"px"),result};this.screen.style.width=__getNewDimension(this.dialogBox,"getWidth","left"),this.screen.style.height=__getNewDimension(this.dialogBox,"getHeight","top")},setClass:function(className){this.dialogBox.addClassName("msdialog-box-"+className)},removeClass:function(className){this.dialogBox.removeClassName("msdialog-box-"+className)},setContent:function(content){this.content=content,this.dialogBox._x_contentPlug.update(this.content),this.updateScreenSize()},showDialog:function(event){event&&Event.stop(event),this.active||(this.active=!0,this.dialog||this.createDialog(),this.attachKeyListeners(),this.dialog.show(),this.options.resetPositionOnShow&&this.positionDialog(),this.updateScreenSize())},onScroll:function(event){this.dialog.setStyle({top:document.viewport.getScrollOffsets().top+"px"})},closeDialog:function(event){event&&Event.stop(event),this.options.onClose.call(this),this.dialog.hide(),this.options.removeOnClose&&this.dialog.remove(),this.detachKeyListeners(),this.active=!1},attachKeyListeners:function(){for(var action in this.shortcuts)"show"!=action&&this.registerShortcuts(action)},detachKeyListeners:function(){for(var action in this.shortcuts)"show"!=action&&this.unregisterShortcuts(action)},registerShortcuts:function(action){for(var shortcuts=this.shortcuts[action].keys,method=this.shortcuts[action].method,i=0;i<shortcuts.size();++i)Prototype.Browser.IE||Prototype.Browser.WebKit?shortcut.add(shortcuts[i],method.bindAsEventListener(this,action),{type:"keyup"}):shortcut.add(shortcuts[i],method.bindAsEventListener(this,action),{type:"keypress"})},unregisterShortcuts:function(action){for(var i=0;i<this.shortcuts[action].keys.size();++i)shortcut.remove(this.shortcuts[action].keys[i])},createButton:function(type,text,title,id){var wrapper=new Element("span",{class:"buttonwrapper"}),button=new Element("input",{type:type,class:"button",value:text,title:title,id:id});return wrapper.update(button),wrapper},show:function(event){this.showDialog(event)},close:function(event){this.closeDialog(event)}}),widgets.ModalPopup.active=!1,PhenoTips}(PhenoTips||{}))||{});