/*! pedigree-editor-tool - v1.3.0 - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var View=Class.create({initialize:function(){console.log("--- view init ---"),this.preGenerateGraphics(),this._nodeMap={},this.hoverModeZones=editor.getPaper().set(),this._currentMarkedNew=[],this._currentGrownNodes=[],this._currentHoveredNode=null,this._currentDraggable=null,this._lineSet=new LineSet},getSettings:function(){return{colors:{disorders:editor.getDisorderLegend().getAllColors(),genes:editor.getGeneLegend().getAllColors(),cancers:editor.getCancerLegend().getAllColors()},names:{disorders:editor.getDisorderLegend().getAllNames()}}},loadSettings:function(settingsObject){settingsObject.hasOwnProperty("colors")&&(settingsObject.colors.hasOwnProperty("disorders")&&editor.getDisorderLegend().setAllPreferredColors(settingsObject.colors.disorders),settingsObject.colors.hasOwnProperty("genes")&&editor.getGeneLegend().setAllPreferredColors(settingsObject.colors.genes))},preGenerateGraphics:function(){this.__menuButton_svgPath="M1.213,5.849C1.213,5.849,1.213,5.849,1.213,5.849C1.213,5.849,1.213,5.848,1.213,5.848C1.213,5.848,1.213,5.849,1.213,5.849C1.213,5.849,1.213,5.849,1.213,5.849M1.213,5.848C1.213,5.848,4.676,9.3114,4.676,9.3114C4.676,9.3114,1.2126,12.774,1.2126,12.774C1.2126,12.774,2.486,14.048,2.486,14.048C2.486,14.048,7.222,9.311,7.222,9.311C7.222,9.311,2.486,4.574,2.486,4.574C2.486,4.574,1.213,5.848,1.213,5.8476C1.2131999999999998,5.8476,1.2131999999999998,5.8476,1.2131999999999998,5.8476M7.348799999999999,13.9614C7.348799999999999,13.9614,16.0002,13.9614,16.0002,13.9614C16.0002,13.9614,16.0002,12.161999999999999,16.0002,12.161999999999999C16.0002,12.161999999999999,7.348799999999999,12.161999999999999,7.348799999999999,12.161999999999999C7.348799999999999,12.161999999999999,7.348799999999999,13.9614,7.348799999999999,13.9614C7.348799999999999,13.9614,7.348799999999999,13.9614,7.348799999999999,13.9614M9.949799999999998,10.2114C9.949799999999998,10.2114,16.0002,10.2114,16.0002,10.2114C16.0002,10.2114,16.0002,8.411999999999999,16.0002,8.411999999999999C16.0002,8.411999999999999,9.949799999999998,8.411999999999999,9.949799999999998,8.411999999999999C9.949799999999998,8.411999999999999,9.949799999999998,10.2114,9.949799999999998,10.2114C9.949799999999998,10.2114,9.949799999999998,10.2114,9.949799999999998,10.2114M7.348799999999999,4.6613999999999995C7.348799999999999,4.6613999999999995,7.348799999999999,6.462,7.348799999999999,6.462C7.348799999999999,6.462,16.0002,6.462,16.0002,6.462C16.0002,6.462,16.0002,4.661,16.0,4.6614C16.0,4.6614,7.349,4.6614,7.349,4.6614C7.349,4.6614,7.349,4.6614,7.349,4.6614",this.__menuButton_BBox=Raphael.pathBBox(this.__menuButton_svgPath),this.__deleteButton_svgPath="M14.867,12.851C14.867,12.851,11.566,9.55,11.566,9.55C11.566,9.55,14.866,6.249,14.866,6.249C14.866,6.249,13.169,4.551,13.169,4.551C13.169,4.551,9.868,7.852,9.868,7.852C9.868,7.852,6.567,4.551,6.567,4.551C6.567,4.551,4.87,6.249,4.87,6.249C4.87,6.249,8.171,9.55,8.171,9.55C8.171,9.55,4.87,12.851,4.870,12.851C4.870,12.851,6.568,14.549,6.568,14.549C6.568,14.549,9.868,11.248,9.868,11.248C9.868,11.248,13.169,14.549,13.169,14.549C13.169,14.549,14.867,12.851,14.867,12.851",this.__deleteButton_BBox=Raphael.pathBBox(this.__deleteButton_svgPath),this.__arrow_svgPath="M8.348,23.029C8.348,23.029,0.791,30.584,0.791,30.584C0.791,30.584,3.515,33.308,3.515,33.308C3.515,33.308,11.07,25.752,11.0704,25.752C11.07,25.752,13.114,27.795,13.114,27.795C13.114,27.795,15.598,18.524,15.598,18.524C15.598,18.524,6.327,21.008,6.327,21.008C6.327,21.008,8.348,23.029,8.348,23.0285C8.348,23.029,8.348,23.029,8.348,23.029",this.__probandArrowPath=Raphael.transformPath(this.__arrow_svgPath,["s",1.1,1.1,0,0])},getNodeMap:function(){return this._nodeMap},getNode:function(nodeId){if(!this._nodeMap.hasOwnProperty(nodeId))throw console.log("ERROR: requesting non-existent node "+nodeId),"ERROR";return this._nodeMap[nodeId]},getPersonNodeNear:function(x,y){for(var nodeID in this._nodeMap)if(this._nodeMap.hasOwnProperty(nodeID)){var node=this.getNode(nodeID);if(("Person"==node.getType()||"PersonGroup"==node.getType())&&node.getGraphics().containsXY(x,y))return node}return null},setAnonimizeStatus:function(status){for(var nodeID in this._nodeMap)this._nodeMap.hasOwnProperty(nodeID)&&this.getNode(nodeID).getGraphics().setAnonimizedStatus(status)},getCurrentHoveredNode:function(){return this._currentHoveredNode},getCurrentDraggable:function(){return this._currentDraggable},setCurrentDraggable:function(draggable){this._currentDraggable=draggable},removeFromNodeMap:function(nodeID){delete this.getNodeMap()[nodeID]},drawCurvedLineWithCrossings:function(id,xFrom,yFrom,yTop,xTo,yTo,lastBend,attr,twoLines,secondLineBelow,startSameX){if(yFrom==yTop&&yFrom==yTo)return this.drawLineWithCrossings(id,xFrom,yFrom,xTo,yTo,attr,twoLines,secondLineBelow,!1,startSameX);var cornerRadius=.8*PedigreeEditorParameters.attributes.curvedLinesCornerRadius,goesRight=xFrom>xTo;if(isFinite(lastBend))var xFinalBend=goesRight?xTo+lastBend:xTo-lastBend,xFinalBendVert=goesRight?xTo+lastBend+cornerRadius:xTo-lastBend-cornerRadius,xBeforeFinalBend=goesRight?xTo+lastBend+2*cornerRadius:xTo-lastBend-2*cornerRadius;else xBeforeFinalBend=xTo;var xFromAndBit=goesRight?xFrom-cornerRadius/2:xFrom+cornerRadius/2,xFromAfterCorner=goesRight?xFromAndBit-cornerRadius:xFromAndBit+cornerRadius,xFromAfter2Corners=goesRight?xFromAndBit-2*cornerRadius:xFromAndBit+2*cornerRadius;yFrom<=yTop?this.drawLineWithCrossings(id,xFrom,yFrom,xBeforeFinalBend,yFrom,attr,twoLines,!goesRight,!0,startSameX):(this.drawLineWithCrossings(id,xFrom,yFrom,xFromAndBit,yFrom,attr,twoLines,!goesRight,!0,startSameX),Math.abs(yFrom-yTop)>=2*cornerRadius?(goesRight?GraphicHelpers.drawCornerCurve(xFromAndBit,yFrom,xFromAfterCorner,yFrom-cornerRadius,!0,attr,twoLines,-2.5,2.5,2.5,-2.5):GraphicHelpers.drawCornerCurve(xFromAndBit,yFrom,xFromAfterCorner,yFrom-cornerRadius,!0,attr,twoLines,2.5,2.5,-2.5,-2.5),this.drawLineWithCrossings(id,xFromAfterCorner,yFrom-cornerRadius,xFromAfterCorner,yTop+cornerRadius,attr,twoLines,goesRight),goesRight?GraphicHelpers.drawCornerCurve(xFromAfterCorner,yTop+cornerRadius,xFromAfter2Corners,yTop,!1,attr,twoLines,-2.5,2.5,2.5,-2.5):GraphicHelpers.drawCornerCurve(xFromAfterCorner,yTop+cornerRadius,xFromAfter2Corners,yTop,!1,attr,twoLines,2.5,2.5,-2.5,-2.5)):goesRight?GraphicHelpers.drawLevelChangeCurve(xFromAndBit,yFrom,xFromAfter2Corners,yTop,attr,twoLines,-2.5,2.5,2.5,-2.5):GraphicHelpers.drawLevelChangeCurve(xFromAndBit,yFrom,xFromAfter2Corners,yTop,attr,twoLines,2.5,2.5,-2.5,-2.5),this.drawLineWithCrossings(id,xFromAfter2Corners,yTop,xBeforeFinalBend,yTop,attr,twoLines,!goesRight,!0)),xBeforeFinalBend!=xTo&&(Math.abs(yTo-yTop)>=2*cornerRadius?(goesRight?GraphicHelpers.drawCornerCurve(xBeforeFinalBend,yTop,xFinalBendVert,yTop+cornerRadius,!0,attr,twoLines,2.5,2.5,-2.5,-2.5):GraphicHelpers.drawCornerCurve(xBeforeFinalBend,yTop,xFinalBendVert,yTop+cornerRadius,!0,attr,twoLines,2.5,-2.5,-2.5,2.5),this.drawLineWithCrossings(id,xFinalBendVert,yTop+cornerRadius,xFinalBendVert,yTo-cornerRadius,attr,twoLines,!goesRight),goesRight?GraphicHelpers.drawCornerCurve(xFinalBendVert,yTo-cornerRadius,xFinalBend,yTo,!1,attr,twoLines,2.5,2.5,-2.5,-2.5):GraphicHelpers.drawCornerCurve(xFinalBendVert,yTo-cornerRadius,xFinalBend,yTo,!1,attr,twoLines,2.5,-2.5,-2.5,2.5)):goesRight?GraphicHelpers.drawLevelChangeCurve(xBeforeFinalBend,yTop,xFinalBend,yTo,attr,twoLines,2.5,2.5,-2.5,-2.5):GraphicHelpers.drawLevelChangeCurve(xBeforeFinalBend,yTop,xFinalBend,yTo,attr,twoLines,2.5,-2.5,-2.5,2.5),this.drawLineWithCrossings(id,xFinalBend,yTo,xTo,yTo,attr,twoLines,!goesRight))},drawLineWithCrossings:function(owner,x1,y1,x2,y2,attr,twoLines,secondLineBelow,bothEndsGoDown,sameXStart){if(x1>x2||x1==x2&&y1>y2){var tx=x1,ty=y1;x1=x2,y1=y2,x2=tx,y2=ty}var isHorizontal=y1==y2,isVertical=x1==x2,intersections=this._lineSet.addLine(owner,x1,y1,x2,y2),compareDistanceToStart=function(p1,p2){return(x1-p1.x)*(x1-p1.x)+(y1-p1.y)*(y1-p1.y)-((x1-p2.x)*(x1-p2.x)+(y1-p2.y)*(y1-p2.y))};intersections.sort(compareDistanceToStart);for(var lineNum=0;lineNum<(twoLines?2:1);lineNum++){twoLines&&(bothEndsGoDown?(x1-=sameXStart&&secondLineBelow?0:2.5,x2+=sameXStart&&!secondLineBelow?0:2.5):(x1+=sameXStart&&!secondLineBelow?0:7.5*lineNum-2.5,x2+=sameXStart&&secondLineBelow?0:7.5*lineNum-2.5),secondLineBelow?(y1+=2.5-7.5*lineNum,y2+=2.5-7.5*lineNum):(y1+=7.5*lineNum-2.5,y2+=7.5*lineNum-2.5));for(var raphaelPath="M "+x1+" "+y1,i=0;i<intersections.length;i++){var intersectPoint=intersections[i],distance=function(p1,p2){return(p1.x-p2.x)*(p1.x-p2.x)+(p1.y-p2.y)*(p1.y-p2.y)},noCrossSymbolProximity=isHorizontal?400:81;distance(intersectPoint,{x:x1,y:y1})<noCrossSymbolProximity||(distance(intersectPoint,{x:x2,y:y2})<noCrossSymbolProximity||(isHorizontal?(twoLines&&(intersectPoint.y+=secondLineBelow?2.5-7.5*lineNum:7.5*lineNum-2.5),raphaelPath+=" L "+(intersectPoint.x-10)+" "+intersectPoint.y,raphaelPath+=" C "+(intersectPoint.x-7)+" "+(intersectPoint.y+1)+" "+(intersectPoint.x-7)+" "+(intersectPoint.y-7)+" "+intersectPoint.x+" "+(intersectPoint.y-7),raphaelPath+=" C "+(intersectPoint.x+7)+" "+(intersectPoint.y-7)+" "+(intersectPoint.x+7)+" "+(intersectPoint.y+1)+" "+(intersectPoint.x+10)+" "+intersectPoint.y):isVertical&&(twoLines&&(intersectPoint.x+=7.5*lineNum-2.5),raphaelPath+=" L "+intersectPoint.x+" "+(intersectPoint.y-10),raphaelPath+=" C "+(intersectPoint.x-1)+" "+(intersectPoint.y-7)+" "+(intersectPoint.x+7)+" "+(intersectPoint.y-7)+" "+(intersectPoint.x+7)+" "+intersectPoint.y,raphaelPath+=" C "+(intersectPoint.x+7)+" "+(intersectPoint.y+7)+" "+(intersectPoint.x-1)+" "+(intersectPoint.y+7)+" "+intersectPoint.x+" "+(intersectPoint.y+10))))}raphaelPath+=" L "+x2+" "+y2,editor.getPaper().path(raphaelPath).attr(attr).toBack()}},addNode:function(id){var positionedGraph=editor.getGraph();if(!positionedGraph.isValidID(id))throw"addNode(): Invalid id";var node,properties=positionedGraph.getProperties(id),graphPos=positionedGraph.getPosition(id),position=editor.convertGraphCoordToCanvasCoord(graphPos.x,graphPos.y);if(positionedGraph.isRelationship(id))node=new Partnership(position.x,position.y,id,properties);else if(positionedGraph.isPlaceholder(id))node=new PersonPlaceholder(position.x,position.y,id,properties);else if(positionedGraph.isPersonGroup(id))node=new PersonGroup(position.x,position.y,id,properties);else{if(!positionedGraph.isPerson(id))throw"addNode(): unsupported node type";node=new Person(position.x,position.y,id,properties)}return this.getNodeMap()[id]=node,node},moveNode:function(id,animate){var graphPos=editor.getGraph().getPosition(id),position=editor.convertGraphCoordToCanvasCoord(graphPos.x,graphPos.y);this.getNode(id).setPos(position.x,position.y,animate)},changeNodeIds:function(changedIdsSet){var newNodeMap={};for(oldID in this._nodeMap){var node=this.getNode(oldID),newID=changedIdsSet.hasOwnProperty(oldID)?changedIdsSet[oldID]:oldID;node.setID(newID),newNodeMap[newID]=node}this._nodeMap=newNodeMap,this._lineSet.replaceIDs(changedIdsSet),editor.getCancerLegend().replaceIDs(changedIdsSet),editor.getGeneLegend().replaceIDs(changedIdsSet),editor.getHPOLegend().replaceIDs(changedIdsSet),editor.getDisorderLegend().replaceIDs(changedIdsSet)},enterHoverMode:function(sourceNode,hoverType){var me=this;this.getValidDragTargets(sourceNode.getID(),hoverType).each(function(nodeID){me._currentGrownNodes.push(nodeID);var node=me.getNode(nodeID);node.getGraphics().grow();var hoverModeZone=node.getGraphics().getHoverBox().getHoverZoneMask().clone().toFront();hoverModeZone.hover(function(){me._currentHoveredNode=nodeID,node.getGraphics().getHoverBox().setHighlighted(!0)},function(){me._currentHoveredNode=null,node.getGraphics().getHoverBox().setHighlighted(!1)}),me.hoverModeZones.push(hoverModeZone)})},exitHoverMode:function(){this._currentHoveredNode=null,this.hoverModeZones.remove();var me=this;this._currentGrownNodes.each(function(nodeID){var node=me.getNode(nodeID);node.getGraphics().shrink(),node.getGraphics().getHoverBox().setHighlighted(!1)}),this._currentGrownNodes=[]},unmarkAll:function(){for(var i=0;i<this._currentMarkedNew.length;i++)this.getNode(this._currentMarkedNew[i]).getGraphics().unmark();this._currentMarkedNew=[]},getValidDragTargets:function(sourceNodeID,hoverType){var result=[];switch(hoverType){case"sibling":result=editor.getGraph().getPossibleSiblingsOf(sourceNodeID);break;case"child":result=editor.getGraph().getPossibleChildrenOf(sourceNodeID);break;case"parent":result=editor.getGraph().getPossibleParentsOf(sourceNodeID);break;case"partnerR":case"partnerL":result=editor.getGraph().getPossiblePartnersOf(sourceNodeID);break;case"PlaceHolder":throw"TODO";default:throw"Incorrect hoverType"}return result},applyChanges:function(changeSet,markNew){if(console.log("Change set: "+Helpers.stringifyObject(changeSet)),!Helpers.isObjectEmpty(changeSet)){var timer=new Helpers.Timer,timer2=new Helpers.Timer;try{if(this.unmarkAll(),changeSet.hasOwnProperty("moved")||(changeSet.moved=[]),changeSet.hasOwnProperty("removed")||(changeSet.removed=[]),changeSet.hasOwnProperty("changedIDSet")||(changeSet.changedIDSet={}),changeSet.hasOwnProperty("removed")){for(var affectedByLineRemoval={},i=0;i<changeSet.removed.length;i++){var nextRemoved=changeSet.removed[i];this.getNodeMap()[nextRemoved].remove(),this.removeFromNodeMap(nextRemoved);for(var affected=this._lineSet.removeAllLinesAffectedByOwnerMovement(nextRemoved),j=0;j<affected.length;j++)Helpers.arrayContains(changeSet.removed,affected[j])||(affectedByLineRemoval[affected[j]]=!0)}this.changeNodeIds(changeSet.changedIDSet);for(var node in affectedByLineRemoval)if(affectedByLineRemoval.hasOwnProperty(node)){var newID=changedIDs.hasOwnProperty(node)?changedIDs[node]:node;Helpers.arrayContains(changeSet.moved,newID)||changeSet.moved.push(newID)}}timer.printSinceLast("=== Removal runtime: ");var movedPersons=[],movedRelationships=[],newPersons=[],newRelationships=[],animate={};if(changeSet.hasOwnProperty("moved")){for(i=0;i<changeSet.moved.length;i++){nextMoved=changeSet.moved[i];if(editor.getGraph().isRelationship(nextMoved))for(var affected=this._lineSet.removeAllLinesAffectedByOwnerMovement(nextMoved),j=0;j<affected.length;j++){node=affected[j];Helpers.arrayContains(changeSet.moved,node)||changeSet.moved.push(node)}}for(i=0;i<changeSet.moved.length;i++){var nextMoved=changeSet.moved[i];editor.getGraph().isRelationship(nextMoved)?movedRelationships.push(nextMoved):movedPersons.push(nextMoved)}}if(console.log("moved: "+Helpers.stringifyObject(changeSet.moved)),changeSet.hasOwnProperty("new"))for(i=0;i<changeSet.new.length;i++){var nextNew=changeSet.new[i];editor.getGraph().isRelationship(nextNew)?newRelationships.push(nextNew):newPersons.push(nextNew)}timer.printSinceLast("=== Bookkeeping/sorting runtime: ");for(i=0;i<movedPersons.length;i++)this.moveNode(movedPersons[i],animate.hasOwnProperty(movedPersons[i]));timer.printSinceLast("=== Move persons runtime: ");for(i=0;i<newPersons.length;i++){var newPerson=this.addNode(newPersons[i]);markNew&&(newPerson.getGraphics().markPermanently(),this._currentMarkedNew.push(newPersons[i]))}timer.printSinceLast("=== New persons runtime: ");for(i=0;i<movedRelationships.length;i++)this.moveNode(movedRelationships[i]);timer.printSinceLast("=== Move rels runtime: ");for(i=0;i<newRelationships.length;i++)this.addNode(newRelationships[i]);if(timer.printSinceLast("=== New rels runtime: "),changeSet.hasOwnProperty("highlight"))for(i=0;i<changeSet.highlight.length;i++){var nextHighlight=changeSet.highlight[i];this.getNode(nextHighlight).getGraphics().markPermanently(),this._currentMarkedNew.push(nextHighlight)}if(!editor.isReadOnlyMode()){for(var nodeID in this._nodeMap)this._nodeMap.hasOwnProperty(nodeID)&&editor.getGraph().isPerson(nodeID)&&!this.getNode(nodeID).getGraphics().getHoverBox().isMenuToggled()&&(this.getNode(nodeID).getGraphics().getHoverBox().removeButtons(),this.getNode(nodeID).getGraphics().getHoverBox().removeHandles());var checkNumberingEvent={memo:{check:!0,noUndoRedo:!0}};editor.getController().handleRenumber(checkNumberingEvent),timer.printSinceLast("=== highlight & update handles runtime: ")}timer2.printSinceLast("=== Total apply changes runtime: ")}catch(err){console.log("[view] update error: "+err)}}}});