/*! pedigree-editor-tool - v1.3.0 - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var UndoRedoManager=Class.create({initialize:function(){this._currentState=0,this._stack=[],this._MAXUNDOSIZE=100,this._savedState=""},hasUnsavedChanges:function(){var state=this._getCurrentState();return null==state||this._savedState!=state.serializedState},hasRedo:function(){return!!this._getNextState()},hasUndo:function(){return!!this._getPreviousState()},addSaveEvent:function(){var state=this._getCurrentState();null!=state&&(this._savedState=state.serializedState)},redo:function(){var nextState=this._getNextState();if(nextState){if(this._currentState++,nextState.eventToGetToThisState){var memo=nextState.eventToGetToThisState.memo;memo.noUndoRedo=!0,document.fire(nextState.eventToGetToThisState.eventName,memo)}else editor.getSaveLoadEngine().createGraphFromSerializedData(nextState.serializedState,!0);document.fire("pedigree:historychange",null)}},undo:function(){var prevState=this._getPreviousState();if(prevState){var currentState=this._getCurrentState();if(this._currentState--,currentState.eventToUndo){var memo=currentState.eventToUndo.memo;memo.noUndoRedo=!0,document.fire(currentState.eventToUndo.eventName,memo)}else editor.getSaveLoadEngine().createGraphFromSerializedData(prevState.serializedState,!0);document.fire("pedigree:historychange",null)}},addState:function(eventToGetToThisState,eventToUndo,serializedState){this._currentState<this._size()&&this._stack.splice(this._currentState,this._stack.length-this._currentState),serializedState||(serializedState=editor.getSaveLoadEngine().serialize());var state=new State(serializedState,eventToGetToThisState,eventToUndo),currentState=this._getCurrentState();if(eventToGetToThisState&&currentState&&currentState.eventToGetToThisState&&"pedigree:node:setproperty"==currentState.eventToGetToThisState.eventName&&this._combinableEvents(currentState.eventToGetToThisState,eventToGetToThisState))return currentState.eventToGetToThisState=eventToGetToThisState,void(currentState.serializedState=serializedState);this._addNewest(state),this._size()>this._MAXUNDOSIZE&&this._removeOldest(),document.fire("pedigree:historychange",null)},_combinableEvents:function(event1,event2){return!(!event1.memo.hasOwnProperty("nodeID")||!event2.memo.hasOwnProperty("nodeID")||event1.memo.nodeID!=event2.memo.nodeID)&&(!(!event1.memo.properties.hasOwnProperty("setFirstName")||!event2.memo.properties.hasOwnProperty("setFirstName"))||(!(!event1.memo.properties.hasOwnProperty("setLastName")||!event2.memo.properties.hasOwnProperty("setLastName"))||(!(!event1.memo.properties.hasOwnProperty("setLastNameAtBirth")||!event2.memo.properties.hasOwnProperty("setLastNameAtBirth"))||(!(!event1.memo.properties.hasOwnProperty("setComments")||!event2.memo.properties.hasOwnProperty("setComments"))||!(!event1.memo.properties.hasOwnProperty("setChildlessReason")||!event2.memo.properties.hasOwnProperty("setChildlessReason"))))))},_size:function(){return this._stack.length},_addNewest:function(state){this._stack.push(state),this._currentState++},_removeOldest:function(){this._stack.splice(0,1),this._currentState--},_getCurrentState:function(){return 0==this._size()||0==this._currentState?null:this._stack[this._currentState-1]},_getNextState:function(){return this._size()<=1||this._currentState>=this._size()?null:this._stack[this._currentState]},_getPreviousState:function(){return 1==this._size()||this._currentState<=1?null:this._stack[this._currentState-2]},_debug_print_states:function(){console.log("------------");for(var i=0;i<this._stack.length;i++)console.log("["+i+"] EventToState: "+Helpers.stringifyObject(this._stack[i].eventToGetToThisState)+"\n    EventUndo: "+Helpers.stringifyObject(this._stack[i].eventToUndo)+"\n    EventSerial: "+Helpers.stringifyObject(this._stack[i].serializedState));console.log("------------")}}),State=Class.create({initialize:function(serializedState,eventToGetToThisState,eventToUndo){this.serializedState=serializedState,this.eventToGetToThisState=eventToGetToThisState,this.eventToUndo=eventToUndo}});