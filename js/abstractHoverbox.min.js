/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var AbstractHoverbox=Class.create({initialize:function(node,shiftX,shiftY,width,height,nodeX,nodeY,nodeShapes){this._node=node,this._relativeX=shiftX,this._relativeY=shiftY,this._nodeX=nodeX,this._nodeY=nodeY,this._hidden=!0,this._enabled=!1,this._width=width,this._height=height,this._isHovered=!1,this._currentHandles=null,this._currentOrbs=null,this._currentButtons=null,this._handlesZoomSz=null,this._boxOnHover=editor.getPaper().rect(this.getX(),this.getY(),this._width,this._height,5).attr(PedigreeEditorParameters.attributes.boxOnHover),this._boxOnHover.node.setAttribute("class","pedigree-hoverbox"),this._backElements=editor.getPaper().set(this._boxOnHover),this._mask=this._boxOnHover.clone().attr({fill:"green",opacity:0}),this._frontElements=editor.getPaper().set().push(this._mask);var nodeShapeSet=nodeShapes.flatten();this._backElements.insertBefore(nodeShapeSet),this._frontElements.insertAfter(nodeShapeSet),this.animateDrawHoverZone=this.animateDrawHoverZone.bind(this),this.animateHideHoverZone=this.animateHideHoverZone.bind(this),this.getBoxOnHover().attr({opacity:0}),this.enable(),this._isMenuToggled=!1,this._justClosedMenu=!1},getX:function(){return this.getNodeX()+this._relativeX},getY:function(){return this.getNodeY()+this._relativeY},getNodeX:function(){var nodeGraphics=this.getNode().getGraphics();return nodeGraphics&&(this._nodeX=nodeGraphics.getX()),this._nodeX},getNodeY:function(){var nodeGraphics=this.getNode().getGraphics();return nodeGraphics&&(this._nodeY=nodeGraphics.getY()),this._nodeY},getWidth:function(){return this._width},getHeight:function(){return this._height},getNode:function(){return this._node},generateButtons:function(){null===this._currentButtons&&(this._currentButtons=[])},regenerateButtons:function(){this.removeButtons(),this.generateButtons()},removeButtons:function(){if(this._currentButtons){var enableState=this._enabled;enableState&&this.disable();for(var i=0;i<this._currentButtons.length;i++)this.getFrontElements().exclude(this._currentButtons[i]),this._currentButtons[i].remove();this._currentButtons=null,enableState&&this.enable()}},hideButtons:function(){if(this._currentButtons)for(var i=0;i<this._currentButtons.length;i++)this._currentButtons[i].hasOwnProperty("mask")&&this._currentButtons[i].mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOff),this._currentButtons[i].hide()},showButtons:function(){if(this._currentButtons)for(var i=0;i<this._currentButtons.length;i++)this._currentButtons[i].show()},getCurrentButtons:function(){return this._currentButtons},removeHandles:function(){if(this._currentHandles){var enableState=this._enabled;enableState&&this.disable();for(i=0;i<this._currentOrbs.length;i++)this.getFrontElements().exclude(this._currentOrbs[i]);this._currentOrbs=null,enableState&&this.enable();for(var i=0;i<this._currentHandles.length;i++)this._currentHandles[i].remove();this._currentHandles=null}},hideHandles:function(){if(this._currentHandles)for(var i=0;i<this._currentHandles.length;i++)this._currentHandles[i].hide()},showHandles:function(){if(this._currentHandles)for(var i=0;i<this._currentHandles.length;i++)this._currentHandles[i].show()},generateHandles:function(){null===this._currentHandles&&(this._currentHandles=[],this._currentOrbs=[],this._handlesZoomSz=editor.getWorkspace().getCurrentZoomLevel())},regenerateHandles:function(){this._currentHandles&&this.removeHandles(),this._hidden&&!this.isMenuToggled()||this.generateHandles()},createButton:function(x,y,svgPath,svgPathBBox,attributes,onClick,className,title){var icon=editor.getPaper().path(svgPath).attr(attributes);icon.transform(["t",x,y]);var xShift=svgPathBBox.width/4,yShift=svgPathBBox.height/4,newWidth=1.5*svgPathBBox.width,newHeight=1.5*svgPathBBox.height,mask=editor.getPaper().rect(x+svgPathBBox.x-xShift,y+svgPathBBox.y-yShift,newWidth,newHeight,1);mask.attr({fill:"gray",opacity:0,"stroke-width":0});var button=editor.getPaper().set(mask,icon).toFront(),me=this,clickFunct=function(){if(me._hidden)return void(button.isClicked=!1);button.isClicked=!button.isClicked,button.isClicked?mask.attr(PedigreeEditorParameters.attributes.btnMaskClick):mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOn),onClick&&onClick()};button.click(clickFunct),button.mousedown(function(){mask.attr(PedigreeEditorParameters.attributes.btnMaskClick)}),button.hover(function(){mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOn),title&&mask.attr({title:title})},function(){mask.attr(PedigreeEditorParameters.attributes.btnMaskHoverOff)}),className&&button.forEach(function(element){element.node.setAttribute("class",className)}),button.icon=icon,button.mask=mask,this._hidden&&!this.isMenuToggled()&&button.hide(),this._currentButtons.push(button),this.disable(),this.getFrontElements().push(button),this.enable()},generateMenuBtn:function(){var me=this,action=function(){me.toggleMenu(!me.isMenuToggled())},attributes=PedigreeEditorParameters.attributes.menuBtnIcon,x=this.getX()+this.getWidth()-20-this.getWidth()/40,y=this.getY()+this.getHeight()/40;this.createButton(x,y,editor.getView().__menuButton_svgPath,editor.getView().__menuButton_BBox,attributes,action,"menu-trigger","node properties")},generateDeleteBtn:function(){var me=this,action=function(){me.animateHideHoverZone();var event={nodeID:me.getNode().getID()};document.fire("pedigree:node:remove",event)},attributes=PedigreeEditorParameters.attributes.deleteBtnIcon,x=this.getX()+this.getWidth()-20-this.getWidth()/40,y=this.getY()+this.getHeight()/40;this.createButton(x,y,editor.getView().__deleteButton_svgPath,editor.getView().__deleteButton_BBox,attributes,action,"delete","remove node")},getBoxOnHover:function(){return this._boxOnHover},isHovered:function(){return this._isHovered},setHovered:function(isHovered){this._isHovered=isHovered},setHighlighted:function(isHighlighted){isHighlighted?(this.getBoxOnHover().attr(PedigreeEditorParameters.attributes.boxOnHover),this.getBoxOnHover().attr("fill","green")):this.getBoxOnHover().attr(PedigreeEditorParameters.attributes.boxOnHover).attr("opacity",0)},getHoverZoneMask:function(){return this._mask},getFrontElements:function(){return this._frontElements},getBackElements:function(){return this._backElements},generateHandle:function(type,startX,startY,orbX,orbY,title,orbShapeGender,toHide){orbShapeGender||(orbShapeGender="F");var strokeWidth=editor.getWorkspace().getSizeNormalizedToDefaultZoom(PedigreeEditorParameters.attributes.handleStrokeWidth),path=[["M",startX,startY],["L",orbX,orbY]],connection=editor.getPaper().path(path).attr({"stroke-width":strokeWidth,stroke:"gray"}).toBack();connection.oPath=path;var orbRadius="createTouch"in document?PedigreeEditorParameters.attributes.touchOrbRadius:PedigreeEditorParameters.attributes.orbRadius,orbHue=PedigreeEditorParameters.attributes.orbHue,normalOrbAttr="F"!=orbShapeGender?{fill:"0-hsb("+orbHue+", 1, .75)-hsb("+orbHue+", .5, .25)",stroke:"#555","stroke-width":"0.75"}:{fill:"r(.5,.9)hsb("+orbHue+", 1, .75)-hsb("+orbHue+", .5, .25)",stroke:"none"},selectedOrbAttr="F"!=orbShapeGender?{fill:"0-hsb("+(orbHue+.36)+", 1, .75)-hsb("+(orbHue+.36)+", .5, .25)"}:{fill:"r(.5,.9)hsb("+(orbHue+.36)+", 1, .75)-hsb("+(orbHue+.36)+", .5, .25)"},orbAttrX="F"!=orbShapeGender?"x":"cx",orbAttrY="F"!=orbShapeGender?"y":"cy",orb=GraphicHelpers.generateOrb(editor.getPaper(),orbX,orbY,1.1*orbRadius,orbShapeGender).attr("cursor","pointer");orb[0].attr(normalOrbAttr);var handle=editor.getPaper().set().push(connection,orb);handle.type=type,connection.insertBefore(this.getHoverZoneMask()),orb.toFront();var me=this,inHoverMode=!1,interactionStarted=!1,onDragHandle=function(){inHoverMode||(inHoverMode=!0,null!==editor.getView().getCurrentDraggable()&&editor.getView().enterHoverMode(me.getNode(),type),toHide&&toHide.hide())},wrongClick=!1,start=function(x,y,e){if(!interactionStarted){if(interactionStarted=!0,wrongClick=!1,0!=e.button)return interactionStarted=!1,void(wrongClick=!0);connection.toFront(),orb.stop(),orb.toFront(),inHoverMode=!1,me.disable(),me.getFrontElements().toFront(),orb.ot?(orb.transform(""),orb.attr(orbAttrX,orb.ox),orb.attr(orbAttrY,orb.oy),orb.transform(orb.ot)):(orb.ot=orb[0].transform(),orb.ox=orb[0].attr(orbAttrX),orb.oy=orb[0].attr(orbAttrY)),connection.ox=connection.oPath[1][1],connection.oy=connection.oPath[1][2],handle.isDragged=!1,editor.getView().setCurrentDraggable(me.getNode().getID()),setTimeout(onDragHandle,100)}},move=function(dx,dy){wrongClick||interactionStarted&&(onDragHandle(),dx/=editor.getWorkspace().zoomCoefficient,dy/=editor.getWorkspace().zoomCoefficient,orb.ot.length>0&&orb.transform(""),orb.attr(orbAttrX,orb.ox+dx),orb.attr(orbAttrY,orb.oy+dy),orb.ot.length>0&&orb.transform(orb.ot),connection.oPath[1][1]=connection.ox+dx,connection.oPath[1][2]=connection.oy+dy,connection.attr("path",connection.oPath),(dx>1||dx<-1||dy>1||dy<-1)&&(handle.isDragged=!0))},end=function(){if(inHoverMode=!1,interactionStarted=!1,!wrongClick){var curHoveredId=editor.getView().getCurrentHoveredNode();if(editor.getView().setCurrentDraggable(null),editor.getView().exitHoverMode(),handle.isDragged)if(0==orb.ot.length){var finalPosition={};finalPosition[orbAttrX]=orb.ox,finalPosition[orbAttrY]=orb.oy,orb.animate(finalPosition,1e3,"elastic",function(){})}else{var dx=orb.ox-orb[0].attr(orbAttrX),dy=orb.oy-orb[0].attr(orbAttrY);orb.animate({transform:"T"+dx+","+dy+"R45"},1e3,"elastic",function(){orb.transform(""),orb.attr(orbAttrX,orb.ox),orb.attr(orbAttrY,orb.oy),orb.transform(orb.ot)})}console.log("handle.isDragged: "+handle.isDragged+", currentHover: "+curHoveredId),connection.oPath[1][1]=connection.ox,connection.oPath[1][2]=connection.oy,connection.animate({path:connection.oPath},1e3,"elastic"),orb[0].attr(normalOrbAttr),connection.insertBefore(me.getHoverZoneMask()),me.enable(),handle.isDragged&&null==curHoveredId||me.handleAction(handle.type,handle.isDragged,curHoveredId)}};return orb.drag(move,start,end),orb.hover(function(){orb[0].attr(selectedOrbAttr),title&&(orb[0].attr({title:title}),orb[1].attr({title:title}))},function(){orb[0].attr(normalOrbAttr)}),this._currentOrbs.push(orb[0]),this._currentOrbs.push(orb[1]),this.disable(),this.getFrontElements().push(orb[0]),this.getFrontElements().push(orb[1]),this.enable(),handle},isMenuToggled:function(){return!1},animateDrawHoverZone:function(){null===editor.getView().getCurrentDraggable()&&(this._hidden=!1,this.getNode().getGraphics().setSelected(!0),this.getBoxOnHover().stop().animate({opacity:.7},200),this.generateButtons(),this.showButtons(),this.getCurrentButtons().forEach(function(button){button.hasOwnProperty("icon")&&button.icon.stop().animate({opacity:1},200)}),this._handlesZoomSz!=editor.getWorkspace().getCurrentZoomLevel()&&this.removeHandles(),this.generateHandles(),this.showHandles())},animateHideHoverZone:function(){null===editor.getView().getCurrentDraggable()&&(this._hidden=!0,this.getNode().getGraphics().setSelected(!1),this.getBoxOnHover().stop().animate({opacity:0},200),this.hideButtons(),this.hideHandles())},disable:function(){this._enabled=!1,this.getFrontElements().unhover(this.animateDrawHoverZone,this.animateHideHoverZone)},enable:function(){this._enabled=!0,this.getFrontElements().hover(this.animateDrawHoverZone,this.animateHideHoverZone)},remove:function(){this.disable(),this.removeButtons(),this.removeHandles(),this.getBackElements().remove(),this.getFrontElements().remove()},onWidgetHide:function(){this._isMenuToggled=!1,this._justClosedMenu=!0;var me=this;setTimeout(function(){me._justClosedMenu=!1},100),this._hidden?this.animateHideHoverZone():this.animateDrawHoverZone()},onWidgetShow:function(){this._isMenuToggled=!0}});