/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var Legend=Class.create({initialize:function(title,allowDrop,initiallyHide){if(this._initiallyHide=initiallyHide,this._affectedNodes={},this._objectColors={},this._preferredColors={},this._previousHighightedNode=null,void 0==(legendContainer=$("legend-container"))){editor.isReadOnlyMode()||(this._legendInfo=new Element("div",{class:"legend-box legend-info",id:"legend-info"}).insert(new Element("div",{class:"infomessage"}).insert("You can drag and drop all items from the list(s) below onto individuals in the pedigree to mark them as affected.")),this.closeButton=new Element("span",{class:"close-button"}).update(" "),this.closeButton.observe("click",this.hideDragHint.bindAsEventListener(this)),this._legendInfo.insert({top:this.closeButton}),this._legendInfo.hide());var legendContainer=new Element("div",{class:"legend-container",id:"legend-container"}).insert(this._legendInfo);editor.getWorkspace().getWorkArea().insert(legendContainer)}else editor.isReadOnlyMode()||(this._legendInfo=legendContainer.down("#legend-info"));this._legendBox=new Element("div",{class:"legend-box",id:this._getPrefix()+"-legend-box"}),this._legendBox.hide(),legendContainer.insert(this._legendBox);var showMoreIcon=new Element("i",{class:"fa  rightIcon"});!0===this._initiallyHide?showMoreIcon.addClassName("fa-angle-double-down"):showMoreIcon.addClassName("fa-angle-double-up");var plusElement=new Element("span",{style:"cursor:pointer;font-size: 90%;"}).insert(title).insert(showMoreIcon),legendTitle=new Element("h2",{class:"legend-title"}).update(plusElement),divTitle=new Element("div",{class:""}).update(legendTitle),self=this;showMoreIcon.on("click",function(event){if(this.hasClassName("fa-angle-double-down"))(nextUL=$$("ul."+self._getPrefix()+"-list")).length>0&&nextUL[0].show(),this.removeClassName("fa-angle-double-down"),this.addClassName("fa-angle-double-up");else{var nextUL=$$("ul."+self._getPrefix()+"-list");nextUL.length>0&&nextUL[0].hide(),this.addClassName("fa-angle-double-down"),this.removeClassName("fa-angle-double-up")}}),this._legendBox.insert(divTitle),this._list=new Element("ul",{class:this._getPrefix()+"-list abnormality-list"}),this._legendBox.insert(this._list),!0===this._initiallyHide&&this._list.hide(),Element.observe(this._legendBox,"mouseover",function(){$$(".menu-box").invoke("setOpacity",.1)}),Element.observe(this._legendBox,"mouseout",function(){$$(".menu-box").invoke("setOpacity",1)}),allowDrop&&Droppables.add(editor.getWorkspace().canvas,{accept:"drop-"+this._getPrefix(),onDrop:this._onDropWrapper.bind(this),onHover:this._onHoverWrapper.bind(this)})},_getPrefix:function(id){throw"prefix not defined"},hideDragHint:function(){editor.getPreferencesManager().setConfigurationOption("user","hideDraggingHint",!0),this._legendInfo.hide()},getObjectColor:function(id){return this._objectColors.hasOwnProperty(id)?this._objectColors[id]:"#ff0000"},getAllColors:function(){return this._objectColors},setAllPreferredColors:function(allColors){for(id in allColors)allColors.hasOwnProperty(id)&&this.addPreferredColor(id,allColors[id])},addPreferredColor:function(id,color){this._preferredColors[id]=color},getPreferedColor:function(id){return this._preferredColors.hasOwnProperty(id)?this._preferredColors[id]:null},_hasAffectedNodes:function(id){return this._affectedNodes.hasOwnProperty(id)},addCase:function(id,name,valueAll,nodeID){if(0==Object.keys(this._affectedNodes).length&&(this._legendBox.show(),!editor.getPreferencesManager().getConfigurationOption("hideDraggingHint")&&this._legendInfo&&this._legendInfo.show()),this._hasAffectedNodes(id))this._affectedNodes[id].push(nodeID);else{this._affectedNodes[id]=[nodeID];var listElement=this._generateElement(id,name,valueAll);this._list.insert(listElement)}this._updateCaseNumbersForObject(id)},removeCase:function(id,nodeID){this._hasAffectedNodes(id)&&(this._affectedNodes[id]=this._affectedNodes[id].without(nodeID),0==this._affectedNodes[id].length?(delete this._affectedNodes[id],delete this._objectColors[id],this._getListElementForObjectWithID(id).remove(),0==Object.keys(this._affectedNodes).length&&(this._legendBox.hide(),0==this._legendBox.up().select(".abnormality").size()&&this._legendInfo&&this._legendInfo.hide())):this._updateCaseNumbersForObject(id))},replaceIDs:function(changedIdsSet){for(var abnormality in this._affectedNodes)if(this._affectedNodes.hasOwnProperty(abnormality))for(var affectedList=this._affectedNodes[abnormality],i=0;i<affectedList.length;i++){var oldID=affectedList[i],newID=changedIdsSet.hasOwnProperty(oldID)?changedIdsSet[oldID]:oldID;affectedList[i]=newID}},_getListElementForObjectWithID:function(id){var HTMLid=Helpers.isInt(id)?id:this._hashID(id);return $(this._getPrefix()+"-"+HTMLid)},_updateCaseNumbersForObject:function(id){var HTMLid=Helpers.isInt(id)?id:this._hashID(id),label=this._legendBox.down("li#"+this._getPrefix()+"-"+HTMLid+" .abnormality-cases");if(label){var cases=this._affectedNodes.hasOwnProperty(id)?this._affectedNodes[id].length:0;label.update(cases+"&nbsp;case"+(cases-1&&"s"||""))}},_generateElement:function(id,name,valueAll){var color=this.getObjectColor(id),HTMLid=Helpers.isInt(id)?id:this._hashID(id),item=new Element("li",{class:"abnormality drop-"+this._getPrefix(),id:this._getPrefix()+"-"+HTMLid}).update(new Element("span",{class:"disorder-name"}).update(name.escapeHTML()));item.store("valueAll",valueAll),item.insert(new Element("input",{type:"hidden",value:id}));var bubble=new Element("span",{class:"abnormality-color"});bubble.style.backgroundColor=color,item.insert({top:bubble});var countLabel=new Element("span",{class:"abnormality-cases"}),countLabelContainer=new Element("span",{class:"abnormality-cases-container"}).insert("(").insert(countLabel).insert(")");item.insert(" ").insert(countLabelContainer);var me=this;return Element.observe(item,"mouseover",function(){item.down(".disorder-name").setStyle({background:color,cursor:"default"}),me._highlightAllByItemID(id,!0)}),Element.observe(item,"mouseout",function(){item.down(".disorder-name").setStyle({background:"",cursor:"default"}),me._highlightAllByItemID(id,!1)}),new Draggable(item,{revert:!0,reverteffect:function(segment){segment.setStyle({height:"",left:"",position:"",top:"",zIndex:"",width:""})},ghosting:!0}),item},_highlightAllByItemID:function(id,highlight){null==editor.getView().getCurrentDraggable()&&this._affectedNodes[id]&&this._affectedNodes[id].forEach(function(nodeID){var node=editor.getNode(nodeID);node&&(highlight?node.getGraphics().highlight():node.getGraphics().unHighlight())})},_onDropWrapper:function(label,target,event){if(!editor.isReadOnlyMode()){editor.getView().setCurrentDraggable(null);var valueAll=label.retrieve("valueAll"),id=label.select("input")[0].value;this._highlightAllByItemID(id,!1),this._unhighlightAfterDrag();var divPos=editor.getWorkspace().viewportToDiv(event.pointerX(),event.pointerY()),pos=editor.getWorkspace().divToCanvas(divPos.x,divPos.y),node=editor.getView().getPersonNodeNear(pos.x,pos.y);if(node){if(node.isProband()||node.isRegistered())return;this._onDropObject(node,id,valueAll)}}},_onFailedDrag:function(node,message,title){editor.getOkCancelDialogue().showCustomized(message,title,"OK",function(){node.getGraphics().getHoverBox().animateHideHoverZone()})},_onHoverWrapper:function(label,target,overlap,event){if(!editor.isReadOnlyMode()){editor.getView().setCurrentDraggable(-1);var divPos=editor.getWorkspace().viewportToDiv(event.pointerX(),event.pointerY()),pos=editor.getWorkspace().divToCanvas(divPos.x,divPos.y),node=editor.getView().getPersonNodeNear(pos.x,pos.y);if(node){if(node.isProband()||node.isRegistered())return;node.getGraphics().getHoverBox().animateHideHoverZone(),node.getGraphics().getHoverBox().setHighlighted(!0),this._previousHighightedNode=node}else this._unhighlightAfterDrag()}},_unhighlightAfterDrag:function(){this._previousHighightedNode&&(this._previousHighightedNode.getGraphics().getHoverBox().setHighlighted(!1),this._previousHighightedNode=null)},_onDropObject:function(node,objectID){throw"drop functionality is not defined"},_hashID:function(s){if(s.toLowerCase(),!Array.prototype.reduce){for(var n=0,i=0;i<s.length;i++)n+=s.charCodeAt(i);return"c"+n}return"c"+s.split("").reduce(function(a,b){return(a=(a<<5)-a+b.charCodeAt(0))&a},0)}});