/*! pedigree-editor-tool - v1.3.1 - 2017-05-22
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var PartnershipVisuals=Class.create(AbstractNodeVisuals,{initialize:function($super,partnership,x,y){$super(partnership,x,y),this._childlessShape=null,this._childlessStatusLabel=null,this._junctionShape=editor.getPaper().circle(x,y,PedigreeEditorParameters.attributes.partnershipRadius).attr(PedigreeEditorParameters.attributes.partnershipNode),this._junctionShape.node.setAttribute("class","pedigree-partnership-circle"),editor.isReadOnlyMode()?this._hoverBox=new ReadOnlyHoverbox(partnership,x,y,this.getShapes()):this._hoverBox=new PartnershipHoverbox(partnership,x,y,this.getShapes()),this.updateIDLabel(),this._childhubConnection=null,this._partnerConnections=null,this.updatePartnerConnections(),this.updateChildhubConnection()},updateIDLabel:function(){if(editor.DEBUG_MODE){var x=this.getX(),y=this.getY();this._idLabel&&this._idLabel.remove(),this._idLabel=editor.getPaper().text(x,y-20,this.getNode().getID()).attr(PedigreeEditorParameters.attributes.dragMeLabel).insertAfter(this._junctionShape.flatten())}},onSetID:function($super,id){$super(id),this.updateIDLabel()},grow:function(){this.area||(this.area=this.getJunctionShape().clone().flatten().insertBefore(this.getJunctionShape().flatten()),this.area.attr({fill:"green",stroke:"none"}),this.area.ot=this.area.transform(),this.area.attr({transform:"...S2"}))},shrink:function(){this.area&&this.area.remove(),delete this.area},markPregnancy:function(){this.mark||(this.mark=this.getJunctionShape().glow({width:10,fill:!0,opacity:.3,color:"blue"}).insertBefore(this.getJunctionShape().flatten()))},unmarkPregnancy:function(){this.mark&&this.mark.remove(),delete this.mark},markPermanently:function(){this.mark2||(this.mark2=this.getJunctionShape().glow({width:18,fill:!0,opacity:.4,color:"#ee8d00"}).insertBefore(this.getJunctionShape().flatten()))},unmark:function(){this.mark2&&this.mark2.remove(),delete this.mark2},getJunctionShape:function(){return this._junctionShape},getBottomY:function(){return this._absoluteY+PedigreeEditorParameters.attributes.partnershipRadius+PedigreeEditorParameters.attributes.parnershipChildlessLength},_isDisplayedAsConsanguinous:function(){var consangr=editor.getGraph().isConsangrRelationship(this.getNode().getID()),nodeConsangrPreference=this.getNode().getConsanguinity();return"N"==nodeConsangrPreference&&(consangr=!1),"Y"==nodeConsangrPreference&&(consangr=!0),consangr},updatePartnerConnections:function(){this._partnerConnections&&this._partnerConnections.remove(),editor.getPaper().setStart();for(var id=this.getNode().getID(),consangr=this._isDisplayedAsConsanguinous(),lineAttr=consangr?PedigreeEditorParameters.attributes.consangrPartnershipLines:PedigreeEditorParameters.attributes.partnershipLines,lineAttrNoContact=consangr?PedigreeEditorParameters.attributes.noContactLinesConsangr:PedigreeEditorParameters.attributes.noContactLines,partnerPaths=editor.getGraph().getPathToParents(id),cornerRadius=PedigreeEditorParameters.attributes.curvedLinesCornerRadius,p=0;p<partnerPaths.length;p++){for(var path=partnerPaths[p],person=path[path.length-1],finalSegmentInfo=editor.getGraph().getRelationshipLineInfo(id,person),nodePos=editor.getGraph().getPosition(person),finalPosition=editor.convertGraphCoordToCanvasCoord(nodePos.x,nodePos.y),finalYTo=editor.convertGraphCoordToCanvasCoord(0,finalSegmentInfo.attachY).y,yTop=editor.convertGraphCoordToCanvasCoord(0,finalSegmentInfo.verticalY).y,lastBend=finalYTo==yTop&&yTop<this.getY()&&1==finalSegmentInfo.attachmentPort?1/0:finalSegmentInfo.numAttachPorts>1?PedigreeEditorParameters.attributes.radius*(1.8+.1*finalSegmentInfo.numAttachPorts-.35*finalSegmentInfo.attachmentPort):1.6*PedigreeEditorParameters.attributes.radius,goesLeft=!1,xFrom=this.getX(),yFrom=this.getY(),xTo=xFrom,yTo=yFrom,prevY=yFrom,prevX=xFrom,vertical=!1,wasAngle=!1,firstDraw=!0,i=0;i<path.length;i++){var nextNodeOnPath=path[i],nodePos=editor.getGraph().getPosition(nextNodeOnPath),position=editor.convertGraphCoordToCanvasCoord(nodePos.x,nodePos.y);editor.DEBUG_MODE&&editor.getPaper().text(position.x,position.y,nextNodeOnPath).attr(PedigreeEditorParameters.attributes.dragMeLabel).toFront().node.setAttribute("class","no-mouse-interaction"),position.x<xFrom?goesLeft=!0:position.x>xFrom&&(goesLeft=!1);var newVertical=prevY!=position.y,angled=prevX!=position.x&&prevY!=position.y,changesDirection=vertical&&!newVertical||!vertical&&newVertical||angled;i==path.length-1&&prevY==yTop&&(angled=!1,changesDirection=xFrom!=xTo||yFrom!=yTo,newVertical=!1),0==i&&goesLeft&&this.getNode().getBrokenStatus()&&(editor.getView().drawLineWithCrossings(id,xFrom,yFrom,xFrom-16,yFrom,lineAttr,consangr,goesLeft,!1,firstDraw),editor.getPaper().path("M "+(xFrom-29)+" "+(yFrom+9)+" L "+(xFrom-15)+" "+(yFrom-9)).attr(lineAttr).toBack(),editor.getPaper().path("M "+(xFrom-24)+" "+(yFrom+9)+" L "+(xFrom-10)+" "+(yFrom-9)).attr(lineAttr).toBack(),xFrom-=23,firstDraw=!1),changesDirection&&(editor.getView().drawLineWithCrossings(id,xFrom,yFrom,xTo,yTo,lineAttr,consangr,goesLeft,!1,firstDraw),xFrom=xTo,yFrom=yTo,firstDraw=!1),xTo=position.x,yTo=i>=path.length-2?yTop:position.y,prevY=position.y,prevX=position.x,(!wasAngle&&!angled||i>=path.length-2&&path.length>1)&&(newVertical&&!vertical?xTo<xFrom?(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom-cornerRadius,yFrom-cornerRadius,!0,lineAttr,consangr,2.5,-2.5,-2.5,2.5),xFrom-=cornerRadius,yFrom-=cornerRadius):(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom+cornerRadius,yFrom-cornerRadius,!0,lineAttr,consangr,2.5,2.5,-2.5,-2.5),xFrom+=cornerRadius,yFrom-=cornerRadius):!newVertical&&vertical?xTo<xFrom?(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom-cornerRadius,yFrom-cornerRadius,!1,lineAttr,consangr,-2.5,2.5,2.5,-2.5),xFrom-=cornerRadius,yFrom-=cornerRadius):(GraphicHelpers.drawCornerCurve(xFrom,yFrom,xFrom+cornerRadius,yFrom-cornerRadius,!1,lineAttr,consangr,2.5,2.5,-2.5,-2.5),xFrom+=cornerRadius,yFrom-=cornerRadius):newVertical?yTo+=cornerRadius:i!=path.length-1&&(position.x>xFrom?xTo-=cornerRadius:xTo+=cornerRadius)),vertical=newVertical,wasAngle=angled}var thisLineAttr=!editor.getView().getNode(person).isProband()&&editor.getView().getNode(person).getLostContact()&&editor.getGraph().isPartnershipRelatedToProband(id)?lineAttrNoContact:lineAttr;yFrom>=finalPosition.y+2*cornerRadius?editor.getView().drawLineWithCrossings(id,xFrom,yFrom,xTo,finalYTo,thisLineAttr,consangr,!1,firstDraw):editor.getView().drawCurvedLineWithCrossings(id,xFrom,yFrom,yTop,xTo,finalYTo,lastBend,thisLineAttr,consangr,goesLeft,firstDraw)}this._partnerConnections=editor.getPaper().setFinish().toBack(),this.getNode().getGraphics()&&(this.getHoverBox().regenerateHandles(),this.getHoverBox().regenerateButtons())},updateChildhubConnection:function(){this._childhubConnection&&this._childhubConnection.remove();var twinCommonVerticalPieceLength=PedigreeEditorParameters.attributes.twinCommonVerticalLength,positionedGraph=editor.getGraph(),id=this.getNode().getID(),childlinePos=positionedGraph.getRelationshipChildhubPosition(id),childlineY=editor.convertGraphCoordToCanvasCoord(childlinePos.x,childlinePos.y).y,children=positionedGraph.getRelationshipChildrenSortedByOrder(id);if(1==children.length&&editor.getGraph().isPlaceholder(children[0]))return editor.getPaper().setStart(),void(this._childhubConnection=editor.getPaper().setFinish());editor.getPaper().setStart();for(var leftmostX=this.getX(),rightmostX=this.getX(),currentTwinGroup=null,currentTwinGroupCenterX=null,currentIsMonozygothic=!1,numPregnancies=0,allChildrenLostContact=!0,j=0;j<children.length;j++){var child=children[j],twinGroupId=positionedGraph.getTwinGroupId(child);if(twinGroupId!=currentTwinGroup){numPregnancies++,currentTwinGroup=twinGroupId;var allTwins=positionedGraph.getAllTwinsSortedByOrder(child),positionL=editor.getView().getNode(allTwins[0]).getX(),positionR=editor.getView().getNode(allTwins[allTwins.length-1]).getX(),positionY=editor.getView().getNode(allTwins[0]).getY();if(currentTwinGroupCenterX=(positionL+positionR)/2,3==allTwins.length&&(currentTwinGroupCenterX=editor.getView().getNode(allTwins[1]).getX()),editor.getView().drawLineWithCrossings(id,currentTwinGroupCenterX,childlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,PedigreeEditorParameters.attributes.partnershipLines),currentIsMonozygothic=editor.getView().getNode(allTwins[0]).getMonozygotic()){var twinlineY=childlineY+PedigreeEditorParameters.attributes.twinMonozygothicLineShiftY,xIntercept1=GraphicHelpers.findXInterceptGivenLineAndY(twinlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,positionL,positionY),xIntercept2=GraphicHelpers.findXInterceptGivenLineAndY(twinlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,positionR,positionY);editor.getView().drawLineWithCrossings(id,xIntercept1,twinlineY,xIntercept2,twinlineY,PedigreeEditorParameters.attributes.partnershipLines)}}else null==twinGroupId&&(numPregnancies++,currentIsMonozygothic=!1);var childX=editor.getView().getNode(child).getX(),childY=editor.getView().getNode(child).getY(),topLineX=null===currentTwinGroup?childX:currentTwinGroupCenterX,topLineY=null===currentTwinGroup?childlineY:childlineY+twinCommonVerticalPieceLength;topLineX>rightmostX&&(rightmostX=topLineX),topLineX<leftmostX&&(leftmostX=topLineX);var lostContact=(editor.getGraph().isChildOfProband(child)||editor.getGraph().isSiblingOfProband(child))&&editor.getView().getNode(child).getLostContact();lostContact||(allChildrenLostContact=!1);lineAttr=lostContact?PedigreeEditorParameters.attributes.noContactLines:PedigreeEditorParameters.attributes.partnershipLines;if(editor.getGraph().isAdoptedIn(child)&&(lineAttr=lostContact?PedigreeEditorParameters.attributes.noContactAdoptedIn:PedigreeEditorParameters.attributes.partnershipLinesAdoptedIn),currentIsMonozygothic&&childX!=positionL&&childX!=positionR){var xIntercept=GraphicHelpers.findXInterceptGivenLineAndY(twinlineY,currentTwinGroupCenterX,childlineY+twinCommonVerticalPieceLength,childX,childY);editor.getView().drawLineWithCrossings(id,xIntercept,twinlineY,childX,childY,lineAttr)}else editor.getView().drawLineWithCrossings(id,topLineX,topLineY,childX,childY,lineAttr)}var lineAttr=allChildrenLostContact?PedigreeEditorParameters.attributes.noContactLines:PedigreeEditorParameters.attributes.partnershipLines;editor.getView().drawLineWithCrossings(id,leftmostX,childlineY,rightmostX,childlineY,lineAttr);var fromY=this._isDisplayedAsConsanguinous()?this.getY()+2:this.getY();if(editor.getView().drawLineWithCrossings(id,this.getX(),fromY,this.getX(),childlineY,lineAttr),editor.DEBUG_MODE){var childhubID=positionedGraph.DG.GG.getOutEdges(id)[0];editor.getPaper().text(this.getX(),childlineY,childhubID).attr(PedigreeEditorParameters.attributes.dragMeLabel).toFront().node.setAttribute("class","no-mouse-interaction")}numPregnancies>1&&editor.getPaper().circle(this.getX(),childlineY,PedigreeEditorParameters.attributes.partnershipRadius/2).attr({fill:"#666666",stroke:"#888888","stroke-width":1,opacity:1}),this._childhubConnection=editor.getPaper().setFinish()},setPos:function($super,x,y,animate,callback){if(this.getHoverBox().removeHandles(),this.getHoverBox().removeButtons(),animate)throw"Can't animate a partnership node";this.mark&&this.mark.remove(),this.mark2&&this.mark2.remove(),this.getAllGraphics().transform("t "+(x-this.getX())+","+(y-this.getY())+"..."),$super(x,y,animate,callback),this.updatePartnerConnections(),this.updateChildhubConnection(),this.updateChildlessStatusLabel()},remove:function(){this.getJunctionShape().remove(),this.getHoverBox().remove(),this._idLabel&&this._idLabel.remove(),this.getChildlessShape()&&this.getChildlessShape().remove(),this.getChildlessStatusLabel()&&this.getChildlessStatusLabel().remove(),this._childhubConnection&&this._childhubConnection.remove(),this._partnerConnections&&this._partnerConnections.remove(),this.area&&this.area.remove(),this.mark&&this.mark.remove(),this.mark2&&this.mark2.remove()},getShapes:function($super){return $super().push(this.getJunctionShape())},getAllGraphics:function($super){return editor.getPaper().set(this.getHoverBox().getBackElements(),this._idLabel,this._childlessShape).concat($super()).push(this.getHoverBox().getFrontElements())},drawLabels:function(){},getChildlessShapeAttr:function(){return PedigreeEditorParameters.attributes.partnershipChildlessShapeAttr}});PartnershipVisuals.addMethods(ChildlessBehaviorVisuals);