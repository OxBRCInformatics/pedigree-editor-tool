/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var AbstractPersonVisuals=Class.create(AbstractNodeVisuals,{initialize:function($super,node,x,y){$super(node,x,y),this._radius=PedigreeEditorParameters.attributes.radius,this._width=4*PedigreeEditorParameters.attributes.radius,this._highlightBox=null,this._adoptedShape=null,this._genderShape=null,this._genderGraphics=null,this._numberLabel=null,this.setGenderGraphics(),this.setHighlightBox(),this.updateIDLabel(),this._hoverBox=this.generateHoverbox(x,y)},updateIDLabel:function(){if(editor.DEBUG_MODE){var x=this.getX(),y=this.getY();this._idLabel&&this._idLabel.remove(),this._idLabel=editor.getPaper().text(x,y,this.getNode().getID()).attr(PedigreeEditorParameters.attributes.dragMeLabel).toFront(),this._idLabel.node.setAttribute("class","no-mouse-interaction")}},updateNumberLabel:function(){if(this._numberLabel&&this._numberLabel.remove(),""!=this.getNode().getPedNumber()){var x=this.getX(),y=this.getY();this._numberLabel=editor.getPaper().text(x,y,this.getNode().getPedNumber()).attr(PedigreeEditorParameters.attributes.pedNumberLabel).toFront(),this._numberLabel.node.setAttribute("class","no-mouse-interaction")}},generateHoverbox:function(x,y){return null},onSetID:function($super,id){$super(id),this.updateIDLabel()},setPos:function($super,x,y,animate,callback){this.getHoverBox().removeHandles(),this.getHoverBox().removeButtons();var moveX=x-this.getX(),moveY=y-this.getY();if(0!=moveX||0!=moveY)if($super(x,y,animate),animate){var me=this;this._callback=function(){me._toMark&&(me.markPermanently(),delete me._toMark),delete me._callback,callback&&callback()},this.getAllGraphics().animate({transform:"t "+moveX+","+moveY+"..."},900,"linear",me._callback)}else this.getAllGraphics().transform("t "+moveX+","+moveY+"..."),callback&&callback()},grow:function($super){if($super(),this._callback)throw"Assertion failed: grow() during animation";this.glow||(this.glow=this._genderShape.glow({width:11,fill:!0,opacity:.4,color:"green"}),this.marked&&this.marked.hide())},shrink:function($super){this.glow&&this.glow.remove(),delete this.glow,this.marked&&this.marked.show(),$super()},markPermanently:function(){if(this._callback&&!this._toMark)return void(this._toMark=!0);this.marked||(this.marked=this._genderShape.glow({width:11,fill:!0,opacity:.6,color:"#ee8d00"}))},unmark:function(){this.marked&&this.marked.remove(),delete this.marked},containsXY:function(x,y){return Math.abs(x-this.getX())<=PedigreeEditorParameters.attributes.personHoverBoxRadius&&Math.abs(y-this.getY())<=PedigreeEditorParameters.attributes.personHoverBoxRadius},getBottomY:function(){return this._absoluteY+this._radius+PedigreeEditorParameters.attributes.childlessLength},drawAdoptedShape:function(){if(this._adoptedShape&&this._adoptedShape.remove(),""!=this.getNode().getAdopted()){var r=PedigreeEditorParameters.attributes.radius,y=this.getY()-1.3*r+2;if("adoptedOut"==this.getNode().getAdopted()&&editor.getPreferencesManager().getConfigurationOption("nonStandardAdoptedOutGraphic"))var x1=this.getX()-1.7*r,x2=this.getX()+1.7*r,coeff=2.5;else var x1=this.getX()-.9*r,x2=this.getX()+.9*r,coeff=-2.5;brackets="M"+x1+" "+y+"l"+r/coeff+" 0l0 "+(2.6*r-4)+"l"+r/-coeff+" 0M"+x2+" "+y+"l"+r/-coeff+" 0l0 "+(2.6*r-4)+"l"+r/coeff+" 0",this._adoptedShape=editor.getPaper().path(brackets).attr("stroke-width",2.5),this._adoptedShape.toBack()}},getAdoptedShape:function(){return this._adoptedShape},getShapes:function($super){var shapes=$super().push(this.getGenderGraphics());return this.getAdoptedShape()&&shapes.push(this.getAdoptedShape()),shapes},getAllGraphics:function($super){return editor.getPaper().set(this.getHighlightBox(),this._idLabel,this._numberLabel).concat($super())},getGenderGraphics:function(){return this._genderGraphics},getGenderShape:function(){return this._genderShape},setGenderGraphics:function(){this.unmark(),this._genderGraphics&&this._genderGraphics.remove();var gender=this.getNode().getGender();this._shapeRadius="U"==gender||"O"==gender?1.1*PedigreeEditorParameters.attributes.radius/Math.sqrt(2):PedigreeEditorParameters.attributes.radius,this.getNode().isPersonGroup()&&(this._shapeRadius*=PedigreeEditorParameters.attributes.groupNodesScale);var shape,x=this.getX(),y=this.getY(),radius=this._shapeRadius;if(shape="F"==gender?editor.getPaper().circle(x,y,radius):editor.getPaper().rect(x-radius,y-radius,2*radius,2*radius),"U"==gender?(shape.attr(PedigreeEditorParameters.attributes.nodeShapeDiag),shape.attr({transform:"...R45"})):"O"==gender?(shape.attr(PedigreeEditorParameters.attributes.nodeShapeOther),shape.attr({transform:"...R45"})):"M"==gender?shape.attr(PedigreeEditorParameters.attributes.nodeShapeMale):"F"==gender&&shape.attr(PedigreeEditorParameters.attributes.nodeShapeFemale),this._genderShape=shape,!editor.isUnsupportedBrowser()&&editor.getPreferencesManager().getConfigurationOption("drawNodeShadows")){var shadow=this.makeNodeShadow(shape);this._genderGraphics=editor.getPaper().set(shadow,shape)}else this._genderGraphics=editor.getPaper().set(shape)},makeNodeShadow:function(shape){var shadow=shape.clone().attr({stroke:"none",fill:"gray",opacity:.3});return shadow.translate(3,3),shadow.insertBefore(shape),shadow.node.setAttribute("class","pedigree-node-shadow"),shadow},setHighlightBox:function(){this._highlightBox&&this._highlightBox.remove();var radius=PedigreeEditorParameters.attributes.personHoverBoxRadius;this._highlightBox=editor.getPaper().rect(this.getX()-radius,this.getY()-radius,2*radius,2*radius,5).attr(PedigreeEditorParameters.attributes.boxOnHover),this._highlightBox.attr({fill:"black",opacity:0,"fill-opacity":0}),this._highlightBox.insertBefore(this.getGenderGraphics().flatten())},getHighlightBox:function(){return this._highlightBox},highlight:function(){this.getHighlightBox()&&this.getHighlightBox().attr({opacity:.5,"fill-opacity":.5})},unHighlight:function(){this.getHighlightBox().attr({opacity:0,"fill-opacity":0})},remove:function($super){this.marked&&this.marked.remove(),$super()}});