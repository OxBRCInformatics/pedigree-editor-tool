/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var PersonVisuals=Class.create(AbstractPersonVisuals,{initialize:function($super,node,x,y){$super(node,x,y),this._nameLabel=null,this._stillBirthLabel=null,this._ageLabel=null,this._externalIDLabel=null,this._commentsLabel=null,this._cancerAgeOfOnsetLabels={},this._childlessStatusLabel=null,this._disorderShapes=null,this._deadShape=null,this._unbornShape=null,this._childlessShape=null,this._isSelected=!1,this._carrierGraphic=null,this._evalLabel=null},generateHoverbox:function(x,y){return editor.isReadOnlyMode()?new ReadOnlyHoverbox(this.getNode(),x,y,this.getGenderGraphics()):new PersonHoverbox(this.getNode(),x,y,this.getGenderGraphics())},updateAgeLabelForGELDirectly:function(text){this.getAgeLabel()&&this.getAgeLabel().remove(),this._ageLabel=text?editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.label):null,this._ageLabel&&(this._ageLabel.node.setAttribute("class","field-no-user-select"),text&&text.indexOf("\n")>0&&(this._ageLabel.alignTop=!0)),this.drawLabels()},setGenderGraphics:function($super){if("aborted"==this.getNode().getLifeStatus()||"miscarriage"==this.getNode().getLifeStatus()){this._genderGraphics&&this._genderGraphics.remove();var radius=PedigreeEditorParameters.attributes.radius;this.getNode().isPersonGroup()&&(radius*=PedigreeEditorParameters.attributes.groupNodesScale),this._shapeRadius=radius;var height=radius*Math.sqrt(3.5)/Math.sqrt(2),x=this.getX()-height,y=this.getY(),shape=editor.getPaper().path(["M",x,y,"l",height,-height,"l",height,height,"z"]);if(shape.attr(PedigreeEditorParameters.attributes.nodeShapeAborted),this._genderShape=shape,editor.getPreferencesManager().getConfigurationOption("drawNodeShadows")){var shadow=this.makeNodeShadow(shape);shape=editor.getPaper().set(shadow,shape)}else shape=editor.getPaper().set(shape);this.getNode().isProband()&&(shape.transform(["...s",1.07]),shape.attr("stroke-width",5));var gender=this.getNode().getGender();if("U"==gender||"O"==gender)this._genderGraphics=shape;else{x=this.getX(),y=this.getY()+radius/1.4;var text="M"==gender?"Male":"Female",genderLabel=editor.getPaper().text(x,y,text).attr(PedigreeEditorParameters.attributes.label);this._genderGraphics=editor.getPaper().set(shape,genderLabel)}}else $super();this.getNode().isProband()&&(this._genderGraphics.push(this.generateProbandArrow()),this.getGenderShape().transform(["...s",1.08]),this.getGenderShape().attr("stroke-width",5.5)),!editor.isUnsupportedBrowser()&&this.getHoverBox()&&this._genderGraphics.flatten().insertBefore(this.getFrontElements().flatten()),this.updateDisorderShapes(),this.updateCarrierGraphic(),this.updateEvaluationLabel(),"unborn"==this.getNode().getLifeStatus()&&this.updateLifeStatusShapes("unborn")},generateProbandArrow:function(){var icon=editor.getPaper().path(editor.getView().__probandArrowPath).attr({fill:"#595959",stroke:"none",opacity:1}),x=this.getX()-this._shapeRadius-26,y=this.getY()+this._shapeRadius-12;return"F"==this.getNode().getGender()&&(x+=5,y-=5),icon.transform(["t",x,y]),icon},getBackElements:function(){return this.getHoverBox().getBackElements().concat(editor.getPaper().set(this.getChildlessStatusLabel(),this.getChildlessShape()))},getFrontElements:function(){return this.getHoverBox().getFrontElements()},updateExternalIDLabel:function(){if(this._externalIDLabel&&this._externalIDLabel.remove(),this.getNode().getParticipantId()){var number=this.getNode().getNHSNumber(),type="nhs";number&&void 0!==number||(number=this.getNode().getCHINumber(),type="chi");var text="{gel:"+this.getNode().getParticipantId()+"}";number&&(text+="["+type+":"+number+"]"),this._externalIDLabel=editor.getPaper().text(this.getX(),this.getY()+PedigreeEditorParameters.attributes.radius,text).attr(PedigreeEditorParameters.attributes.externalIDLabels)}else this._externalIDLabel=null;this.drawLabels()},getExternalIDLabel:function(){return this._externalIDLabel},updateNameLabel:function(){this._nameLabel&&this._nameLabel.remove();var disabledFields=editor.getPreferencesManager().getConfigurationOption("disabledFields"),text="";this.getNode().getFirstName()&&!Helpers.arrayContains(disabledFields,"first_name")&&(text=this.getNode().getFirstName());var lastNameAtBirth=this.getNode().getLastNameAtBirth()&&!Helpers.arrayContains(disabledFields,"last_name_birth")?this.getNode().getLastNameAtBirth():"";this.getNode().getLastName()&&!Helpers.arrayContains(disabledFields,"last_name")&&(text+=" "+this.getNode().getLastName(),lastNameAtBirth=lastNameAtBirth==this.getNode().getLastName()||""===lastNameAtBirth?"":"("+lastNameAtBirth+")"),text+=" "+lastNameAtBirth,this._nameLabel&&this._nameLabel.remove(),""!=text.strip()?(this._nameLabel=editor.getPaper().text(this.getX(),this.getY()+PedigreeEditorParameters.attributes.radius,text).attr(PedigreeEditorParameters.attributes.nameLabels),this._nameLabel.node.setAttribute("class","field-no-user-select")):this._nameLabel=null,this.drawLabels()},getNameLabel:function(){return this._nameLabel},getDisorderShapes:function(){return this._disorderShapes},updateDisorderShapes:function(){this._disorderShapes&&this._disorderShapes.remove();var colors=this.getNode().getAllNodeColors();if(0!=colors.length){var delta,color,disorderShapes=editor.getPaper().set();if("aborted"==this.getNode().getLifeStatus()||"miscarriage"==this.getNode().getLifeStatus()){radius=PedigreeEditorParameters.attributes.radius;this.getNode().isPersonGroup()&&(radius*=PedigreeEditorParameters.attributes.groupNodesScale);var height=radius*Math.sqrt(3.5)/Math.sqrt(2),x1=this.getX()-height,y1=this.getY();delta=2*height/colors.length;for(var k=0;k<colors.length;k++){var corner=[],x2=x1+delta,y2=this.getY()-(height-Math.abs(x2-this.getX()));x1<this.getX()&&x2>=this.getX()&&(corner=["L",this.getX(),this.getY()-height]);var slice=editor.getPaper().path(["M",x1,y1,corner,"L",x2,y2,"L",this.getX(),this.getY(),"z"]);color=colors[k],disorderShapes.push(slice.attr({fill:color,"stroke-width":.5,stroke:"none"})),x1=x2,y1=y2}this.getNode().isProband()&&disorderShapes.transform(["...s",1.04,1.04,this.getX(),this.getY()-this._shapeRadius])}else{var disorderAngle=360/colors.length;delta=360/colors.length/2,1!=colors.length||"U"!=this.getNode().getGender()&&"O"!=this.getNode().getGender()||(delta-=45);var radius=this._shapeRadius-.6;"U"!=this.getNode().getGender()&&"O"!=this.getNode().getGender()||(radius*=1.155);for(var i=0;i<colors.length;i++)color=colors[i],disorderShapes.push(GraphicHelpers.sector(editor.getPaper(),this.getX(),this.getY(),radius,this.getNode().getGender(),i*disorderAngle,(i+1)*disorderAngle,color));disorderShapes.length<2?disorderShapes.attr("stroke","none"):disorderShapes.attr({stroke:"#595959","stroke-width":.03}),this.getNode().isProband()&&disorderShapes.transform(["...s",1.04,1.04,this.getX(),this.getY()])}this._disorderShapes=disorderShapes,this._disorderShapes.flatten().insertAfter(this.getGenderGraphics().flatten())}},drawDeadShape:function(){var strokeWidth=editor.getWorkspace().getSizeNormalizedToDefaultZoom(2.5);if("aborted"==this.getNode().getLifeStatus()){var height=PedigreeEditorParameters.attributes.radius*Math.sqrt(3.5)/Math.sqrt(2);this.getNode().isPersonGroup()&&(height*=PedigreeEditorParameters.attributes.groupNodesScale);var x=this.getX()-height/1.5;this.getNode().isPersonGroup()&&(x-=PedigreeEditorParameters.attributes.radius/4);var y=this.getY()+height/3;this._deadShape=editor.getPaper().path(["M",x,y,"l",height+height/3,-(height+height/3),"z"]),this._deadShape.attr("stroke-width",strokeWidth)}else{x=this.getX(),y=this.getY();var coeff=1.25*(this.getNode().isPersonGroup()?PedigreeEditorParameters.attributes.groupNodesScale:1),x1=x-coeff*PedigreeEditorParameters.attributes.radius,y1=y+coeff*PedigreeEditorParameters.attributes.radius,x2=x+coeff*PedigreeEditorParameters.attributes.radius,y2=y-coeff*PedigreeEditorParameters.attributes.radius;this._deadShape=editor.getPaper().path(["M",x1,y1,"L",x2,y2]).attr("stroke-width",strokeWidth)}editor.isUnsupportedBrowser()||(this._deadShape.toFront(),this._deadShape.node.setAttribute("class","no-mouse-interaction"))},getDeadShape:function(){return this._deadShape},getAgeLabel:function(){return this._ageLabel},updateAgeLabel:function(){var text,person=this.getNode();if(person.isFetus()){var date=person.getGestationAge();text=date?date+" weeks":null}else{var birthDate=person.getBirthDate(),deathDate=person.getDeathDate(),dateFormat=editor.getPreferencesManager().getConfigurationOption("dateDisplayFormat");if("DMY"==dateFormat||"MY"==dateFormat)"alive"==person.getLifeStatus()?birthDate&&birthDate.isComplete()&&(text="b. "+person.getBirthDate().getBestPrecisionStringDDMMYYY(dateFormat),null!==person.getBirthDate().getYear()&&(text+=" ("+(age=AgeCalc.getAge(person.getBirthDate()))+")")):deathDate&&birthDate&&deathDate.isComplete()&&birthDate.isComplete()?(text=person.getBirthDate().getBestPrecisionStringDDMMYYY(dateFormat)+" - "+person.getDeathDate().getBestPrecisionStringDDMMYYY(dateFormat),null!==person.getBirthDate().getYear()&&null!==person.getDeathDate().getYear()&&(text+="\n"+(age=AgeCalc.getAge(person.getBirthDate(),person.getDeathDate())))):deathDate&&deathDate.isComplete()?text="d. "+person.getDeathDate().getBestPrecisionStringDDMMYYY(dateFormat):birthDate&&birthDate.isComplete()&&(text=person.getBirthDate().getBestPrecisionStringDDMMYYY(dateFormat)+" - ?");else if("alive"==person.getLifeStatus()){if(birthDate)if(birthDate.onlyDecadeAvailable())text="b. "+birthDate.getDecade();else{age=AgeCalc.getAge(birthDate,null);null==birthDate.getMonth()?text="b. "+birthDate.getYear():null==birthDate.getDay()||"MMY"==dateFormat?text="b. "+birthDate.getMonthName()+" "+birthDate.getYear():(text="b. "+birthDate.getMonthName()+" "+birthDate.getDay()+", "+birthDate.getYear(),-1==age.indexOf("day")&&-1==age.indexOf("wk")||(text+=" ("+age+")"))}}else if(deathDate&&birthDate){var age=AgeCalc.getAge(birthDate,deathDate);null==deathDate.getYear()||null==deathDate.getMonth()||-1==age.indexOf("day")&&-1==age.indexOf("wk")&&-1==age.indexOf("mo")?(text=birthDate.getBestPrecisionStringYear()+" - "+deathDate.getBestPrecisionStringYear(),""!==age&&(text+="\n"+age)):text="d. "+deathDate.getYear(!0)+" ("+age+")"}else deathDate?text="d. "+deathDate.getBestPrecisionStringYear():birthDate&&(text=birthDate.getBestPrecisionStringYear()+" - ?")}this.getAgeLabel()&&this.getAgeLabel().remove(),this._ageLabel=text?editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.label):null,this._ageLabel&&(this._ageLabel.node.setAttribute("class","field-no-user-select"),text&&text.indexOf("\n")>0&&(this._ageLabel.alignTop=!0)),this.drawLabels()},getUnbornShape:function(){return this._unbornShape},drawUnbornShape:function(){this._unbornShape&&this._unbornShape.remove(),"unborn"==this.getNode().getLifeStatus()?(this._unbornShape=editor.getPaper().text(this.getX(),this.getY(),"P").attr(PedigreeEditorParameters.attributes.unbornShape),editor.isUnsupportedBrowser()||this._unbornShape.insertBefore(this.getHoverBox().getFrontElements())):this._unbornShape=null},updateEvaluationLabel:function(){if(this._evalLabel&&this._evalLabel.remove(),this.getNode().getEvaluated()){if("aborted"==this.getNode().getLifeStatus()||"miscarriage"==this.getNode().getLifeStatus())var x=this.getX()+1.6*this._shapeRadius,y=this.getY()+.6*this._shapeRadius;else{var mult=1.1;"U"==this.getNode().getGender()?mult=1.3:"M"==this.getNode().getGender()&&(mult=1.4),this.getNode().isProband&&(mult*=1.1);var x=this.getX()+this._shapeRadius*mult-5,y=this.getY()+this._shapeRadius*mult}this._evalLabel=editor.getPaper().text(x,y,"*").attr(PedigreeEditorParameters.attributes.evaluationShape).toBack()}else this._evalLabel=null},getEvaluationGraphics:function(){return this._evalLabel},updateCarrierGraphic:function(){this._carrierGraphic&&this._carrierGraphic.remove();var status=this.getNode().getCarrierStatus();if(""!=status&&"affected"!=status){if("carrier"==status){if("aborted"==this.getNode().getLifeStatus()||"miscarriage"==this.getNode().getLifeStatus())var x=this.getX(),y=this.getY()-this._radius/2;else var x=this.getX(),y=this.getY();this._carrierGraphic=editor.getPaper().circle(x,y,PedigreeEditorParameters.attributes.carrierDotRadius).attr(PedigreeEditorParameters.attributes.carrierShape)}else if("uncertain"==status){if("aborted"==this.getNode().getLifeStatus()||"miscarriage"==this.getNode().getLifeStatus())var x=this.getX(),y=this.getY()-this._radius/2,fontAttr=PedigreeEditorParameters.attributes.uncertainSmallShape;else var x=this.getX(),y=this.getY(),fontAttr=PedigreeEditorParameters.attributes.uncertainShape;this._carrierGraphic=editor.getPaper().text(x,y,"?").attr(fontAttr)}else if("presymptomatic"==status){if("aborted"==this.getNode().getLifeStatus()||"miscarriage"==this.getNode().getLifeStatus())return void(this._carrierGraphic=null);editor.getPaper().setStart();var startX=this.getX()-PedigreeEditorParameters.attributes.presymptomaticShapeWidth/2,startY=this.getY()-this._radius;if(editor.getPaper().rect(startX,startY,PedigreeEditorParameters.attributes.presymptomaticShapeWidth,2*this._radius).attr(PedigreeEditorParameters.attributes.presymptomaticShape),"U"==this.getNode().getGender()){editor.getPaper().path("M "+startX+" "+startY+"L "+this.getX()+" "+(this.getY()-1.1*this._radius)+"L "+(startX+PedigreeEditorParameters.attributes.presymptomaticShapeWidth)+" "+startY+"Z").attr(PedigreeEditorParameters.attributes.presymptomaticShape);var endY=this.getY()+this._radius;editor.getPaper().path("M "+startX+" "+endY+"L "+this.getX()+" "+(this.getY()+1.1*this._radius)+"L "+(startX+PedigreeEditorParameters.attributes.presymptomaticShapeWidth)+" "+endY+"Z").attr(PedigreeEditorParameters.attributes.presymptomaticShape)}this._carrierGraphic=editor.getPaper().setFinish()}editor.isReadOnlyMode()?this._carrierGraphic.toFront():this._carrierGraphic.insertBefore(this.getHoverBox().getFrontElements())}else this._carrierGraphic=null},getCarrierGraphics:function(){return this._carrierGraphic},getSBLabel:function(){return this._stillBirthLabel},updateSBLabel:function(){this.getSBLabel()&&this.getSBLabel().remove(),"stillborn"==this.getNode().getLifeStatus()?this._stillBirthLabel=editor.getPaper().text(this.getX(),this.getY(),"SB").attr(PedigreeEditorParameters.attributes.label):this._stillBirthLabel=null,this.drawLabels()},getCommentsLabel:function(){return this._commentsLabel},updateCommentsLabel:function(){if(this.getCommentsLabel()&&this.getCommentsLabel().remove(),""!=this.getNode().getComments()){var text=this.getNode().getComments().replace(/^\s+|\s+$/g,"").replace(/\n\n/gi,"\n \n");this._commentsLabel=editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.commentLabel),this._commentsLabel.node.setAttribute("class","field-no-user-select"),this._commentsLabel.alignTop=!0,this._commentsLabel.addGap=!0}else this._commentsLabel=null;this.drawLabels()},getCancerAgeOfOnsetLabels:function(){return this._cancerAgeOfOnsetLabels},updateCancerAgeOfOnsetLabels:function(){var cancerLabels=this.getCancerAgeOfOnsetLabels();if(!Helpers.isObjectEmpty(cancerLabels))for(var cancerName in cancerLabels)cancerLabels[cancerName].remove();var cancerData=this.getNode().getCancers();if(!Helpers.isObjectEmpty(cancerData)&&editor.getPreferencesManager().getConfigurationOption("displayCancerLabels")){for(var cancerName in cancerData)if(cancerData.hasOwnProperty(cancerName)&&cancerData[cancerName].affected){var text=cancerName.toString()+" ca.";if(cancerData[cancerName].hasOwnProperty("ageAtDiagnosis")&&cancerData[cancerName].ageAtDiagnosis.length>0){var age=cancerData[cancerName].ageAtDiagnosis;isNaN(parseInt(age))?text+="before_1"==age?" dx <1":"before_10"==age?" dx <10":age.indexOf("before_")>-1?" dx "+(parseInt(age.substring(7))-10)+"'s":" dx >100":text+=" dx "+cancerData[cancerName].ageAtDiagnosis}else text+=" dx ?";this.getCancerAgeOfOnsetLabels()[cancerName]&&this.getCancerAgeOfOnsetLabels()[cancerName].remove(),this._cancerAgeOfOnsetLabels[cancerName]=editor.getPaper().text(this.getX(),this.getY(),text).attr(PedigreeEditorParameters.attributes.cancerAgeOfOnsetLabels),this._cancerAgeOfOnsetLabels[cancerName].node.setAttribute("class","field-no-user-select"),this._cancerAgeOfOnsetLabels[cancerName].alignTop=!0,this._cancerAgeOfOnsetLabels[cancerName].addGap=!0}}else this._cancerAgeOfOnsetLabels={};this.drawLabels()},updateLifeStatusShapes:function(oldStatus){var status=this.getNode().getLifeStatus();this.getDeadShape()&&this.getDeadShape().remove(),this.getUnbornShape()&&this.getUnbornShape().remove(),this.getSBLabel()&&this.getSBLabel().remove(),("aborted"==oldStatus||"miscarriage"==oldStatus)!=("aborted"==status||"miscarriage"==status)&&this.setGenderGraphics(),"deceased"==status||"aborted"==status?this.drawDeadShape():"stillborn"==status?(this.drawDeadShape(),this.updateSBLabel()):"unborn"==status&&this.drawUnbornShape(),this.updateAgeLabel()},setSelected:function($super,isSelected){$super(isSelected),isSelected?this.shiftLabels():this.unshiftLabels()},shiftLabels:function(){for(var shift=this._labelSelectionOffset(),labels=this.getLabels(),i=0;i<labels.length;i++)labels[i].stop().animate({y:labels[i].oy+shift},200,">")},unshiftLabels:function(){for(var labels=this.getLabels(),i=(this._childlessStatusLabel,0);i<labels.length;i++)labels[i].stop().animate({y:labels[i].oy},200,">")},getLabels:function(){var labels=editor.getPaper().set();this.getSBLabel()&&labels.push(this.getSBLabel()),this._anonimized?(this.getNameLabel()&&this.getNameLabel().hide(),this.getAgeLabel()&&this.getAgeLabel().hide()):(this.getNameLabel()&&(this.getNameLabel().show(),labels.push(this.getNameLabel())),this.getAgeLabel()&&(this.getAgeLabel().show(),labels.push(this.getAgeLabel()))),this.getExternalIDLabel()&&labels.push(this.getExternalIDLabel()),this.getCommentsLabel()&&labels.push(this.getCommentsLabel());var cancerLabels=this.getCancerAgeOfOnsetLabels();if(!Helpers.isObjectEmpty(cancerLabels))for(var cancerName in cancerLabels)labels.push(cancerLabels[cancerName]);return labels},setAnonimizedStatus:function($super,status){$super(status),this.drawLabels()},drawLabels:function(){var labels=this.getLabels(),selectionOffset=this._labelSelectionOffset(),childlessOffset=this.getChildlessStatusLabel()?PedigreeEditorParameters.attributes.label["font-size"]:0;childlessOffset+=null!==this.getNode().getChildlessStatus()?PedigreeEditorParameters.attributes.infertileMarkerHeight+2:0;for(var lowerBound=PedigreeEditorParameters.attributes.radius*(this.getNode().isPersonGroup()?PedigreeEditorParameters.attributes.groupNodesScale:1),startY=this.getY()+1.8*lowerBound+selectionOffset+childlessOffset,i=0;i<labels.length;i++){var shift=labels[i].addGap&&0!=i?4:8,offset=labels[i].alignTop?GraphicHelpers.getElementHalfHeight(labels[i])-shift:0;labels[i].transform(""),labels[i].attr("x",this.getX()),labels[i].attr("y",startY+offset),labels[i].oy=labels[i].attr("y")-selectionOffset,labels[i].toBack(),i!=labels.length-1&&(startY=labels[i].getBBox().y2+11)}},_labelSelectionOffset:function(){var selectionOffset=this.isSelected()?PedigreeEditorParameters.attributes.radius/1.4:0;return this.isSelected()&&this.getNode().isPersonGroup()&&(selectionOffset+=PedigreeEditorParameters.attributes.radius*(1-PedigreeEditorParameters.attributes.groupNodesScale)+5),this.getChildlessStatusLabel()&&(selectionOffset/=2),selectionOffset},getShapes:function($super){var lifeStatusShapes=editor.getPaper().set();return this.getUnbornShape()&&lifeStatusShapes.push(this.getUnbornShape()),this.getChildlessShape()&&lifeStatusShapes.push(this.getChildlessShape()),this.getChildlessStatusLabel()&&lifeStatusShapes.push(this.getChildlessStatusLabel()),this.getDeadShape()&&lifeStatusShapes.push(this.getDeadShape()),$super().concat(editor.getPaper().set(this.getDisorderShapes(),lifeStatusShapes))},getAllGraphics:function($super){return $super().push(this.getHoverBox().getBackElements(),this.getLabels(),this.getCarrierGraphics(),this.getEvaluationGraphics(),this.getHoverBox().getFrontElements())},setPos:function($super,x,y,animate,callback){var funct=callback;if(animate){var me=this;this.getHoverBox().disable(),funct=function(){me.getHoverBox().enable(),callback&&callback()}}$super(x,y,animate,funct)}});PersonVisuals.addMethods(ChildlessBehaviorVisuals);