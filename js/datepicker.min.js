/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var PedigreeFuzzyDatePickerDropdown=Class.create({initialize:function(options){this.span=new Element("span"),this.options=options,this.callback=null},populate:function(values){var selectedIndex=this.dropdown?this.dropdown.selectedIndex||this._tmpSelectedIndex:0,optionsHTML='<select name="'+this.options.name+'" class="'+(this.options.cssClass||this.options.name||"")+'" placeholder="'+(this.options.hint||this.options.name||"")+'" title="'+(this.options.hint||this.options.name||"")+'">';optionsHTML+='<option value="" class="empty"></option>';values.each(function(item){optionsHTML+='<option value="'+item.value+'"',item.cssClass&&(optionsHTML+=' class="'+item.cssClass+'"'),optionsHTML+=">"+(item.text||item.value||"")+"</option>"}),optionsHTML+="</select>",this.span.innerHTML=optionsHTML,this.dropdown=this.span.firstChild,this.callback&&this.onSelect(this.callback),this.dropdown.selectedIndex<=0&&selectedIndex>=0&&selectedIndex<this.dropdown.options.length&&(this.dropdown.selectedIndex=selectedIndex)},enable:function(){return!this.options.alwaysEnabled&&(this.dropdown.enable(),this.dropdown.selectedIndex<=0&&this._tmpSelectedIndex<this.dropdown.options.length)&&(this.dropdown.selectedIndex=this._tmpSelectedIndex,this._tmpSelectedIndex>0)},disable:function(){this.options.alwaysEnabled||(this.dropdown.disable(),this._tmpSelectedIndex=this.dropdown.selectedIndex,this.dropdown.selectedIndex=0)},getElement:function(){return this.span},onSelect:function(callback){var _this=this;this.callback=callback;var events=["change"];browser.isGecko&&events.push("keyup"),events.each(function(eventName){_this.dropdown.observe(eventName,function(){callback(),"YMD"==this.inputFormat&&(_this._tmpSelectedIndex=_this.dropdown.selectedIndex)})})},onFocus:function(callback){var _this=this;this.dropdown.observe("focus",function(){callback(),-1==_this.dropdown.selectedIndex&&_this._tmpSelectedIndex<_this.dropdown.options.size()&&(_this.dropdown.selectedIndex=_this._tmpSelectedIndex)})},onBlur:function(callback){this.dropdown.observe("blur",callback)},getSelectedValue:function(){return this.dropdown.selectedIndex>=0?this.dropdown.options[this.dropdown.selectedIndex].value:""},getSelectedOption:function(){return this.dropdown.selectedIndex>=0?this.dropdown.options[this.dropdown.selectedIndex].innerHTML:""}}),PedigreeFuzzyDatePicker=Class.create({initialize:function(input,inputFormat){if(this.inputFormat=inputFormat||"YMD",input){if(this.__input=input,this.__input.hide(),this.container=new Element("div",{class:"fuzzy-date-picker"}),this.__input.insert({after:this.container}),"DMY"==this.inputFormat||"MY"==this.inputFormat){var hideDay="MY"==this.inputFormat;this.container.insert(this.createDayDropdown(hideDay)),this.container.insert(this.createMonthDropdown()),this.container.insert(this.createYearDropdown())}else this.container.insert(this.createYearDropdown()),this.container.insert(this.createMonthDropdown()),this.container.insert(this.createDayDropdown());this.container.observe("datepicker:date:changed",this.onProgrammaticUpdate.bind(this))}},onProgrammaticUpdate:function(){this.yearSelected(!0),this.monthSelected(!0),this.updateDate(!0)},createYearDropdown:function(){this.yearSelector=new PedigreeFuzzyDatePickerDropdown({name:"year",alwaysEnabled:"YMD"!=this.inputFormat});for(var values=[],y=(new Date).getYear()+1900;y>=1850;--y)values.push({value:y}),y%10==0&&values.push({value:y+"s",cssClass:"decade",text:y+"s"});return values.push({value:"1800s",cssClass:"decade"}),values.push({value:"1700s",cssClass:"decade"}),values.push({value:"1600s",cssClass:"decade"}),this.yearSelector.populate(values),this.yearSelector.onSelect(this.yearSelected.bind(this)),this.yearSelector.getElement()},yearSelected:function(doNotNotifyOnChange){this.yearSelector.getSelectedValue()>0?(this.monthSelector.enable(),this.monthSelected(doNotNotifyOnChange)):(this.monthSelector.disable(),this.daySelector.disable()),this.updateDate(doNotNotifyOnChange)},createMonthDropdown:function(){return this.monthSelector=new PedigreeFuzzyDatePickerDropdown({name:"month",alwaysEnabled:"YMD"!=this.inputFormat}),this.monthSelector.populate(this.getZeroPaddedValueRange(1,12)),this.monthSelector.disable(),this.monthSelector.onSelect(this.monthSelected.bind(this)),this.monthSelector.getElement()},monthSelected:function(doNotNotifyOnChange){this.monthSelector.getSelectedValue()>0?(this.daySelector.populate(this.getAvailableDays()),this.daySelector.enable()):"DMY"==this.inputFormat?this.daySelector.populate(this.getZeroPaddedValueRange(1,31)):this.daySelector.disable(),this.updateDate(doNotNotifyOnChange)},createDayDropdown:function(hide){return this.daySelector=new PedigreeFuzzyDatePickerDropdown({name:"day",alwaysEnabled:"YMD"!=this.inputFormat}),this.daySelector.populate(this.getZeroPaddedValueRange(1,31)),this.daySelector.disable(),this.daySelector.onSelect(this.updateDate.bind(this)),hide&&this.daySelector.getElement().hide(),this.daySelector.getElement()},getAvailableDays:function(){var year=1*this.yearSelector.getSelectedValue(),month=1*this.monthSelector.getSelectedValue(),lastDayOfMonth=0;return[1,3,5,7,8,10,12].indexOf(month)>=0?lastDayOfMonth=31:[4,6,9,11].indexOf(month)>=0?lastDayOfMonth=30:2==month&&(lastDayOfMonth=year%4!=0||year%100==0&&year%400!=0?28:29),this.getZeroPaddedValueRange(1,lastDayOfMonth)},getZeroPaddedValueRange:function(start,end){var values=[];if(start<=end)for(v=start;v<=end;++v)values.push({value:v,text:("0"+v).slice(-2)});else for(var v=end;v<=start;--v)values.push({value:v,text:("0"+v).slice(-2)});return values},updateDate:function(doNotFireEventOnChange){var dateObject={},y=this.yearSelector.getSelectedValue();if(y.match(/\d\d\d\ds$/)?dateObject.decade=y:""!=y&&(dateObject.year=y),y>0||"DMY"==this.inputFormat){var m=this.monthSelector.getSelectedValue();m>0&&(dateObject.month=this.monthSelector.getSelectedOption()),(m>0||"DMY"==this.inputFormat)&&this.daySelector.getSelectedValue()>0&&(dateObject.day=this.daySelector.getSelectedOption())}JSON.stringify(dateObject)!=this.__input.value&&(this.__input.value=JSON.stringify(dateObject),doNotFireEventOnChange||this.__input.fire("xwiki:date:changed"))}});