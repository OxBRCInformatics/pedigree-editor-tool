/*! pedigree-editor-tool - v1.3.0-SNAPSHOT - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

function unescapeRestData(data){var tempNode=document.createElement("div");return tempNode.innerHTML=data.replace(/&amp;/,"&"),tempNode.innerText||tempNode.text||tempNode.textContent}function getSelectorFromXML(responseXML,selectorName,attributeName,attributeValue){if(responseXML.querySelector)return responseXML.querySelector(selectorName+"["+attributeName+"='"+attributeValue+"']");var query=".//"+selectorName+"[@"+attributeName+"='"+attributeValue+"']";try{return responseXML.selectSingleNode(query)}catch(e){throw alert("your browser is unsupported"),window.stop&&window.stop(),"Unsupported browser"}}function getSubSelectorTextFromXML(responseXML,selectorName,attributeName,attributeValue,subselectorName){var selector=getSelectorFromXML(responseXML,selectorName,attributeName,attributeValue),value=selector.innerText||selector.text||selector.textContent;return value||(value=""),value}var TemplateSelector=Class.create({initialize:function(isStartupTemplateSelector){this._isStartupTemplateSelector=isStartupTemplateSelector,this.mainDiv=new Element("div",{class:"template-picture-container"}),this.mainDiv.update("Loading list of templates...");var closeShortcut=isStartupTemplateSelector?[]:["Esc"];this.dialog=new PhenoTips.widgets.ModalPopup(this.mainDiv,{close:{method:this.hide.bind(this),keys:closeShortcut}},{extraClassName:"pedigree-template-chooser",title:"Please select a pedigree template",displayCloseButton:!isStartupTemplateSelector,verticalPosition:"top"}),isStartupTemplateSelector&&this.show();var newURL=(new WebService).getPathToEditorFiles()+new XWiki.Document("WebHome").getRestURL("objects/PhenoTips.PedigreeClass/index.xml").substring(1);new Ajax.Request(newURL,{method:"GET",onSuccess:this._onTemplateListAvailable.bind(this)})},isStartupTemplateSelector:function(){return this._isStartupTemplateSelector},_onTemplateListAvailable:function(response){this.mainDiv.update();for(var objects=response.responseXML.documentElement.getElementsByTagName("objectSummary"),i=0;i<objects.length;++i){var pictureBox=new Element("div",{class:"picture-box"});pictureBox.update("Loading..."),this.mainDiv.insert(pictureBox);var href=getSelectorFromXML(objects[i],"link","rel","http://www.xwiki.org/rel/properties").getAttribute("href"),newURL="rest"+href.substring(href.indexOf("/",href.indexOf("//")+2)),templatePath=(new WebService).getPathToEditorFiles()+newURL;new Ajax.Request(templatePath,{method:"GET",onSuccess:this._onTemplateAvailable.bind(this,pictureBox)})}},_onTemplateAvailable:function(pictureBox,response){pictureBox.innerHTML=getSubSelectorTextFromXML(response.responseXML,"property","name","image","value").replace(/&amp;/,"&"),pictureBox.pedigreeData=getSubSelectorTextFromXML(response.responseXML,"property","name","data","value"),pictureBox.type="internal",pictureBox.description=getSubSelectorTextFromXML(response.responseXML,"property","name","description","value"),pictureBox.title=pictureBox.description,window.SVGSVGElement&&document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#Image","1.1")?pictureBox.update(getSubSelectorTextFromXML(response.responseXML,"property","name","image","value")):pictureBox.innerHTML="<table bgcolor='#FFFAFA'><tr><td><br>&nbsp;"+pictureBox.description+"&nbsp;<br><br></td></tr></table>",pictureBox.observe("click",this._onTemplateSelected.bindAsEventListener(this,pictureBox))},_onTemplateSelected:function(event,pictureBox){this.dialog.close(),"internal"==pictureBox.type?editor.getSaveLoadEngine().createGraphFromSerializedData(pictureBox.pedigreeData,!1,!0):"simpleJSON"==pictureBox.type&&editor.getSaveLoadEngine().createGraphFromImportData(pictureBox.pedigreeData,"simpleJSON",{},!1,!0)},show:function(){var availableHeight=document.viewport.getHeight()-80;this.mainDiv.setStyle({"max-height":availableHeight+"px","overflow-y":"auto"}),this.dialog.show()},hide:function(){this.dialog.closeDialog()}});