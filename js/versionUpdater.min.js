/*! pedigree-editor-tool - v1.3.1 - 2017-05-22
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

VersionUpdater=Class.create({initialize:function(){this.availableUpdates=[{comment:"group node comment representation",introduced:"May2014",func:"updateGroupNodeComments"},{comment:"adopted status",introduced:"Nov2014",func:"updateAdoptedStatus"},{comment:"id desanitation",introduced:"Mar2015",func:"updateId"}]},updateToCurrentVersion:function(pedigreeJSON){for(var i=0;i<this.availableUpdates.length;i++){var update=this.availableUpdates[i],updateResult=this[update.func](pedigreeJSON);null!==updateResult&&(console.log("[update #"+i+"] [updating to "+update.introduced+" version] - performing "+update.comment+" update"),pedigreeJSON=updateResult)}return pedigreeJSON},updateGroupNodeComments:function(pedigreeJSON){for(var change=!1,data=JSON.parse(pedigreeJSON),i=0;i<data.GG.length;i++){var node=data.GG[i];node.hasOwnProperty("prop")&&node.prop.hasOwnProperty("numPersons")&&!node.prop.hasOwnProperty("comments")&&node.prop.hasOwnProperty("fName")&&""!=node.prop.hasOwnProperty("fName")&&(node.prop.comments=node.prop.fName,delete node.prop.fName,change=!0)}return change?JSON.stringify(data):null},updateAdoptedStatus:function(pedigreeJSON){for(var change=!1,data=JSON.parse(pedigreeJSON),i=0;i<data.GG.length;i++){var node=data.GG[i];node.hasOwnProperty("prop")&&node.prop.hasOwnProperty("isAdopted")&&(node.prop.isAdopted&&(node.prop.adoptedStatus="adoptedIn"),delete node.prop.isAdopted,change=!0)}return change?JSON.stringify(data):null},updateId:function(pedigreeJSON){function desanitizeId(id){var temp=id.replace(/__/g," ");return temp=temp.replace(/_C_/g,":"),(temp=temp.replace(/_L_/g,"(")).replace(/_J_/g,")")}for(var change=!1,data=JSON.parse(pedigreeJSON),i=0;i<data.GG.length;i++){var node=data.GG[i];if(node.hasOwnProperty("prop")){if(node.prop.hasOwnProperty("disorders"))for(j=0;j<node.prop.disorders.length;j++)node.prop.disorders[j]=desanitizeId(node.prop.disorders[j]),change=!0;if(node.prop.hasOwnProperty("hpoTerms"))for(j=0;j<node.prop.hpoTerms.length;j++)node.prop.hpoTerms[j]=desanitizeId(node.prop.hpoTerms[j]),change=!0;if(node.prop.hasOwnProperty("candidateGenes"))for(var j=0;j<node.prop.candidateGenes.length;j++)node.prop.candidateGenes[j]=desanitizeId(node.prop.candidateGenes[j]),change=!0}}return change?JSON.stringify(data):null}});