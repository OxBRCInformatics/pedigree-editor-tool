/*! pedigree-editor-tool - v1.3.0 - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var Controller=Class.create({initialize:function(){document.observe("pedigree:update:topMenu",this.handleTopMenuUpdate),document.observe("pedigree:autolayout",this.handleAutoLayout),document.observe("pedigree:graph:clear",this.handleClearGraph),document.observe("pedigree:undo",this.handleUndo),document.observe("pedigree:redo",this.handleRedo),document.observe("pedigree:renumber",this.handleRenumber),document.observe("pedigree:historychange",this.handleUndoHistoryChange),document.observe("pedigree:node:remove",this.handleRemove),document.observe("pedigree:node:setproperty",this.handleSetProperty),document.observe("pedigree:node:modify",this.handleModification),document.observe("pedigree:person:drag:newparent",this.handlePersonDragToNewParent),document.observe("pedigree:person:drag:newpartner",this.handlePersonDragToNewPartner),document.observe("pedigree:person:drag:newsibling",this.handlePersonDragToNewSibling),document.observe("pedigree:person:newparent",this.handlePersonNewParents),document.observe("pedigree:person:newsibling",this.handlePersonNewSibling),document.observe("pedigree:person:newpartnerandchild",this.handlePersonNewPartnerAndChild),document.observe("pedigree:partnership:newchild",this.handleRelationshipNewChild)},handleUndo:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo)),editor.getUndoRedoManager().undo()},handleRedo:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo)),editor.getUndoRedoManager().redo()},handleRenumber:function(event){var check=event.memo.hasOwnProperty("check"),clear=!1,needRedraw=!1;do{var secondPass=!1;for(var nodeID in editor.getView().getNodeMap())if(editor.getView().getNodeMap().hasOwnProperty(nodeID)&&editor.getGraph().isPerson(nodeID)&&!editor.getGraph().isPlaceholder(nodeID)){var node=editor.getView().getNode(nodeID),currentPedNumber=node.getPedNumber();if(clear)pedNumber="";else{var generation=editor.getGraph().getGeneration(nodeID),order=editor.getGraph().getOrderWithinGeneration(nodeID),pedNumber=Helpers.romanize(generation)+"-"+order;if(check&&pedNumber!=currentPedNumber){clear=!0,secondPass=!0;break}}if(currentPedNumber!=pedNumber){needRedraw=!0,node.setPedNumber(pedNumber);var allProperties=node.getProperties();editor.getGraph().setProperties(nodeID,allProperties)}}}while(secondPass);var renumberButton=$("action-number");clear?(renumberButton.removeClassName("disabled-menu-item"),renumberButton.addClassName("menu-item")):(renumberButton.removeClassName("menu-item"),renumberButton.addClassName("disabled-menu-item")),!event.memo.noUndoRedo&&needRedraw&&(editor.getView().unmarkAll(),editor.getUndoRedoManager().addState(event))},handleUndoHistoryChange:function(){var redoButton=$("action-redo");editor.getUndoRedoManager().hasRedo()?(redoButton.removeClassName("disabled-menu-item"),redoButton.addClassName("menu-item")):(redoButton.removeClassName("menu-item"),redoButton.addClassName("disabled-menu-item"));var undoButton=$("action-undo");editor.getUndoRedoManager().hasUndo()?(undoButton.removeClassName("disabled-menu-item"),undoButton.addClassName("menu-item")):(undoButton.removeClassName("menu-item"),undoButton.addClassName("disabled-menu-item"))},handleAutoLayout:function(event){try{console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var changeSet=editor.getGraph().redrawAll();editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("Autolayout error: "+err)}},handleClearGraph:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var changeSet=editor.getGraph().clearAll();editor.getView().applyChanges(changeSet,!0),editor.getWorkspace().centerAroundNode(0,!1),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)},handleTopMenuUpdate:function(event){var familyId=event.memo.familyId,participantId=event.memo.participantId;editor.getWorkspace().setMenuText(participantId,familyId)},handleRemove:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var nodeID=event.memo.nodeID,disconnectedList=editor.getGraph().getDisconnectedSetIfNodeRemoved(nodeID),onlyChild=!1;if(editor.getGraph().isPerson(nodeID)&&editor.getGraph().isOnlyChild(nodeID)){var producingRelationship=editor.getGraph().getParentRelationship(nodeID);Helpers.arrayContains(disconnectedList,producingRelationship)||(onlyChild=!0)}for(i=0;i<disconnectedList.length;i++){var nodeIndex=disconnectedList[i],node=editor.getView().getNode(nodeIndex);if(node.isRegistered&&node.isRegistered()){var closeFunction=function(){this.dialog.show()};return void editor.getOkCancelDialogue().showCustomized("You can not delete registered participants or any hierarchy that contains a registered participant(s) .","Genomics England","Close",closeFunction,null,null,null,null,!0)}}var removeSelected=function(){try{if(onlyChild&&(Helpers.removeFirstOccurrenceByValue(disconnectedList,nodeID),editor.getGraph().setProperties(nodeID,{gender:"U",placeholder:!0}),!editor.getGraph().isChildless(producingRelationship))){var partnership=editor.getView().getNode(producingRelationship);partnership.setChildlessStatus("childless");var newProperties=partnership.getProperties();editor.getGraph().setProperties(producingRelationship,newProperties)}changeSet=editor.getGraph().removeNodes(disconnectedList);if(onlyChild){changeSet.removed.push(nodeID);var newNodeID=changeSet.changedIDSet.hasOwnProperty(nodeID)?changeSet.changedIDSet[nodeID]:nodeID;changeSet.new=[newNodeID]}editor.getView().applyChanges(changeSet,!0);var changeSet=editor.getGraph().improvePosition();editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("[DEBUG] Remove error: "+err)}};if(disconnectedList.length<=1||event.memo.hasOwnProperty("noUndoRedo"))return void removeSelected();editor.getView().unmarkAll();for(var i=0;i<disconnectedList.length;i++){var nextHighlight=disconnectedList[i];editor.getView().getNode(nextHighlight).getGraphics().markPermanently()}var unhighlightSelected=function(){for(var i=0;i<disconnectedList.length;i++){var nextHighlight=disconnectedList[i];editor.getView().getNode(nextHighlight).getGraphics().unmark()}};editor.getOkCancelDialogue().show("All highlighted nodes will be removed. Do you want to proceed?","Delete nodes?",removeSelected,unhighlightSelected)},handleSetProperty:function(event){var nodeID=event.memo.nodeID,properties=event.memo.properties,undoEvent={eventName:event.eventName,memo:{nodeID:nodeID,properties:Helpers.cloneObject(event.memo.properties)}},node=editor.getView().getNode(nodeID),twinUpdate=void 0,needUpdateAncestors=!1,needUpdateRelationship=!1,needUpdateAllRelationships=!1,needUpdateYPositions=!1,changedValue=!1;for(var propertySetFunction in properties)if(properties.hasOwnProperty(propertySetFunction)){propValue=properties[propertySetFunction];if(!Controller._validatePropertyValue(nodeID,propertySetFunction,propValue))continue;var propertyGetFunction=propertySetFunction.replace("set","get"),oldValue=node[propertyGetFunction]();if(oldValue==propValue)continue;if(oldValue&&"object"==typeof oldValue&&"object"==typeof propValue&&("setDeathDate"==propertySetFunction||"setBirthDate"==propertySetFunction))try{if(oldValue.decade==propValue.decade&&oldValue.year==propValue.year&&oldValue.month==propValue.month&&oldValue.day==propValue.day)continue}catch(err){}if("[object Array]"===Object.prototype.toString.call(oldValue)?oldValue=oldValue.slice(0):"object"==typeof oldValue&&(oldValue=Helpers.cloneObject(oldValue)),undoEvent.memo.properties[propertySetFunction]=oldValue,"setLifeStatus"==propertySetFunction&&(undoEvent.memo.properties.setDeathDate=node.getDeathDate(),undoEvent.memo.properties.setGestationAge=node.getGestationAge(),undoEvent.memo.properties.setBirthDate=node.getBirthDate(),undoEvent.memo.properties.setAdopted=node.getAdopted()),"setDeathDate"==propertySetFunction&&(undoEvent.memo.properties.setLifeStatus=node.getLifeStatus()),"setChildlessStatus"==propertySetFunction&&(undoEvent.memo.properties.setChildlessReason=node.getChildlessReason()),"setDisorders"==propertySetFunction&&(undoEvent.memo.properties.setCarrierStatus=node.getCarrierStatus()),"setCarrierStatus"==propertySetFunction&&(undoEvent.memo.properties.setDisorders=node.getDisorders().slice(0)),node[propertySetFunction](propValue),"setDisorders"==propertySetFunction){var newDisorders=node[propertyGetFunction]();if(JSON.stringify(oldValue)==JSON.stringify(newDisorders))continue}changedValue=!0,"setLastName"==propertySetFunction&&editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")&&"M"==node.getGender(nodeID)&&(Controller._propagateLastNameAtBirth(nodeID,propValue,oldValue),undoEvent=null),"setGender"==propertySetFunction&&(node.getMonozygotic()&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"U"==oldValue&&"M"==propValue&&""==node.getLastName()&&""!=node.getLastNameAtBirth()&&0==editor.getGraph().getAllChildren(nodeID).length&&(node.setLastName(node.getLastNameAtBirth()),node.setLastNameAtBirth(""),undoEvent=null)),"setBirthDate"==propertySetFunction&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"setAdopted"==propertySetFunction&&(needUpdateAncestors=!0,"adoptedIn"==propValue&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"adoptedIn"==oldValue&&(twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]="")),"setComments"!=propertySetFunction&&"setExternalID"!=propertySetFunction&&"setFirstName"!=propertySetFunction&&"setLastName"!=propertySetFunction||Helpers.numTextLines(oldValue)!=Helpers.numTextLines(propValue)&&(needUpdateYPositions=!0),"setBirthDate"!=propertySetFunction&&"setDeathDate"!=propertySetFunction||(needUpdateYPositions=!0),"setCancers"==propertySetFunction&&(needUpdateYPositions=!0),"setMonozygotic"==propertySetFunction&&(needUpdateRelationship=!0,twinUpdate||(twinUpdate={}),twinUpdate[propertySetFunction]=propValue),"setConsanguinity"!=propertySetFunction&&"setBrokenStatus"!=propertySetFunction||(needUpdateRelationship=!0),"setLostContact"==propertySetFunction&&(needUpdateAllRelationships=!0)}if(twinUpdate){var allTwins=editor.getGraph().getAllTwinsSortedByOrder(nodeID);for(var propertySetFunction in twinUpdate)if(twinUpdate.hasOwnProperty(propertySetFunction))for(var propValue=twinUpdate[propertySetFunction],i=0;i<allTwins.length;i++){var twin=allTwins[i];if(twin!=nodeID){var twinNode=editor.getView().getNode(twin);twinNode[propertySetFunction](propValue);var twinProperties=twinNode.getProperties();console.log("Setting twin properties: "+Helpers.stringifyObject(twinProperties)),editor.getGraph().setProperties(twin,twinProperties)}}}var allProperties=node.getProperties();if(editor.getGraph().setProperties(nodeID,allProperties),needUpdateAncestors){changeSet=editor.getGraph().updateAncestors();editor.getView().applyChanges(changeSet,!0)}if(needUpdateAllRelationships){changeSet={moved:editor.getGraph().getAllRelatedRelationships(nodeID)};editor.getView().applyChanges(changeSet,!0)}if(needUpdateRelationship){changeSet={moved:[editor.getGraph().isRelationship(nodeID)?nodeID:editor.getGraph().getParentRelationship(nodeID)]};editor.getView().applyChanges(changeSet,!0)}if(needUpdateYPositions){var changeSet=editor.getGraph().updateYPositioning();editor.getView().applyChanges(changeSet,!0)}editor.getNodeMenu().update(),!event.memo.noUndoRedo&&changedValue&&editor.getUndoRedoManager().addState(event,undoEvent)},handleModification:function(event){try{console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var nodeID=event.memo.nodeID,modifications=event.memo.modifications,node=editor.getView().getNode(nodeID);for(modificationType in modifications)if(modifications.hasOwnProperty(modificationType)){var modValue=modifications[modificationType];if("addTwin"==modificationType){for(var numNewTwins=modValue-1,i=0;i<numNewTwins;i++){var twinProperty={gender:node.getGender()};"adoptedIn"==node.getAdopted()&&(twinProperty.adoptedStatus=node.getAdopted());var changeSet=editor.getGraph().addTwin(nodeID,twinProperty);editor.getView().applyChanges(changeSet,!0)}node.assignProperties(editor.getGraph().getProperties(nodeID))}modificationType}event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("err: "+err)}},handlePersonDragToNewParent:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID,parentID=event.memo.parentID;if(editor.getGraph().isPerson(personID)&&editor.getGraph().isValidID(parentID)){if(editor.getGraph().isRelationship(parentID)&&editor.getGraph().isChildlessByChoice(parentID)){var partnership=editor.getView().getNode(parentID);partnership.setChildlessStatus(null);var newProperties=partnership.getProperties();editor.getGraph().setProperties(parentID,newProperties)}editor.getGraph().isChildless(parentID)&&editor.getController().handleSetProperty({memo:{nodeID:personID,properties:{setAdopted:"adoptedIn"},noUndoRedo:!0}});try{var changeSet=editor.getGraph().assignParent(parentID,personID);editor.getView().applyChanges(changeSet,!0),-1!=changeSet.moved.indexOf(personID)&&editor.getWorkspace().centerAroundNode(personID,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("err: "+err)}}},handlePersonNewParents:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID;if(editor.getGraph().isPerson(personID)){var changeSet=editor.getGraph().addNewParents(personID);return editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event),changeSet.new[0]}},handlePersonNewSibling:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID,childParams=event.memo.childParams?Helpers.cloneObject(event.memo.childParams):{},parentRelationship=(event.memo.twins&&event.memo.twins,event.memo.groupSize&&event.memo.groupSize,editor.getGraph().getParentRelationship(personID));if(null===parentRelationship&&(parentRelationship=editor.getController().handlePersonNewParents({memo:{personID:personID,noUndoRedo:!0}})),event.memo.twins){nextEvent={nodeID:personID,modifications:{addTwin:event.memo.twins},noUndoRedo:!0};editor.getController().handleModification({memo:nextEvent})}else{var nextEvent={partnershipID:parentRelationship,childParams:childParams,noUndoRedo:!0};event.memo.groupSize&&(nextEvent.groupSize=event.memo.groupSize),editor.getController().handleRelationshipNewChild({memo:nextEvent})}event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)},handlePersonDragToNewSibling:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var sibling1=event.memo.sibling1ID,sibling2=event.memo.sibling2ID,parentRelationship=editor.getGraph().getParentRelationship(sibling1);null==parentRelationship&&(parentRelationship=editor.getGraph().getParentRelationship(sibling2)),null===parentRelationship&&(parentRelationship=editor.getController().handlePersonNewParents({memo:{personID:sibling1,noUndoRedo:!0}})),editor.getGraph().getParentRelationship(sibling2)!=parentRelationship?editor.getController().handlePersonDragToNewParent({memo:{personID:sibling2,parentID:parentRelationship,noUndoRedo:!0}}):editor.getController().handlePersonDragToNewParent({memo:{personID:sibling1,parentID:parentRelationship,noUndoRedo:!0}}),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)},handlePersonNewPartnerAndChild:function(event){var timer=new Helpers.Timer;try{console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID;if(!editor.getGraph().isPerson(personID))return;var preferLeft=event.memo.preferLeft,childParams=event.memo.childParams?Helpers.cloneObject(event.memo.childParams):{},numTwins=event.memo.twins?event.memo.twins:1,numPersons=event.memo.groupSize?event.memo.groupSize:0;if(editor.getGraph().isChildless(personID)&&(childParams.adoptedStatus="adoptedIn"),numPersons>0&&(childParams.numPersons=numPersons),editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var lastName=null;"M"==editor.getGraph().getGender(personID)&&(lastName=editor.getGraph().getLastName(personID)),lastName&&""!=lastName&&(childParams.hasOwnProperty("gender")&&"M"==childParams.gender?childParams.lName=lastName:childParams.lNameAtB=lastName)}var changeSet=editor.getGraph().addNewRelationship(personID,childParams,preferLeft,numTwins);editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}catch(err){console.log("err: "+err)}timer.printSinceLast("=== Total new partner+child runtime: ")},handlePersonDragToNewPartner:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var personID=event.memo.personID,partnerID=event.memo.partnerID;if(editor.getGraph().isPerson(personID)&&editor.getGraph().isPerson(partnerID)){var childProperties={};(editor.getGraph().isChildless(personID)||editor.getGraph().isChildless(partnerID))&&(childProperties.adoptedStatus="adoptedIn");var node1=editor.getView().getNode(personID),node2=editor.getView().getNode(partnerID);if("U"==node1.getGender()&&"U"!=node2.getGender()){var gender1=editor.getGraph().getOppositeGender(partnerID);node1.setGender(gender1),editor.getGraph().setProperties(personID,node1.getProperties())}else if("U"!=node1.getGender()&&"U"==node2.getGender()){var gender2=editor.getGraph().getOppositeGender(personID);node2.setGender(gender2),editor.getGraph().setProperties(partnerID,node2.getProperties())}if(editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var lastName=null;"M"==node1.getGender()?lastName=editor.getGraph().getLastName(personID):"M"==node2.getGender()&&(lastName=editor.getGraph().getLastName(partnerID)),lastName&&""!=lastName&&(childProperties.lNameAtB=lastName)}var changeSet=editor.getGraph().assignPartner(personID,partnerID,childProperties);editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}},handleRelationshipNewChild:function(event){console.log("event: "+event.eventName+", memo: "+Helpers.stringifyObject(event.memo));var partnershipID=event.memo.partnershipID;if(editor.getGraph().isRelationship(partnershipID)){var numTwins=event.memo.twins?event.memo.twins:1,childParams=Helpers.cloneObject(event.memo.childParams);editor.getGraph().isInfertile(partnershipID)&&(childParams.adoptedStatus="adoptedIn");var numPersons=event.memo.groupSize?event.memo.groupSize:0;if(numPersons>0&&(childParams.numPersons=numPersons),editor.getPreferencesManager().getConfigurationOption("propagateFatherLastName")){var lastName=editor.getGraph().getRelationshipChildLastName(partnershipID);lastName&&("M"==childParams.gender?childParams.lName=lastName:childParams.lNameAtB=lastName)}var children=editor.getGraph().getRelationshipChildrenSortedByOrder(partnershipID);if(1==children.length&&editor.getGraph().isPlaceholder(children[0])){changeSet=editor.getGraph().convertPlaceholderTo(children[0],childParams);if(editor.getGraph().isChildlessByChoice(partnershipID)){var partnership=editor.getView().getNode(partnershipID);partnership.setChildlessStatus(null);var newProperties=partnership.getProperties();editor.getGraph().setProperties(partnershipID,newProperties)}}else var changeSet=editor.getGraph().addNewChild(partnershipID,childParams,numTwins);editor.getView().applyChanges(changeSet,!0),event.memo.noUndoRedo||editor.getUndoRedoManager().addState(event)}}});Controller._validatePropertyValue=function(nodeID,propertySetFunction,propValue){return"setGender"!=propertySetFunction||editor.getGraph().getPossibleGenders(nodeID)[propValue]},Controller._propagateLastNameAtBirth=function(parentID,parentLastName,changeIfEqualTo){for(var children=editor.getGraph().getAllChildren(parentID),i=0;i<children.length;i++){var childID=children[i],childNode=editor.getView().getNode(childID);if(childNode.getLastNameAtBirth()==changeIfEqualTo||""==childNode.getLastNameAtBirth()&&(""==childNode.getLastName()||"M"==childNode.getGender()&&childNode.getLastName()==changeIfEqualTo)){"M"==childNode.getGender()&&childNode.getLastNameAtBirth()!=changeIfEqualTo?childNode.setLastName(parentLastName):childNode.setLastNameAtBirth(parentLastName);var allProperties=childNode.getProperties();editor.getGraph().setProperties(childID,allProperties),"M"==childNode.getGender()&&Controller._propagateLastNameAtBirth(childID,parentLastName,changeIfEqualTo)}}};