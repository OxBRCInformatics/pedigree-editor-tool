/*! pedigree-editor-tool - v1.3.0 - 2017-05-19
* https://github.com/OxBRCInformatics/pedigree-editor-tool#readme
* Copyright (c) 2017  Licensed AGPL-3.0 */

var XWiki=function(XWiki){function init(){return new widgets.FullScreen}var widgets=XWiki.widgets=XWiki.widgets||{};return widgets.FullScreen=Class.create({margin:0,buttonSize:16,editFullScreenLabel:"GEL_$jsontool.serialize($services.localization.render('core.editors.fullscreen.editFullScreen'))_GEL",exitFullScreenLabel:"GEL_$jsontool.serialize($services.localization.render('core.editors.fullscreen.exitFullScreen'))_GEL",initialize:function(){if(this.buttons=$(document.body).down(".bottombuttons"),this.buttons||(this.buttons=new Element("div",{class:"bottombuttons"}).update(new Element("div",{class:"buttons"})),this.buttons._x_isCustom=!0,document.body.appendChild(this.buttons.hide())),this.buttonsPlaceholder=new Element("span"),this.toolbarPlaceholder=new Element("span"),this.createCloseButtons(),$$("textarea",".maximizable").each(function(element){this.addBehavior(element)}.bind(this)),document.observe("xwiki:dom:updated",function(event){event.memo.elements.each(function(element){element.select("textarea",".maximizable").each(function(element){this.addBehavior(element)}.bind(this))}.bind(this))}.bind(this)),$$(".xRichTextEditor").each(function(item){this.addBehavior(item)}.bind(this)),this.addWysiwygListeners(),this.maximizedReference=$(document.body).down("input[name='x-maximized']"),this.maximizedReference&&""!=this.maximizedReference.value){var matches=$$(this.maximizedReference.value);matches&&matches.length>0&&this.makeFullScreen(matches[0])}this.unloadHandler=this.cleanup.bind(this),Event.observe(window,"unload",this.unloadHandler)},addBehavior:function(item){this.isWysiwyg20Content(item)?this.addWysiwyg20ContentButton(item):this.isWysiwyg10Content(item)?this.addWysiwyg10ContentButton(item):this.isWikiContent(item)?this.addWikiContentButton(item):this.isWysiwyg20Field(item)?this.addWysiwyg20FieldButton(item):this.isWikiField(item)?this.addWikiFieldButton(item):this.isWysiwyg10Field(item)?this.addWysiwyg10FieldButton(item):this.addElementButton(item)},addWysiwygListeners:function(){document.observe("xwiki:wysiwyg:created",this.wysiwyg20Created.bindAsEventListener(this)),document.observe("xwiki:tinymce:created",this.wysiwyg10Created.bindAsEventListener(this))},wysiwyg10Created:function(event){var item=$(event.memo.instance);this.removeTextareaLink(item),this.addBehavior(item)},wysiwyg20Created:function(event){var item=$(event.memo.instance.getRichTextArea()).up(".xRichTextEditor");this.removeTextareaLink(item),this.addBehavior(item)},removeTextareaLink:function(item){for(;;){if(!item)return;if(item.previous(".fullScreenEditLinkContainer"))return void item.previous(".fullScreenEditLinkContainer").remove();item=item.up()}},isWikiContent:function(textarea){return"content"==textarea.name&&textarea.visible()},isWysiwyg10Content:function(textarea){return"content"==textarea.name&&(Prototype.Browser.IE?textarea.previous(".mceEditorContainer"):textarea.next(".mceEditorContainer"))},isWysiwyg20Content:function(item){return item.hasClassName("xRichTextEditor")&&item.up("div[id^=content_container]")},isWikiField:function(textarea){return textarea.visible()},isWysiwyg10Field:function(textarea){return!textarea.visible()&&"content"!=textarea.name&&(Prototype.Browser.IE?textarea.previous(".mceEditorContainer"):textarea.next(".mceEditorContainer"))},isWysiwyg20Field:function(item){return item.hasClassName("xRichTextEditor")&&!item.up("div[id^=content_container]")},addWikiContentButton:function(textarea){textarea._toolbar=$(document.body).down(".leftmenu2"),textarea._toolbar?textarea._toolbar.insert({top:this.createOpenButton(textarea)}):this.addWikiFieldButton(textarea)},addWysiwyg10ContentButton:function(item){var container=Prototype.Browser.IE?item.previous(".mceEditorContainer"):item.next(".mceEditorContainer");if(!container)return!1;var toolbar=container.down(".mceToolbar");if(!toolbar)return!1;var newToolbar=new Element("span",{class:"mce_editor_fullscreentoolbar"}),link=new Element("a",{class:"mceButtonNormal"});return newToolbar.insert(new Element("img",{class:"mceSeparatorLine",height:15,width:1,src:toolbar.down("img.mceSeparatorLine").src})),newToolbar.insert(link.insert(this.createOpenButton(container))),toolbar.insert(newToolbar),container._toolbar=toolbar,!0},addWysiwyg20ContentButton:function(item){var toolbar=item.down(".gwt-MenuBar");return toolbar?(toolbar.insert({top:this.createOpenButton(item)}),item._toolbar=toolbar,item._x_fullScreenLoader&&(item._x_fullScreenLoader.stop(),item._x_fullScreenLoader=!1),!0):(item._x_fullScreenLoader||(item._x_fullScreenLoader_iterations=0,item._x_fullScreenLoader=new PeriodicalExecuter(function(item){if(item._x_fullScreenLoader_iteration>100)return item._x_fullScreenLoader.stop(),void(item._x_fullScreenLoader=!1);item._x_fullScreenLoader_iteration++,this.addWysiwyg20ContentButton(item)}.bind(this,item),.2)),!1)},addElementButton:function(element){Element.insert(element,{before:this.createOpenLink(element)})},addWikiFieldButton:function(textarea){Element.insert(textarea,{before:this.createOpenLink(textarea)})},addWysiwyg10FieldButton:function(textarea){this.addWysiwyg10ContentButton(textarea)},addWysiwyg20FieldButton:function(textarea){this.addWysiwyg20ContentButton(textarea)},createOpenButton:function(targetElement){var fullScreenActivator=new Element("img",{class:"fullScreenEditButton",title:this.editFullScreenLabel,alt:this.editFullScreenLabel,src:"resources/icons/silk/arrow_out.png"});return fullScreenActivator.observe("click",this.makeFullScreen.bind(this,targetElement)),fullScreenActivator.observe("mousedown",this.preventDrag.bindAsEventListener(this)),targetElement._x_fullScreenActivator=fullScreenActivator,fullScreenActivator._x_maximizedElement=targetElement,fullScreenActivator},createOpenLink:function(targetElement){var fullScreenActivatorContainer=new Element("div",{class:"fullScreenEditLinkContainer"}),fullScreenActivator=new Element("a",{class:"fullScreenEditLink",title:this.editFullScreenLabel}).update(this.editFullScreenLabel+" &raquo;");return fullScreenActivator.observe("click",this.makeFullScreen.bind(this,targetElement)),fullScreenActivatorContainer.update(fullScreenActivator),targetElement._x_fullScreenActivator=fullScreenActivator,fullScreenActivator._x_maximizedElement=targetElement,fullScreenActivatorContainer},createCloseButtons:function(){this.closeButton=new Element("img",{class:"fullScreenCloseButton",title:this.exitFullScreenLabel,alt:this.exitFullScreenLabel,src:"resources/icons/silk/arrow_in.png"}),this.closeButton.observe("click",this.closeFullScreen.bind(this)),this.closeButton.observe("mousedown",this.preventDrag.bindAsEventListener(this)),this.closeButton.hide(),this.actionCloseButton=new Element("input",{type:"button",class:"button",value:this.exitFullScreenLabel}),this.actionCloseButtonWrapper=new Element("span",{class:"buttonwrapper"}),this.actionCloseButtonWrapper.update(this.actionCloseButton),this.actionCloseButton.observe("click",this.closeFullScreen.bind(this)),this.actionCloseButtonWrapper.hide(),this.buttons.down(".buttons").insert({top:this.actionCloseButtonWrapper})},makeFullScreen:function(targetElement){if(document.fire("xwiki:fullscreen:enter",{target:targetElement}),this.maximizedReference&&(targetElement.id?this.maximizedReference.value=targetElement.tagName+"[id='"+targetElement.id+"']":targetElement.name?this.maximizedReference.value=targetElement.tagName+"[name='"+targetElement.name+"']":targetElement.className&&(this.maximizedReference.value=targetElement.tagName+"."+targetElement.className)),this.maximized=targetElement,"function"==typeof targetElement.setSelectionRange)var selectionStart=targetElement.selectionStart,selectionEnd=targetElement.selectionEnd,scrollTop=targetElement.scrollTop;if(targetElement._originalStyle={width:targetElement.style.width,height:targetElement.style.height},targetElement.hasClassName("xRichTextEditor")){var iframe=targetElement.down(".gwt-RichTextArea");targetElement._richTextAreaOriginalStyle={width:iframe.style.width,height:iframe.style.height}}else if(targetElement.hasClassName("mceEditorContainer")){(iframe=targetElement.down(".mceEditorIframe"))._originalStyle={width:iframe.style.width,height:iframe.style.height};var tframe=targetElement.down(".mceEditorSource");tframe._originalStyle={width:tframe.style.width,height:tframe.style.height}}var wrapper=targetElement.up();wrapper.addClassName("fullScreenWrapper"),targetElement._toolbar&&(targetElement._toolbar.hasClassName("leftmenu2")&&wrapper.insert({top:targetElement._toolbar.replace(this.toolbarPlaceholder)}),targetElement._x_fullScreenActivator.replace(this.closeButton)),wrapper.insert(this.buttons.replace(this.buttonsPlaceholder).show());var parent=targetElement.up();for(targetElement._x_fullScreenActivator.hide();parent!=document.body;)parent._originalStyle={overflow:parent.style.overflow,position:parent.style.position,width:parent.style.width,height:parent.style.height,left:parent.style.left,right:parent.style.right,top:parent.style.top,bottom:parent.style.bottom,padding:parent.style.padding,margin:parent.style.margin},parent.setStyle({overflow:"visible",position:"absolute",width:"100%",height:"100%",left:0,top:0,right:0,bottom:0,padding:0,margin:0}),parent.siblings().each(function(item){item._originalDisplay=item.style.display,item.setStyle({display:"none"}),item._fullscreenHidden=!0}),parent=parent.up();document.body._originalStyle={overflow:parent.style.overflow,width:parent.style.width,height:parent.style.height};var root=$(document.body).up();root._originalStyle={overflow:root.style.overflow,width:root.style.width,height:root.style.height},$(document.body).setStyle({overflow:"hidden",width:"100%",height:"100%"}),root.setStyle({overflow:"hidden",width:"100%",height:"100%"}),this.resizeListener=this.resizeTextArea.bind(this,targetElement),Event.observe(window,"resize",this.resizeListener),this.closeButton.show(),this.actionCloseButtonWrapper.show(),this.resizeTextArea(targetElement),targetElement._toolbar&&targetElement._toolbar.viewportOffset(),"function"==typeof targetElement.setSelectionRange&&(targetElement.scrollTop=scrollTop,targetElement.selectionStart=selectionStart,targetElement.selectionEnd=selectionEnd),document.fire("xwiki:fullscreen:entered",{target:targetElement})},closeFullScreen:function(){var targetElement=this.maximized;if(document.fire("xwiki:fullscreen:exit",{target:targetElement}),"function"==typeof targetElement.setSelectionRange)var selectionStart=targetElement.selectionStart,selectionEnd=targetElement.selectionEnd,scrollTop=targetElement.scrollTop;if(this.closeButton.hide(),this.actionCloseButtonWrapper.hide(),Event.stopObserving(window,"resize",this.resizeListener),targetElement.up().removeClassName("fullScreenWrapper"),targetElement.hasClassName("xRichTextEditor"))(iframe=targetElement.down(".gwt-RichTextArea")).setStyle(targetElement._richTextAreaOriginalStyle);else if(targetElement.hasClassName("mceEditorContainer")){var iframe=targetElement.down(".mceEditorIframe");iframe.setStyle(iframe._originalStyle);var tframe=targetElement.down(".mceEditorSource");tframe.setStyle(tframe._originalStyle)}for(var parent=targetElement.up(),parents=[];parent!=document.body;)parents.push(parent),parent=parent.up();for(var i=parents.length;i--;)(parent=parents[i]).setStyle(parent._originalStyle),parent.siblings().each(function(item){item._fullscreenHidden&&(item.style.display=item._originalDisplay||"")});document.body.setStyle(document.body._originalStyle),$(document.body).up().setStyle($(document.body).up()._originalStyle),this.buttonsPlaceholder.replace(this.buttons),this.buttons._x_isCustom&&this.buttons.hide(),targetElement._toolbar&&(targetElement._toolbar.hasClassName("leftmenu2")&&this.toolbarPlaceholder.replace(targetElement._toolbar),this.closeButton.replace(targetElement._x_fullScreenActivator)),Prototype.Browser.IE?setTimeout(function(){targetElement._x_fullScreenActivator.show(),this.setStyle(this._originalStyle)}.bind(targetElement),500):(targetElement._x_fullScreenActivator.show(),targetElement.setStyle(targetElement._originalStyle)),delete this.maximized,this.maximizedReference&&(this.maximizedReference.value=""),"function"==typeof targetElement.setSelectionRange&&(targetElement.scrollTop=scrollTop,targetElement.selectionStart=selectionStart,targetElement.selectionEnd=selectionEnd),document.fire("xwiki:fullscreen:exited",{target:targetElement})},resizeTextArea:function(targetElement){if(this.maximized){var newHeight=document.viewport.getHeight(),newWidth=document.viewport.getWidth();newWidth<=0&&(newWidth=document.body.clientWidth,newHeight=document.body.clientHeight),newWidth-=this.margin,newHeight=newHeight-targetElement.positionedOffset().top-this.margin-this.buttons.getHeight(),targetElement.setStyle({width:newWidth+"px",height:newHeight+"px"}),targetElement.hasClassName("xRichTextEditor")?targetElement.down(".gwt-RichTextArea").setStyle({width:newWidth+"px",height:newHeight-targetElement.down(".xToolbar").getHeight()-targetElement.down(".gwt-MenuBar").getHeight()+"px"}):targetElement.hasClassName("mceEditorContainer")&&(targetElement.down(".mceEditorIframe").setStyle({width:newWidth+"px",height:newHeight-targetElement._toolbar.getHeight()+"px"}),targetElement.down(".mceEditorSource").setStyle({width:newWidth+"px",height:newHeight-targetElement._toolbar.getHeight()+"px"})),document.fire("xwiki:fullscreen:resized",{target:targetElement})}},preventDrag:function(event){event.stop()},cleanup:function(){Event.stopObserving(window,"unload",this.unloadHandler);try{this.actionCloseButtonWrapper.remove()}catch(ex){}}}),XWiki.domIsLoaded&&init()||document.observe("xwiki:dom:loaded",init),XWiki}(XWiki||{});